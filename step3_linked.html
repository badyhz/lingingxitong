
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Step 3 · 咨询师纠偏 · 80 道Big Five判断题</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1020;--card:#121833;--ink:#e7ecff;--muted:#98a1c0;--brand:#6c8cff;--line:#1c2447}
*{box-sizing:border-box}html,body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1430);color:var(--ink);font-family:'Noto Sans SC',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1150px;margin:22px auto 80px;padding:14px}
.h1{font-size:26px;font-weight:700;margin:6px 0 12px}
.card{background:linear-gradient(180deg,#121833,#0f1733);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:12px}
.btn{padding:8px 14px;border-radius:8px;background:#6c8cff;color:#fff;margin-right:6px;text-decoration:none;border:1px solid #7a95ff;cursor:pointer}
.pill{padding:4px 10px;border:1px solid #2a3b7a;border-radius:12px;font-size:12px;color:#c9d4ff}
.q{padding:10px;border:1px dashed #2a3b7a;border-radius:12px;background:#0c1433;margin:8px 0}
.badge{display:inline-block;padding:2px 6px;border-radius:8px;border:1px solid #2a3b7a;font-size:11px;margin-left:6px;color:#a7b4ff}
.row{display:flex;gap:16px;flex-wrap:wrap}
.col{flex:1 1 360px;min-width:320px}
.tf{display:inline-flex;gap:8px;border:1px solid #2a3b7a;border-radius:10px;overflow:hidden}
.tf button{border:0;background:#0b1230;color:#cfe0ff;padding:6px 10px;cursor:pointer}
.tf button.on{background:#6c8cff;color:#fff}
.bar{position:relative;height:10px;width:100%;background:#0b1230;border:1px solid #2a3b7a;border-radius:999px;overflow:hidden;margin:6px 0 10px 0}
.bar>i{display:block;height:100%;background:linear-gradient(90deg,#6c8cff,#9aaeff)}
.bar .val{position:absolute;right:6px;top:-18px;font-size:11px;color:#b9c4ff}
.small{font-size:12px;color:#9fb1ff}

/* Big Five 预览样式 */
.bf-preview {
  background: linear-gradient(135deg, #0f1733, #121833);
  border: 1px solid #2a3b7a;
  border-radius: 12px;
  padding: 16px;
  margin-top: 16px;
}
.bf-preview h3 {
  margin: 0 0 12px 0;
  color: #e7ecff;
  font-size: 16px;
}
.bf-bar {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  gap: 12px;
}
.bf-label {
  min-width: 80px;
  font-size: 12px;
  color: #c9d4ff;
}
.bf-fill-container {
  flex: 1;
  height: 8px;
  background: #0b1230;
  border: 1px solid #2a3b7a;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.bf-fill {
  height: 100%;
  background: linear-gradient(90deg, #6c8cff, #9aaeff);
  transition: width 0.3s ease;
}
.bf-num {
  min-width: 30px;
  text-align: right;
  font-size: 12px;
  color: #e7ecff;
  font-weight: 600;
}
</style>
  <script src="./storage.js"></script>
  <script src="./bf_mappings.js"></script>
  <script>
/* === 命名空间工具：提前定义，避免 TDZ === */
function getNamespacedKey(baseKey){
  const NS = (window.PSYS && PSYS.NS) || 'psys:v1';
  const meta = JSON.parse(sessionStorage.getItem(`${NS}:currentSession`) || 'null');
  return meta ? `${baseKey}:${meta.teamId}:${meta.userId}:${meta.runId}` : baseKey;
}
function getNS(k, fallback=null){
  try {
    const raw = localStorage.getItem(getNamespacedKey(k));
    return raw ? JSON.parse(raw) : fallback;
  } catch { return fallback; }
}
function setNS(k, v){
  localStorage.setItem(getNamespacedKey(k), JSON.stringify(v));
}
/* 保留一个字符串常量（有些地方要读这个） */
const NS_STR = (window.PSYS && PSYS.NS) || 'psys:v1';
</script>
</head>
<body>
<div class="wrap">
  <div class="h1">Step 3 · 咨询师纠偏 · 80 道Big Five判断题</div>
  <div class="card small">
    <div><b>定位：</b>Step1 为"自评"；Step2/Step3 为"咨询师询问并评价"。本页 80 道判断题用于对 Step1 进行<b>校准/纠偏</b>，基于Big Five人格模型设计。</div>
    <div style="margin-top:6px"><b>评分：</b>5分制评分（5分=完全符合，4分=基本符合，3分=一般，2分=不太符合，1分=完全不符合）；每题映射到 Big Five 五个维度之一（每维 16 题，共 80 题）。保存后自动生成：</div>
    <ul>
      <li>step3_bf_env（Big Five环境画像，0–100）</li>
      <li>dashboard 中可对比：自评 vs 标签环境 vs 纠偏环境（本页）</li>
    </ul>
  </div>

  <div class="card">
    <div style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn" id="randomFillBtn" style="background:#ff6b6b;border-color:#ff7979">随机填写所有题目</button>
      <button class="btn action-save-step4">保存并前往 Step4</button>
      <button class="btn action-save-hub">保存并返回 Hub</button>
      <button class="btn action-save-step1">保存并前往 Step1</button>
      <button class="btn action-save-step2">保存并前往 Step2</button>
      <button class="btn action-save-dashboard">保存并前往 Dashboard</button>
      <span class="pill">操作：点击1-5分进行评分</span>
    </div>
    <div id="qBox"></div>
  </div>

  <div class="card">
    <b>实时统计（Big Five 维度）</b>
    <div class="bf-preview" id="bfPreview">
      <h3>Big Five 环境画像预览</h3>
      <div class="bf-bar">
        <div class="bf-label">开放性(O)</div>
        <div class="bf-fill-container"><div class="bf-fill" style="width: 50%"></div></div>
        <div class="bf-num">50</div>
      </div>
      <div class="bf-bar">
        <div class="bf-label">尽责性(C)</div>
        <div class="bf-fill-container"><div class="bf-fill" style="width: 50%"></div></div>
        <div class="bf-num">50</div>
      </div>
      <div class="bf-bar">
        <div class="bf-label">外向性(E)</div>
        <div class="bf-fill-container"><div class="bf-fill" style="width: 50%"></div></div>
        <div class="bf-num">50</div>
      </div>
      <div class="bf-bar">
        <div class="bf-label">宜人性(A)</div>
        <div class="bf-fill-container"><div class="bf-fill" style="width: 50%"></div></div>
        <div class="bf-num">50</div>
      </div>
      <div class="bf-bar">
        <div class="bf-label">神经质(N)</div>
        <div class="bf-fill-container"><div class="bf-fill" style="width: 50%"></div></div>
        <div class="bf-num">50</div>
      </div>
    </div>
  </div>

  <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
    <button class="btn action-save-step4">保存并前往 Step4</button>
    <button class="btn action-save-hub">保存并返回 Hub</button>
    <button class="btn action-save-step1">保存并前往 Step1</button>
    <button class="btn action-save-step2">保存并前往 Step2</button>
    <button class="btn action-save-dashboard">保存并前往 Dashboard</button>
  </div>
</div>

<script>
// Big Five 维度名称
const BF_DIMENSIONS = ["开放性(O)", "尽责性(C)", "外向性(E)", "宜人性(A)", "神经质(N)"];

// 80道Big Five纠偏题目库（每个维度16题）
const BF_QUESTION_BANK = {
  "开放性(O)": [
    "TA 对新的想法和概念表现出强烈的好奇心吗？",
    "TA 喜欢尝试不同的方法来解决问题吗？",
    "TA 经常思考抽象的哲学问题吗？",
    "TA 对艺术、音乐或文学有浓厚的兴趣吗？",
    "TA 愿意接受与自己观点不同的新观念吗？",
    "TA 在面对复杂问题时能想出创新的解决方案吗？",
    "TA 喜欢探索未知的领域和话题吗？",
    "TA 对不同文化和生活方式保持开放态度吗？",
    "TA 经常质疑传统的做事方式吗？",
    "TA 在学习新技能时表现出热情吗？",
    "TA 能够欣赏复杂和微妙的美学体验吗？",
    "TA 喜欢进行思辨性的讨论吗？",
    "TA 对科学发现和技术进步感兴趣吗？",
    "TA 愿意尝试新的食物、旅行目的地或体验吗？",
    "TA 能够理解和欣赏象征性或隐喻性的表达吗？",
    "TA 在面对变化时能够灵活调整自己的想法吗？"
  ],
  "尽责性(C)": [
    "TA 总是按时完成承诺的任务吗？",
    "TA 在工作中注重细节和准确性吗？",
    "TA 会提前规划并准备重要的事情吗？",
    "TA 能够长期坚持既定的目标吗？",
    "TA 在工作环境中保持整洁有序吗？",
    "TA 会认真履行自己的职责和义务吗？",
    "TA 在做决定前会仔细考虑后果吗？",
    "TA 能够抵制诱惑，专注于重要任务吗？",
    "TA 会为了长远目标而延迟即时满足吗？",
    "TA 在团队中被认为是可靠和值得信赖的吗？",
    "TA 会主动寻求提高工作效率的方法吗？",
    "TA 能够在压力下保持工作质量吗？",
    "TA 会定期检查和评估自己的进展吗？",
    "TA 对自己的工作标准要求很高吗？",
    "TA 会提前准备应对可能出现的问题吗？",
    "TA 能够持续保持良好的工作习惯吗？"
  ],
  "外向性(E)": [
    "TA 在社交场合中感到精力充沛吗？",
    "TA 喜欢成为关注的焦点吗？",
    "TA 主动与陌生人开始对话吗？",
    "TA 在团队活动中表现活跃吗？",
    "TA 喜欢参加聚会和社交活动吗？",
    "TA 能够轻松地在公众面前发言吗？",
    "TA 倾向于表达自己的想法和感受吗？",
    "TA 在群体中自然地承担领导角色吗？",
    "TA 喜欢与他人分享个人经历吗？",
    "TA 在社交互动中感到舒适自在吗？",
    "TA 主动寻求与他人的合作机会吗？",
    "TA 能够快速与新同事建立关系吗？",
    "TA 喜欢参与需要团队协作的项目吗？",
    "TA 在冲突中愿意直接表达自己的立场吗？",
    "TA 倾向于通过交流来处理问题吗？",
    "TA 在社交网络中保持活跃的联系吗？"
  ],
  "宜人性(A)": [
    "TA 总是考虑他人的感受和需要吗？",
    "TA 愿意帮助遇到困难的人吗？",
    "TA 在冲突中寻求双赢的解决方案吗？",
    "TA 对他人的成功感到由衷的高兴吗？",
    "TA 能够原谅他人的错误和过失吗？",
    "TA 在团队中促进和谐的氛围吗？",
    "TA 愿意为了集体利益而牺牲个人利益吗？",
    "TA 对他人表现出同情和理解吗？",
    "TA 避免说他人的坏话或传播谣言吗？",
    "TA 在与他人合作时表现出耐心吗？",
    "TA 主动关心他人的福祉和感受吗？",
    "TA 在处理分歧时保持尊重的态度吗？",
    "TA 愿意倾听并理解不同的观点吗？",
    "TA 在他人需要支持时提供帮助吗？",
    "TA 能够信任他人的善意和动机吗？",
    "TA 在人际关系中表现出慷慨和善良吗？"
  ],
  "神经质(N)": [
    "TA 经常感到焦虑和担忧吗？",
    "TA 在压力下容易情绪波动吗？",
    "TA 对批评和负面反馈过度敏感吗？",
    "TA 经常担心未来可能发生的问题吗？",
    "TA 在面对挫折时容易感到沮丧吗？",
    "TA 的情绪状态经常发生变化吗？",
    "TA 在不确定的情况下感到不安吗？",
    "TA 容易被小事情激怒或烦躁吗？",
    "TA 经常感到紧张或不安吗？",
    "TA 在社交场合中感到不自在吗？",
    "TA 对自己的能力缺乏信心吗？",
    "TA 经常反复思考负面的经历吗？",
    "TA 在做决定时表现出犹豫不决吗？",
    "TA 容易受到他人情绪的影响吗？",
    "TA 在面对变化时感到压力很大吗？",
    "TA 经常感到疲惫或精力不足吗？"
  ]
};

// 生成 80 题（每个维度16题）
const BF_ORDER = Object.keys(BF_QUESTION_BANK);
const ITEMS = [];
BF_ORDER.forEach((dimension, dimIndex) => {
  BF_QUESTION_BANK[dimension].forEach((text, qIndex) => {
    ITEMS.push({ 
      id: `BF${dimIndex+1}-${qIndex+1}`, 
      dimensionIndex: dimIndex, 
      dimensionName: dimension, 
      text 
    });
  });
});

// 渲染题目
const box = document.getElementById('qBox');
ITEMS.forEach((q, i) => {
  const el = document.createElement('div'); 
  el.className = 'q';
  el.innerHTML = `
    <div><b>${i+1}. [${q.dimensionName}]</b> ${q.text}</div>
    <div class="tf" id="tf_${q.id}" style="margin-top:8px">
      <button data-v="5">5分</button>
      <button data-v="4">4分</button>
      <button data-v="3" class="on">3分</button>
      <button data-v="2">2分</button>
      <button data-v="1">1分</button>
    </div>
  `;
  box.appendChild(el);
  
  const tf = el.querySelector('.tf');
  tf.onclick = (e) => {
    if(e.target.tagName !== 'BUTTON') return;
    tf.querySelectorAll('button').forEach(b => b.classList.remove('on'));
    e.target.classList.add('on');
    updateBFPreview();
  };
});

// 获取答案值
function getAnswerValue(id) {
  const tf = document.getElementById('tf_' + id);
  const btn = tf.querySelector('button.on');
  return Number(btn.getAttribute('data-v')); // 1-5分制
}

// 设置答案值
function setAnswerValue(id, val) {
  const tf = document.getElementById('tf_' + id);
  if(!tf) return;
  const buttons = tf.querySelectorAll('button');
  buttons.forEach(b => b.classList.remove('on'));
  
  let targetVal = Number(val);
  if(targetVal === 0) targetVal = 1; // 兼容旧数据
  if(targetVal > 5) targetVal = 5;
  if(targetVal < 1) targetVal = 1;
  
  const target = Array.from(buttons).find(b => Number(b.getAttribute('data-v')) === targetVal);
  const btn = target || buttons[2]; // 默认选择3分
  if(btn) btn.classList.add('on');
}

// 收集所有答案
function collectAnswers() {
  return ITEMS.map(q => getAnswerValue(q.id));
}

// 计算Big Five环境画像
function computeBigFiveFromAnswers() {
  const bf = [50, 50, 50, 50, 50]; // 基准值 [O, C, E, A, N]
  const counts = [0, 0, 0, 0, 0]; // 每个维度的题目数量
  
  ITEMS.forEach(item => {
    const score = getAnswerValue(item.id); // 1-5分
    const dimIndex = item.dimensionIndex;
    
    // 将1-5分转换为对Big Five的影响（-20到+20）
    const influence = (score - 3) * 10; // 3分为中性，1分=-20，5分=+20
    bf[dimIndex] += influence;
    counts[dimIndex]++;
  });
  
  // 确保每个维度都有16题
  for(let i = 0; i < 5; i++) {
    if(counts[i] !== 16) {
      console.warn(`维度 ${i} 题目数量不正确: ${counts[i]}`);
    }
  }
  
  // 限制在0-100范围内
  return bf.map(value => Math.max(0, Math.min(100, Math.round(value))));
}

// 更新Big Five预览
function updateBFPreview() {
  const bf = computeBigFiveFromAnswers();
  const bars = document.querySelectorAll('#bfPreview .bf-bar');
  
  bars.forEach((bar, index) => {
    const fill = bar.querySelector('.bf-fill');
    const num = bar.querySelector('.bf-num');
    const value = bf[index];
    
    fill.style.width = `${value}%`;
    num.textContent = value;
  });
}

// 保存Step3数据
function handleSaveStep3(next) {
  const answers = collectAnswers();
  const bf_env = computeBigFiveFromAnswers();
  
  // 从Big Five计算结构和生态
  let step3_struct = null;
  let step3_eco16 = null;
  
  if (window.bf_to_struct8 && typeof window.bf_to_struct8 === 'function') {
    step3_struct = window.bf_to_struct8(bf_env);
  } else if (window.BFMappings && window.BFMappings.bf_to_struct8) {
    step3_struct = window.BFMappings.bf_to_struct8(bf_env);
  }
  
  if (window.bf_to_eco16 && typeof window.bf_to_eco16 === 'function') {
    step3_eco16 = window.bf_to_eco16(bf_env);
  } else if (window.BFMappings && window.BFMappings.bf_to_eco16) {
    step3_eco16 = window.BFMappings.bf_to_eco16(bf_env);
  }
  
  // 计算 pot3_fix（8维纠偏后潜力）
  let pot3_fix;
  if (window.bf_to_pot8 && typeof window.bf_to_pot8 === 'function') {
    pot3_fix = window.bf_to_pot8(bf_env);
  } else {
    // 如果 bf_to_pot8 不可用，使用基于 Big Five 的简单映射
    const [O, C, E, A, N] = bf_env;
    pot3_fix = [
      Math.round(O * 0.8 + E * 0.2),           // 创新潜力
      Math.round(C * 0.7 + A * 0.3),           // 执行潜力
      Math.round(E * 0.9 + O * 0.1),           // 社交潜力
      Math.round(A * 0.8 + (100-N) * 0.2),     // 协作潜力
      Math.round((100-N) * 0.7 + C * 0.3),     // 稳定潜力
      Math.round(O * 0.6 + (100-N) * 0.4),     // 适应潜力
      Math.round(C * 0.5 + E * 0.3 + A * 0.2), // 领导潜力
      Math.round(O * 0.4 + E * 0.3 + C * 0.3)  // 学习潜力
    ];
  }
  
  // 保存到localStorage
  setNS('step3_bf_env', bf_env);
  setNS('pot3_fix', pot3_fix);
  if (step3_struct) setNS('step3_struct', step3_struct);
  if (step3_eco16) setNS('step3_eco16', step3_eco16);
  
  alert('Step3（咨询师纠偏）已保存：Big Five环境画像、纠偏潜力、结构和生态数据已生成。');
  
  try {
    if(window.PSYS) {
      const saveData = {
        answers,
        bf_env: bf_env,
        pot3_fix: pot3_fix,
        savedAt: new Date().toISOString()
      };
      if (step3_struct) saveData.struct = step3_struct;
      if (step3_eco16) saveData.eco16 = step3_eco16;
      
      PSYS.saveStep('step3', saveData);
    }
  } catch(err) { 
    console.warn('PSYS.saveStep step3 failed', err); 
  }
  
  if(next) location.href = next;
}

// 绑定保存按钮
document.querySelectorAll('.action-save-step4').forEach(btn => {
  btn.addEventListener('click', () => handleSaveStep3('step4_linked.html'));
});
document.querySelectorAll('.action-save-hub').forEach(btn => {
  btn.addEventListener('click', () => handleSaveStep3('hub.html'));
});
document.querySelectorAll('.action-save-step1').forEach(btn => {
  btn.addEventListener('click', () => handleSaveStep3('step1_linked.html'));
});
document.querySelectorAll('.action-save-step2').forEach(btn => {
  btn.addEventListener('click', () => handleSaveStep3('step2_linked.html'));
});
document.querySelectorAll('.action-save-dashboard').forEach(btn => {
  btn.addEventListener('click', () => handleSaveStep3('dashboard_linked.html'));
});

// 随机填写功能
document.getElementById('randomFillBtn').addEventListener('click', () => {
  ITEMS.forEach(item => {
    const randomScore = Math.floor(Math.random() * 5) + 1; // 1-5随机分数
    setAnswerValue(item.id, randomScore);
  });
  
  updateBFPreview();
  alert('已随机填写所有题目！');
});
</script>

<script>
(function(){
  const NS='psys:v1';
  
  function qs(k){
    const u=new URL(location.href);
    return u.searchParams.get(k);
  }
  function setMetaFromUrl(){
    const teamId=qs('teamId'), userId=qs('userId'), runId=qs('runId');
    if(teamId && userId && runId){
      sessionStorage.setItem(`${NS}:currentSession`, JSON.stringify({teamId,userId,runId}));
      return true;
    }
    return false;
  }
  function getMeta(){
    try{
      const raw=sessionStorage.getItem(`${NS}:currentSession`);
      return raw?JSON.parse(raw):null;
    }catch{ return null; }
  }
  setMetaFromUrl();
  const meta=getMeta();
  
  // 将 hydrateStep3 函数移到 IIFE 内部
  function hydrateStep3(meta) {
    if(!window.PSYS || !meta) {
      updateBFPreview();
      return;
    }
    
    try {
      const sess = PSYS.getSession(meta.teamId, meta.userId, meta.runId);
      const saved = sess?.step3;
      
      if(saved && Array.isArray(saved.answers)) {
        saved.answers.forEach((val, idx) => {
          const item = ITEMS[idx];
          if(item) setAnswerValue(item.id, val);
        });
        
        if(Array.isArray(saved.bf_env)) {
          setNS('step3_bf_env', saved.bf_env);
        }
      } else {
        localStorage.removeItem(getNamespacedKey('step3_bf_env'));
      }
    } catch(err) { 
      console.warn('hydrate step3 failed', err); 
    }
    
    updateBFPreview();
  }
  
  if(!meta){
    // 无会话时允许本地模式，不强制跳转
    console.warn('No current session; running in LOCAL mode');
    hydrateStep3(null); // 本地模式
    // 显示本地模式角标
    const div=document.createElement('div');
    div.style.cssText='position:fixed;top:8px;left:8px;background:#8b4513;border:1px solid #a0522d;color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;z-index:99999;opacity:.9';
    div.textContent='本地模式 · 未关联团队';
    document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(div));
  } else {
    hydrateStep3(meta);
    // mount a small corner badge
    const div=document.createElement('div');
    div.style.cssText='position:fixed;top:8px;left:8px;background:#0e1633;border:1px solid #1c2447;color:#e7ecff;padding:6px 10px;border-radius:10px;font-size:12px;z-index:99999;opacity:.9';
    div.textContent='团队/成员已关联 · 安全会话';
    document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(div));
  }

  // Provide manual hooks
  window.psysMarkStepCompleted = function(partName){
    if(!window.PSYS){ console.warn('PSYS not loaded'); return; }
    PSYS.saveStep(partName, {manual:true, savedAt: new Date().toISOString()});
  };
})();
</script>

</body>
</html>
