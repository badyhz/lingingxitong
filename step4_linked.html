<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Step4 - åŸºç¡€14ç»´åº¦ ç™¾åˆ†åˆ¶è¯„åˆ† + Big Fiveç¯å¢ƒç”»åƒ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§ </text></svg>">
<script src="bf_mappings.js"></script>
<script>

// === Step4 Global Bridges (must come before any calls) ===
// å…¨å±€å«ç‰‡ï¼šå…ˆæä¾›åŒåå…¨å±€å‡½æ•°ï¼Œå†…éƒ¨è½¬å‘åˆ° window.* æˆ–æœ¬åœ°å­˜å‚¨
window.saveMeta       = window.saveMeta       || function(o){ setNS('step4_meta', o); };
window.saveScores     = window.saveScores     || function(a){ setNS('step4_scores', a); };
window.saveBFEnv      = window.saveBFEnv      || function(b){ setNS('step4_bf_env', b); };
window.loadWeights    = window.loadWeights    || function(){ return getNS('step4_weights', null); };
window.saveWeights    = window.saveWeights    || function(o){ setNS('step4_weights', o); };
window.saveComposite  = window.saveComposite  || function(n){ setNS('step4_composite', n); };
window.saveEcoHint    = window.saveEcoHint    || function(o){ setNS('step4_eco_hint', o); };
window.renderWeightsAndComposite = window.renderWeightsAndComposite || function(){ /* no-op ç­‰å¾…çœŸæ­£å®ç°æŒ‚è½½ */ };

/* === å‘½åç©ºé—´å·¥å…·ï¼šæå‰å®šä¹‰ï¼Œé¿å… TDZ === */
function getNamespacedKey(baseKey){
  const NS = (window.PSYS && PSYS.NS) || 'psys:v1';
  const meta = JSON.parse(sessionStorage.getItem(`${NS}:currentSession`) || 'null');
  return meta ? `${baseKey}:${meta.teamId}:${meta.userId}:${meta.runId}` : baseKey;
}
function getNS(k, fallback=null){
  try {
    const raw = localStorage.getItem(getNamespacedKey(k));
    return raw ? JSON.parse(raw) : fallback;
  } catch { return fallback; }
}
function setNS(k, v){
  localStorage.setItem(getNamespacedKey(k), JSON.stringify(v));
}
/* ä¿ç•™ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ï¼ˆæœ‰äº›åœ°æ–¹è¦è¯»è¿™ä¸ªï¼‰ */
const NS_STR = (window.PSYS && PSYS.NS) || 'psys:v1';
</script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1020;--card:#121833;--ink:#e7ecff;--muted:#98a1c0;--line:#1c2447;--hl:#2a3b7a;--ok:#34d399;--warn:#f59b0a;--bad:#ff5c9a;--pri:#6c8cff}
*{box-sizing:border-box}html,body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1430);color:var(--ink);font-family:'Noto Sans SC',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1200px;margin:20px auto 80px;padding:14px}
.h1{font-size:24px;font-weight:700;margin:4px 0 10px}
.card{background:linear-gradient(180deg,#121833,#0f1733);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:1024px){.row{grid-template-columns:1fr}}
h3{margin:0 0 8px;font-size:16px}
h4{margin:8px 0 6px;font-size:13px;color:#cdd6ff}
.kv{display:grid;grid-template-columns:110px 1fr;gap:6px 10px;margin:6px 0;font-size:12px;color:#dbe3ff}
.small{font-size:12px;color:#a8b7ff}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #2a3b7a;border-radius:999px;background:#0c1433;color:#dbe3ff;font-size:12px;cursor:pointer;user-select:none}
.chip.active{border-color:#7a95ff;background:rgba(108,140,255,.12)}
.segment{display:inline-flex;border:1px solid #2a3b7a;border-radius:10px;overflow:hidden}
.segment button{background:#0c1433;color:#cfe0ff;border:0;padding:6px 10px;cursor:pointer;font-size:12px}
.segment button.active{background:#1a244f;color:#e7efff}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3b7a;border-radius:999px;padding:2px 8px;font-size:11px;color:#cfe0ff}
.badge .dot{width:6px;height:6px;border-radius:50%;background:#7a95ff}
.badge.ok{border-color:rgba(52,211,153,.6);color:#d8fff1}.badge.ok .dot{background:var(--ok)}
.badge.warn{border-color:rgba(245,158,11,.6);color:#ffe4b8}.badge.warn .dot{background:var(--warn)}
.badge.bad{border-color:rgba(255,92,154,.6);color:#ffd0e1}.badge.bad .dot{background:var(--bad)}
.hr{height:1px;background:#243163;margin:10px 0;border:0}
.btn{padding:8px 12px;border-radius:8px;background:var(--pri);border:1px solid #7a95ff;color:#fff;text-decoration:none;cursor:pointer}
.btn.ghost{background:#0c1433;color:#cfe0ff;border-color:#3a4a8f}
.flex{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.right{display:flex;gap:8px;align-items:center}
.score{font-size:12px;color:#cfe0ff}
.value{font-weight:700;color:#e7efff}
.tip{font-size:12px;color:#a8b7ff;margin-top:4px}
.table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:8px}
.table th,.table td{font-size:12px;color:#dbe3ff;text-align:left;padding:6px 8px;background:#0b1430;border:1px solid #283766}
.table th{background:#0f1b3d;color:#e7efff}
.note{font-size:12px;color:#9fb1ff}
.select{background:#0c1433;border:1px solid #2a3b7a;border-radius:8px;color:#e7efff;padding:6px 10px;font-size:12px}
.wtbl{width:100%;border-collapse:separate;border-spacing:0 6px}
.wtbl th,.wtbl td{font-size:12px;color:#dbe3ff;text-align:left;padding:6px 8px;background:#0b1430;border:1px solid #283766}
.wtbl th{background:#0f1b3d;color:#e7efff}
.big{font-size:28px;font-weight:800;letter-spacing:0.5px}

/* è¿›åº¦æŒ‡ç¤ºæ¡ */
.progress-bar {
  width: 100%;
  height: 6px;
  background: #1c2447;
  border-radius: 3px;
  margin: 12px 0;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #34d399, #6c8cff);
  border-radius: 3px;
  transition: width 0.3s ease;
}

/* ç»´åº¦ç±»å‹é¢œè‰²åŒºåˆ† */
.dimension-card.core {
  border-left: 4px solid #ff6b6b;
  background: linear-gradient(180deg, #1a1333, #151233);
}
.dimension-card.foundation {
  border-left: 4px solid #4ecdc4;
  background: linear-gradient(180deg, #131a33, #0f1733);
}

/* é‡è¦ä¿¡æ¯çªå‡ºæ˜¾ç¤º */
.highlight-box {
  background: linear-gradient(135deg, rgba(108,140,255,0.1), rgba(52,211,153,0.1));
  border: 1px solid rgba(108,140,255,0.3);
  border-radius: 8px;
  padding: 12px;
  margin: 8px 0;
}
.highlight-text {
  color: #7a95ff;
  font-weight: 600;
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}
.status-indicator.excellent {
  background: rgba(52,211,153,0.2);
  color: #34d399;
  border: 1px solid rgba(52,211,153,0.4);
}
.status-indicator.good {
  background: rgba(245,158,11,0.2);
  color: #f59b0a;
  border: 1px solid rgba(245,158,11,0.4);
}
.status-indicator.needs-improvement {
  background: rgba(255,92,154,0.2);
  color: #ff5c9a;
  border: 1px solid rgba(255,92,154,0.4);
}

/* ç™¾åˆ†åˆ¶æ»‘å—æ ·å¼ */
.score-slider-container {
  display: flex;
  align-items: center;
  gap: 15px;
  margin: 10px 0;
}

.score-slider {
  flex: 1;
  height: 8px;
  background: #1c2447;
  border-radius: 4px;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
  position: relative;
}

.score-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: linear-gradient(135deg, #6c8cff, #34d399);
  cursor: pointer;
  border: 2px solid #0c1433;
  box-shadow: 0 2px 8px rgba(108,140,255,0.4);
  transition: all 0.2s ease;
}

.score-slider::-webkit-slider-thumb:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(108,140,255,0.6);
}

.score-slider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: linear-gradient(135deg, #6c8cff, #34d399);
  cursor: pointer;
  border: 2px solid #0c1433;
  box-shadow: 0 2px 8px rgba(108,140,255,0.4);
  transition: all 0.2s ease;
}

.score-slider::-moz-range-thumb:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(108,140,255,0.6);
}

.score-slider::-webkit-slider-track {
  height: 8px;
  background: linear-gradient(to right, 
    #ff5c9a 0%, 
    #ff5c9a 30%, 
    #f59b0a 30%, 
    #f59b0a 60%, 
    #34d399 60%, 
    #34d399 80%, 
    #6c8cff 80%, 
    #6c8cff 100%);
  border-radius: 4px;
}

.score-slider::-moz-range-track {
  height: 8px;
  background: linear-gradient(to right, 
    #ff5c9a 0%, 
    #ff5c9a 30%, 
    #f59b0a 30%, 
    #f59b0a 60%, 
    #34d399 60%, 
    #34d399 80%, 
    #6c8cff 80%, 
    #6c8cff 100%);
  border-radius: 4px;
  border: none;
}

.score-display {
  min-width: 60px;
  text-align: center;
  font-weight: 600;
  color: #e7efff;
  font-size: 16px;
  background: #1c2447;
  border: 1px solid #3a4a6b;
  border-radius: 6px;
  padding: 8px 12px;
}

.score-labels {
  display: flex;
  justify-content: space-between;
  margin-top: 5px;
  font-size: 11px;
  color: #8fa3d3;
}

.score-labels span {
  flex: 1;
  text-align: center;
}

/* 10åˆ†åˆ¶è¯„åˆ†æŒ‰é’®æ ·å¼ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰ */
.score-segment {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.score-segment button {
  min-width: 32px;
  height: 32px;
  padding: 4px 8px;
  border: 1px solid #3a4a6b;
  background: #1c2447;
  color: #8fa3d3;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.score-segment button:hover {
  background: #2a3a5b;
  border-color: #6c8cff;
  color: #cfe0ff;
}

.score-segment button.active {
  background: linear-gradient(135deg, #6c8cff, #34d399);
  border-color: #6c8cff;
  color: white;
  box-shadow: 0 2px 8px rgba(108,140,255,0.3);
}

/* Big Five é¢„è§ˆæ ·å¼ */
.bf-preview-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 15px;
}

.bf-dimension {
  display: flex;
  align-items: center;
  gap: 15px;
}

.bf-label {
  width: 80px;
  font-weight: 600;
  color: #cfe0ff;
  font-size: 14px;
}

.bf-bar {
  flex: 1;
  height: 20px;
  background: #1c2447;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.bf-fill {
  height: 100%;
  background: linear-gradient(90deg, #6c8cff, #34d399);
  border-radius: 10px;
  transition: width 0.3s ease;
}

.bf-value {
  width: 40px;
  text-align: center;
  font-weight: 600;
  color: #e7efff;
  font-size: 14px;
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-in {
  animation: fadeIn 0.3s ease-in;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* å·¥å…·æç¤ºæ ·å¼ */
.tooltip {
  position: relative;
  cursor: help;
}
.tooltip:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #0f1b3d;
  color: #cfe0ff;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 11px;
  white-space: nowrap;
  z-index: 1000;
  border: 1px solid #2a3b7a;
}
</style>
  <script src="./storage.js"></script>
</head>
<body>
<div class="wrap">
    <div class="flex" style="justify-content:space-between">
      <div class="h1">Step4 Â· åŸºç¡€14ç»´åº¦ 10åˆ†åˆ¶è¯„åˆ† + Big Fiveç¯å¢ƒç”»åƒ</div>
      <div class="flex">
        <button class="btn" id="btnRandomFill" style="background:#ff6b6b;border-color:#ff7979">éšæœºå¡«å†™æ‰€æœ‰ç»´åº¦</button>
        <button class="btn" id="btnSaveHub">ä¿å­˜å¹¶è¿”å› Hub</button>
        <button class="btn" id="btnStep1">ä¿å­˜å¹¶å‰å¾€ Step1</button>
        <button class="btn" id="btnStep2">ä¿å­˜å¹¶å‰å¾€ Step2</button>
        <button class="btn" id="btnStep3">ä¿å­˜å¹¶å‰å¾€ Step3</button>
        <button class="btn" id="btnDashboard">ä¿å­˜å¹¶å‰å¾€ Dashboard</button>
        <button class="btn ghost" id="btnClear">æ¸…ç©ºé€‰æ‹©</button>
      </div>
    </div>
    
    <!-- è¿›åº¦æŒ‡ç¤ºæ¡ -->
    <div class="highlight-box">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span class="highlight-text">ğŸ“Š è¯„ä¼°è¿›åº¦</span>
        <span id="progressText" class="small">0/14 ç»´åº¦å·²è¯„ä¼°</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Big Five é¢„è§ˆé¢æ¿ -->
    <div class="highlight-box" style="margin: 20px 0;">
      <h3>ğŸ§  Big Five ç¯å¢ƒç”»åƒé¢„è§ˆ</h3>
      <div class="bf-preview-container">
        <div class="bf-dimension">
          <div class="bf-label">å¼€æ”¾æ€§ (O)</div>
          <div class="bf-bar">
            <div class="bf-fill" id="bf-fill-O"></div>
          </div>
          <div class="bf-value" id="bf-value-O">50</div>
        </div>
        <div class="bf-dimension">
          <div class="bf-label">å°½è´£æ€§ (C)</div>
          <div class="bf-bar">
            <div class="bf-fill" id="bf-fill-C"></div>
          </div>
          <div class="bf-value" id="bf-value-C">50</div>
        </div>
        <div class="bf-dimension">
          <div class="bf-label">å¤–å‘æ€§ (E)</div>
          <div class="bf-bar">
            <div class="bf-fill" id="bf-fill-E"></div>
          </div>
          <div class="bf-value" id="bf-value-E">50</div>
        </div>
        <div class="bf-dimension">
          <div class="bf-label">å®œäººæ€§ (A)</div>
          <div class="bf-bar">
            <div class="bf-fill" id="bf-fill-A"></div>
          </div>
          <div class="bf-value" id="bf-value-A">50</div>
        </div>
        <div class="bf-dimension">
          <div class="bf-label">ç¥ç»è´¨ (N)</div>
          <div class="bf-bar">
            <div class="bf-fill" id="bf-fill-N"></div>
          </div>
          <div class="bf-value" id="bf-value-N">50</div>
        </div>
      </div>
    </div>
  <div class="note">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
      <div>
        è¯´æ˜ï¼šæœ¬é¡µä¸æ”¹å˜é›·è¾¾ä¸æ’ç‰ˆï¼Œä»…ç”¨äºè¡¥å…… <b>æ€ç»´ / é€»è¾‘èƒ½åŠ› / ç†µå¢ / æ´å¯Ÿ</b> + <b>10ä¸ªæ›´åº•å±‚ç»´åº¦</b> çš„æ ‡ç­¾åˆ¤å®šä¸æç¤ºï¼›å¹¶è®¡ç®— <b>ç»¼åˆæŒ‡æ•°</b>ï¼ˆæƒé‡å¯ä¸€é”®åˆ‡æ¢é¢„è®¾ï¼‰ã€‚<br/>
        <b>é¢‘ç‡è¯´æ˜ï¼š</b>ä»ä¸=å¹´åº¦æˆ–æ›´å°‘ï¼ˆ30åˆ†ï¼‰ï¼›å¶å°”=æ¯æœˆ1-2æ¬¡ï¼ˆ60åˆ†ï¼‰ï¼›å¸¸æ€=æ¯å‘¨éƒ½æœ‰ï¼ˆ85åˆ†ï¼‰<br/>
        <b>æ–¹å‘è¯´æ˜ï¼š</b>åå°‘=éœ€è¦å¢å¼ºï¼ˆ-10åˆ†ï¼‰ï¼›é€‚ä¸­=åˆšå¥½åˆé€‚ï¼ˆ0åˆ†ï¼‰ï¼›åå¤š=å¯èƒ½è¿‡åº¦ï¼ˆ-5åˆ†ï¼‰<br/>
        æ ‡ç­¾åŠ åˆ†â‰¤+15ï¼›ç†µå¢ä½¿ç”¨"å™ªå£°âˆ’æŠ¤æ "çš„å‡€æ•ˆã€‚
      </div>
    </div>
    
    <!-- é¡¶éƒ¨ï¼šæƒé‡ä¸ç»¼åˆæŒ‡æ•° -->
  <div class="card">
    <div class="flex" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h3>ç»¼åˆæŒ‡æ•° & æƒé‡é¢„è®¾</h3>
        <div class="small">ç»¼åˆæŒ‡æ•° = åŠ æƒå¹³å‡ âˆ’ å…œåº•æƒ©ç½šï¼›å…œåº•ç»´åº¦ï¼šé€»è¾‘èƒ½åŠ›/æ´å¯Ÿèƒ½åŠ›/æ³¨æ„åŠ›æ§åˆ¶/å·¥ä½œå¸¦å®½/ç†µå¢ã€‚</div>
      </div>
      <div class="flex">
        <label class="small">æƒé‡é¢„è®¾ï¼š</label>
        <select id="presetSel" class="select">
          <option value="general">é€šç”¨ï¼ˆé»˜è®¤ï¼‰</option>
          <option value="startup">åˆ›ä¸š 0â†’1</option>
          <option value="scale">æ‰©å¼  1â†’10</option>
          <option value="research">ç ”å‘/äº§å“æ·±æ€</option>
          <option value="wellbeing">ç”Ÿæ´»æ¢å¤/éŸ§æ€§</option>
        </select>
        <button class="btn ghost" id="btnWeightsReset">é‡ç½®ä¸ºé¢„è®¾</button>
      </div>
    </div>

    <div class="hr"></div>
    <div class="flex" style="justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div class="flex" style="gap:16px;align-items:center">
        <div class="big" id="compVal">â€”</div>
        <span class="badge" id="compBand"><i class="dot"></i>â€”</span>
        <div class="small" id="penaltyText">å…œåº•æƒ©ç½šï¼šâ€”</div>
      </div>
      <div class="small">å½“å‰é¢„è®¾å°†ä¿å­˜åœ¨ <code>step4_weights</code>ï¼Œç»¼åˆæŒ‡æ•°å­˜ä¸º <code>step4_composite</code>ã€‚</div>
    </div>

    <table class="wtbl" id="wTable" style="margin-top:8px">
      <thead><tr><th style="width:34px">#</th><th>ç»´åº¦</th><th style="width:120px">æƒé‡ï¼ˆ%ï¼‰</th><th style="width:90px">åˆ†æ•°</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="2" style="text-align:right"><b>åˆè®¡</b></td><td id="wSum">100%</td><td id="weightedAvg">â€”</td></tr></tfoot>
    </table>
  </div>

  <!-- ç»´åº¦ç¼–è¾‘åŒº -->
  <div class="row" id="panel"></div>
</div>

<script>
/* ========= å‘é‡ä½“æ£€å‡½æ•° ========= */
function assertVec(name, v, len, min=0, max=100){
  if(!Array.isArray(v) || v.length!==len) throw new Error(`${name} é•¿åº¦åº”ä¸º ${len}ï¼Œå®é™… ${v&&v.length}`);
  for(let i=0;i<v.length;i++){
    const x = Number(v[i]);
    if(!isFinite(x)) throw new Error(`${name}[${i}] éæ•°å€¼: `+v[i]);
    if(x<min || x>max) throw new Error(`${name}[${i}] è¶Šç•Œ: ${x}ï¼ˆåº”åœ¨ ${min}~${max}ï¼‰`);
  }
}

/** ========= åŸºç¡€æ•°æ® ========= */
// Step4 14ç»´åˆ°ç»“æ„8ç»´çš„æ˜ å°„æƒé‡ï¼ˆæœ¬è´¨å£å¾„ï¼‰
const S4_TO_STRUCT8 = {
  'insight': {'insight':0.6,'logic':0.4},        // æ´å¯Ÿèƒ½åŠ› â†’ æ´å¯Ÿ+é€»è¾‘
  'grit': {'wm':0.6,'grit':0.4},                 // æ¯…åŠ› â†’ å·¥ä½œå¸¦å®½+æ¯…åŠ›
  'rhythm': {'rhythm':0.7,'learning':0.3},       // èŠ‚å¥ â†’ èŠ‚å¥+å­¦ä¹ 
  'focus': {'focus':0.7,'emotion':0.3},          // æ³¨æ„åŠ› â†’ ä¸“æ³¨+æƒ…ç»ª
  'logic': {'logic':0.3,'venture':0.7},          // é€»è¾‘ â†’ é€»è¾‘+å†’é™©
  'emotion': {'emotion':1.0},                    // æƒ…ç»ªç¨³å®š â†’ æƒ…ç»ª
  'bridge': {'bridge':1.0},                     // è¿æ¥ â†’ æ¡¥æ¢
  'venture': {'grit':1.0}                       // å†’é™© â†’ æ¯…åŠ›
};

// 14ç»´keyåˆ°ç»“æ„8ç»´ç´¢å¼•çš„æ˜ å°„ï¼ˆåŸºäºç”¨æˆ·æä¾›çš„æ˜ å°„é€»è¾‘ï¼‰
const STEP4_TO_STRUCT8_MAPPING = {
  'insight': [0, 1],      // æ´å¯Ÿèƒ½åŠ› â†’ insight(0) + logic(1)
  'logic': [1, 7],        // é€»è¾‘èƒ½åŠ› â†’ logic(1) + venture(7)  
  'thinking': [0, 1],     // æ€ç»´ â†’ insight(0) + logic(1)
  'entropy': [5, 6],      // ç†µå¢ â†’ rhythm(5) + learning(6)
  'focus': [2, 4],        // æ³¨æ„åŠ›æ§åˆ¶ â†’ focus(2) + emotion(4)
  'wm': [3, 2],          // å·¥ä½œå¸¦å®½ â†’ wm(3) + focus(2)
  'learn': [6, 5],       // å­¦ä¹ ä¸è¿ç§» â†’ learning(6) + rhythm(5)
  'affect': [4],         // æƒ…ç»ªè°ƒèŠ‚ â†’ emotion(4)
  'boundary': [4, 7],    // è¾¹ç•Œä¸ä¸»æƒ â†’ emotion(4) + venture(7)
  'uncertainty': [7, 6], // ä¸ç¡®å®šæ€§æ‰¿è½½ â†’ venture(7) + learning(6)
  'calibration': [1, 0], // ç°å®æ ¡å‡† â†’ logic(1) + insight(0)
  'habit': [5, 3],       // ä¹ æƒ¯ä¸è‡ªåŠ¨åŒ– â†’ rhythm(5) + wm(3)
  'social': [7, 4],      // å…³ç³»å¿ƒæ™º â†’ bridge(7) + emotion(4)
  'meaning': [4, 7]      // è‡ªæˆ‘å™äº‹ä¸æ„ä¹‰ â†’ emotion(4) + venture(7)
};

// 14ç»´åº¦åˆ°Big Fiveçš„æ˜ å°„æƒé‡
const DIMENSION_TO_BF_WEIGHTS = {
  // åŸºç¡€10ç»´åº¦
  focus: { O: 0.1, C: 0.7, E: 0.0, A: 0.0, N: -0.3 },        // ä¸“æ³¨åŠ› -> ä¸»è¦å½±å“å°½è´£æ€§
  wm: { O: 0.2, C: 0.6, E: 0.1, A: 0.0, N: -0.2 },           // å·¥ä½œè®°å¿† -> ä¸»è¦å½±å“å°½è´£æ€§
  learn: { O: 0.8, C: 0.2, E: 0.1, A: 0.0, N: 0.0 },         // å­¦ä¹ è¿ç§» -> ä¸»è¦å½±å“å¼€æ”¾æ€§
  affect: { O: 0.0, C: 0.2, E: 0.0, A: 0.3, N: -0.8 },       // æƒ…ç»ªè°ƒèŠ‚ -> ä¸»è¦å½±å“ç¥ç»è´¨(åå‘)
  boundary: { O: 0.1, C: 0.3, E: -0.2, A: -0.1, N: -0.4 },   // è¾¹ç•Œç®¡ç† -> é™ä½å¤–å‘æ€§å’Œç¥ç»è´¨
  uncertainty: { O: 0.6, C: 0.0, E: 0.2, A: 0.0, N: -0.5 },  // åº”å¯¹ä¸ç¡®å®š -> å¼€æ”¾æ€§å’Œé™ä½ç¥ç»è´¨
  calibration: { O: 0.3, C: 0.4, E: 0.0, A: 0.0, N: -0.3 },  // ç°å®æ„ŸçŸ¥ -> å¼€æ”¾æ€§å’Œå°½è´£æ€§
  habit: { O: 0.0, C: 0.8, E: 0.0, A: 0.0, N: -0.2 },        // ä¹ æƒ¯å…»æˆ -> ä¸»è¦å½±å“å°½è´£æ€§
  social: { O: 0.1, C: 0.0, E: 0.6, A: 0.7, N: -0.1 },       // äººé™…ç†è§£ -> å¤–å‘æ€§å’Œå®œäººæ€§
  meaning: { O: 0.5, C: 0.1, E: 0.0, A: 0.2, N: -0.3 },      // æ„ä¹‰æ„å»º -> ä¸»è¦å½±å“å¼€æ”¾æ€§
  
  // æ ¸å¿ƒ4ç»´åº¦
  thinking: { O: 0.7, C: 0.2, E: 0.0, A: 0.0, N: 0.0 },      // æ€ç»´æ–¹å¼ -> ä¸»è¦å½±å“å¼€æ”¾æ€§
  logic: { O: 0.4, C: 0.6, E: 0.0, A: 0.0, N: -0.1 },        // é€»è¾‘æ¨ç† -> å¼€æ”¾æ€§å’Œå°½è´£æ€§
  entropy: { O: 0.2, C: 0.7, E: 0.1, A: 0.1, N: -0.4 },      // æ··ä¹±ç®¡ç† -> ä¸»è¦å½±å“å°½è´£æ€§
  insight: { O: 0.8, C: 0.1, E: 0.1, A: 0.0, N: 0.0 }        // æ´å¯Ÿå‘ç° -> ä¸»è¦å½±å“å¼€æ”¾æ€§
};

/**
 * æ ¹æ®14ç»´åº¦è¯„åˆ†è®¡ç®—Big Fiveï¼ˆå¸¦æƒé‡å½’ä¸€åŒ–ï¼‰
 * @param {Object} scores - 14ç»´åº¦è¯„åˆ†å¯¹è±¡ {focus: 70, wm: 80, ...}
 * @returns {Array} Big Fiveæ•°ç»„ [O, C, E, A, N]
 */
function computeBigFiveFromDimensions(scores) {
  const bf = [50, 50, 50, 50, 50]; // åŸºå‡†å€¼
  
  // æƒé‡å½’ä¸€åŒ–å› å­ï¼ˆåŸºäºæƒé‡æ€»å’Œåˆ†æï¼‰
  const NORMALIZATION_FACTORS = {
    O: 1.02,  // å¼€æ”¾æ€§æƒé‡æ€»å’Œ: 4.8
    C: 1.00,  // å°½è´£æ€§æƒé‡æ€»å’Œ: 4.9 (æœ€å¤§ï¼Œä½œä¸ºåŸºå‡†)
    E: 3.50,  // å¤–å‘æ€§æƒé‡æ€»å’Œ: 1.4 (éœ€è¦å¤§å¹…å¢å¼º)
    A: 3.50,  // å®œäººæ€§æƒé‡æ€»å’Œ: 1.4 (éœ€è¦å¤§å¹…å¢å¼º)
    N: 1.36   // ç¥ç»è´¨æƒé‡æ€»å’Œ: 3.6
  };
  
  // éå†æ¯ä¸ªç»´åº¦çš„è¯„åˆ†
  Object.entries(scores).forEach(([dim, score]) => {
    if (DIMENSION_TO_BF_WEIGHTS[dim] && typeof score === 'number') {
      const weights = DIMENSION_TO_BF_WEIGHTS[dim];
      const normalizedScore = (score - 50) / 50; // å°†ç™¾åˆ†åˆ¶åˆ†æ•°è½¬æ¢ä¸º-1åˆ°1çš„èŒƒå›´
      
      // åº”ç”¨å½’ä¸€åŒ–æƒé‡åˆ°Big Fiveå„ç»´åº¦
      bf[0] += weights.O * NORMALIZATION_FACTORS.O * normalizedScore * 25; // O: å¼€æ”¾æ€§
      bf[1] += weights.C * NORMALIZATION_FACTORS.C * normalizedScore * 25; // C: å°½è´£æ€§  
      bf[2] += weights.E * NORMALIZATION_FACTORS.E * normalizedScore * 25; // E: å¤–å‘æ€§
      bf[3] += weights.A * NORMALIZATION_FACTORS.A * normalizedScore * 25; // A: å®œäººæ€§
      bf[4] += weights.N * NORMALIZATION_FACTORS.N * normalizedScore * 25; // N: ç¥ç»è´¨
    }
  });
  
  // ç¡®ä¿ç»“æœåœ¨0-100èŒƒå›´å†…
  return bf.map(v => Math.max(0, Math.min(100, Math.round(v))));
}

/**
 * æ›´æ–°Big Fiveé¢„è§ˆæ˜¾ç¤º
 * @param {Array} bf - Big Fiveæ•°ç»„ [O, C, E, A, N]
 */
function updateBFPreview(bf) {
  const labels = ['O', 'C', 'E', 'A', 'N'];
  
  labels.forEach((label, index) => {
    const value = bf[index];
    const fillElement = document.getElementById(`bf-fill-${label}`);
    const valueElement = document.getElementById(`bf-value-${label}`);
    
    if (fillElement && valueElement) {
      fillElement.style.width = `${value}%`;
      valueElement.textContent = value;
      
      // æ ¹æ®æ•°å€¼è°ƒæ•´é¢œè‰²
      if (value >= 70) {
        fillElement.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
      } else if (value >= 30) {
        fillElement.style.background = 'linear-gradient(90deg, #3498db, #2980b9)';
      } else {
        fillElement.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
      }
    }
  });
}

/**
 * ä»Step4çš„14ç»´åº¦è¯„åˆ†è®¡ç®—8ç»´æ ¸å¿ƒç»“æ„
 * @param {Object} scores - 14ç»´åº¦è¯„åˆ†å¯¹è±¡ {focus: 70, wm: 80, ...}
 * @returns {Array} 8ç»´æ ¸å¿ƒç»“æ„æ•°ç»„ [insight, logic, focus, wm, emotion, rhythm, learning, venture]
 */
function computeCoreStructFromStep4(scores) {
  // 8ç»´æ ¸å¿ƒç»“æ„åˆå§‹åŒ–ä¸º50åˆ†åŸºå‡†
  const coreStruct = [50, 50, 50, 50, 50, 50, 50, 50];
  
  // æ ¹æ®STEP4_TO_STRUCT8_MAPPINGæ˜ å°„è®¡ç®—
  Object.entries(STEP4_TO_STRUCT8_MAPPING).forEach(([step4Key, structIndices]) => {
    const step4Score = scores[step4Key];
    if (typeof step4Score === 'number') {
      const contribution = (step4Score - 50) / structIndices.length; // å¹³å‡åˆ†é…åˆ°å¯¹åº”çš„ç»“æ„ç»´åº¦
      
      structIndices.forEach(structIndex => {
        if (structIndex >= 0 && structIndex < 8) {
          coreStruct[structIndex] += contribution;
        }
      });
    }
  });
  
  // ç¡®ä¿ç»“æœåœ¨0-100èŒƒå›´å†…å¹¶å››èˆäº”å…¥
  return coreStruct.map(v => Math.max(0, Math.min(100, Math.round(v))));
}

const ECO16 = [
  "ä¿¡ä»»é€Ÿåº¦","åä½œè´¨é‡","å…³ç³»éŸ§æ€§","å½±å“åŠå¾„","ç›®æ ‡æ¨è¿›åŠ›","èŠ‚å¥ç®¡ç†",
  "åº”å˜æ•ˆç‡","è½åœ°é—­ç¯åº¦","æ´å¯Ÿæ•é”åº¦","è¡¨è¾¾æ¡ç†åº¦","ä¿¡æ¯æ•´åˆåº¦","æ”¹è¿›é©±åŠ¨åŠ›",
  "èƒ½é‡å¤–æ”¾","å†²çªé£æ ¼","ç¯å¢ƒè´´åˆåº¦","å¹¸ç¦æ„ŸåŸºç¡€"
];
const ECO_INDEX = {}; ECO16.forEach((n,i)=>ECO_INDEX[n]=i);

// 14 ç»´é¡ºåºï¼ˆç”¨äº step4_scoresï¼‰
const DIMENSIONS = [
  // 10 ä¸ªæ›´åº•å±‚ç»´åº¦
  { key:"focus", name:"ğŸ¯ ä¸“æ³¨åŠ›",
    desc:"åœ¨å¹²æ‰°ç¯å¢ƒä¸­ä¿æŒæ³¨æ„åŠ›ï¼Œå¿…è¦æ—¶åˆ‡æ¢ä»»åŠ¡çŠ¶æ€ã€‚",
    tags:[
      "ğŸ“± èƒ½åœ¨å¹²æ‰°ä¸‹ä¿æŒä¸“æ³¨",
      "ğŸ”• ä¸å®¹æ˜“è¢«æ‰‹æœº/æ¶ˆæ¯æ‰“æ–­", 
      "ğŸ”„ åˆ‡æ¢ä»»åŠ¡åèƒ½å¾ˆå¿«è¿›å…¥çŠ¶æ€",
      "â° ä¸“æ³¨æ—¶é—´èƒ½è¶…è¿‡30åˆ†é’Ÿ",
      "ğŸ‘¥ å¼€ä¼šæ—¶èƒ½å…¨ç¨‹è·Ÿä¸Š",
      "ğŸ˜´ åšæ— èŠä»»åŠ¡ä¹Ÿèƒ½åšæŒåˆ°ç»“æŸ"
    ]
  },
  { key:"wm", name:"ğŸ§  å·¥ä½œè®°å¿†",
    desc:"åŒæ—¶å¤„ç†å¤šä¸ªä¿¡æ¯å’Œä»»åŠ¡çš„å¿ƒæ™ºç¼“å­˜èƒ½åŠ›ã€‚",
    tags:[
      "ğŸ”€ åŒæ—¶å¤„ç†å¤šä»»åŠ¡ä¸å®¹æ˜“å´©æºƒ",
      "ğŸ“‹ ä»»åŠ¡å¤šæ—¶è¿˜èƒ½ä¿æŒæ¸…æ™°æ’åº",
      "âš ï¸ å·¥ä½œè¿‡é‡æ—¶ä¸ä¼šæ˜æ˜¾å‡ºé”™",
      "ğŸš« èƒ½æ¸…æ¥šæ‹’ç»æˆ–æ¨è¿Ÿé¢å¤–ä»»åŠ¡",
      "âœ… ä¸‹ç­å‰èƒ½å®Œæˆè®¡åˆ’å†…ä»»åŠ¡",
      "ğŸ’ª é•¿æœŸé«˜å‹ä¸‹è¿˜èƒ½ä¿æŒçŠ¶æ€"
    ]
  },
  { key:"learn", name:"ğŸ“š å­¦ä¹ è¿ç§»",
    desc:"ä»ç»éªŒä¸­å­¦ä¹ ï¼Œå¹¶å°†çŸ¥è¯†åº”ç”¨åˆ°æ–°æƒ…å†µä¸­ã€‚",
    tags:[
      "ğŸ”„ æ–°çŸ¥è¯†èƒ½å¾ˆå¿«åº”ç”¨åˆ°å®é™…å·¥ä½œ",
      "ğŸ’¡ é‡åˆ°æ–°é—®é¢˜èƒ½è”æƒ³åˆ°æ—§ç»éªŒ",
      "ğŸŒ å­¦åˆ°çš„æŠ€èƒ½èƒ½è·¨åœºæ™¯ä½¿ç”¨",
      "ğŸ” å–œæ¬¢æ¢ç´¢ä¸ç†Ÿæ‚‰çš„ä¸»é¢˜",
      "ğŸ§  å­¦è¿‡ä¸€æ¬¡çš„å†…å®¹è®°å¾—ç‰¢",
      "ğŸ’¬ æ€»ç»“åèƒ½ç”¨è‡ªå·±çš„è¯è®²å‡ºæ¥"
    ]
  },
  { key:"affect", name:"ğŸ˜Œ æƒ…ç»ªè°ƒèŠ‚",
    desc:"è§‰å¯Ÿå’Œç®¡ç†è‡ªå·±çš„æƒ…ç»ªçŠ¶æ€ï¼Œä¿æŒç¨³å®šè¡¨ç°ã€‚",
    tags:[
      "ğŸ« ç´§å¼ æ—¶èƒ½ç”¨å‘¼å¸æˆ–åŠ¨ä½œæ”¾æ¾è‡ªå·±",
      "ğŸ”¥ æƒ…ç»ªé«˜è¾¾ä¸ä¼šå¤±æ§å‘ç«",
      "ğŸ’¬ é¢å¯¹æ‰¹è¯„èƒ½å†·é™å›åº”",
      "â±ï¸ ç”Ÿæ°”åèƒ½åœ¨ä¸€å°æ—¶å†…æ¢å¤",
      "ğŸ èƒ½æ§åˆ¶é¥®é£Ÿä¸ä½œæ¯è§„å¾‹",
      "ğŸ¤— æ„Ÿåˆ°ç„¦è™‘æ—¶èƒ½æ‰¾åˆ°å®‰æŠšæ–¹å¼"
    ]
  },
  { key:"boundary", name:"ğŸ›¡ï¸ è¾¹ç•Œç®¡ç†",
    desc:"æ˜ç¡®ä¸ªäººè¾¹ç•Œï¼Œåœ¨å…³ç³»ä¸­ç»´æŠ¤è‡ªå·±çš„éœ€æ±‚ã€‚",
    tags:[
      "âŒ èƒ½æ¸…æ¥šè¯´ä¸è€Œä¸æ„§ç–š",
      "ğŸ¯ ä¸ä¼šè¢«ä»–äººè½»æ˜“å¹²æ‰°å†³ç­–",
      "ğŸš« é¢å¯¹ä¸åˆç†è¦æ±‚èƒ½æ‹’ç»",
      "ğŸ”’ ç»´æŠ¤éšç§æ—¶å¾ˆåšå®š",
      "ğŸ’ª åœ¨å…³ç³»é‡ŒåšæŒè‡ªå·±çš„åº•çº¿",
      "ğŸ™‹ ä¸ä¼šä¸ºäº†åˆç¾¤ç‰ºç‰²è‡ªæˆ‘éœ€æ±‚"
    ]
  },
  { key:"uncertainty", name:"ğŸŒŠ åº”å¯¹ä¸ç¡®å®š",
    desc:"åœ¨ä¿¡æ¯ä¸å®Œæ•´çš„æƒ…å†µä¸‹ä»èƒ½ç¨³å®šè¡ŒåŠ¨ã€‚",
    tags:[
      "ğŸ˜Œ é¢å¯¹æœªçŸ¥ä¸ä¼šè¿‡åº¦ç„¦è™‘",
      "ğŸ¯ åœ¨æ¨¡ç³Šç›®æ ‡ä¸‹è¿˜èƒ½è¡ŒåŠ¨",
      "ğŸ  æ–°ç¯å¢ƒä¸­ä¸ä¼šåƒµä½",
      "ğŸš€ æ„¿æ„å°è¯•æ²¡åšè¿‡çš„å·¥ä½œ",
      "âœ¨ æ¥å—æ²¡æœ‰å®Œç¾ç­”æ¡ˆ",
      "ğŸ”„ å‡ºç°æ„å¤–æ—¶èƒ½å¿«é€Ÿæ¢å¤å¿ƒæ€"
    ]
  },
  { key:"calibration", name:"ğŸ¯ ç°å®æ„ŸçŸ¥",
    desc:"å‡†ç¡®åˆ¤æ–­æƒ…å†µï¼ŒåŸºäºäº‹å®è€Œéæƒ…ç»ªåšå†³å®šã€‚",
    tags:[
      "ğŸ” èƒ½åˆ†è¾¨æƒ³æ³•ä¸ç°å®çš„å·®åˆ«",
      "âœ… åšå†³ç­–å‰ä¼šå…ˆéªŒè¯ä¿¡æ¯",
      "ğŸ§  ä¸è½»æ˜“è¢«æƒ…ç»ªå·¦å³åˆ¤æ–­",
      "ğŸ“° å¬åˆ°è´Ÿé¢æ¶ˆæ¯ä¼šå¤šæ–¹ç¡®è®¤",
      "ğŸ“ çŸ¥é“è‡ªå·±èƒ½åŠ›çš„è¾¹ç•Œ",
      "ğŸ”„ ä¼šæ ¹æ®åé¦ˆè°ƒæ•´è®¡åˆ’"
    ]
  },
  { key:"habit", name:"ğŸ”„ ä¹ æƒ¯å…»æˆ",
    desc:"å°†é‡è¦è¡Œä¸ºå˜æˆè‡ªåŠ¨åŒ–çš„æ—¥å¸¸ä¹ æƒ¯ã€‚",
    tags:[
      "ğŸŒ… æœ‰å›ºå®šçš„æ—©æ™šä¹ æƒ¯",
      "âš¡ åšäº‹ä¸éœ€è¦æ—¶æ—¶æé†’",
      "ğŸ¤– æ—¥å¸¸äº‹åŠ¡èƒ½è‡ªåŠ¨å®Œæˆ",
      "ğŸ“… æ—¶é—´ç®¡ç†å·¥å…·èƒ½åšæŒä½¿ç”¨",
      "ğŸƒ èƒ½ä¿æŒè§„å¾‹çš„è¿åŠ¨ä¸é¥®é£Ÿ",
      "ğŸ¯ ä¸ä¼šå› ä¸ºå°äº‹é¢‘ç¹ä¸­æ–­"
    ]
  },
  { key:"social", name:"ğŸ¤ äººé™…ç†è§£",
    desc:"ç†è§£ä»–äººæƒ³æ³•å’Œæ„Ÿå—ï¼Œåœ¨å›¢é˜Ÿä¸­æœ‰æ•ˆåä½œã€‚",
    tags:[
      "ğŸ‘ï¸ èƒ½ç«™åœ¨ä»–äººè§’åº¦ç†è§£æƒ³æ³•",
      "ğŸ’ å¯¹ä»–äººæƒ…ç»ªå¾ˆæ•æ„Ÿ",
      "ğŸ“ èƒ½è®°ä½å¯¹æ–¹çš„é‡è¦å°ç»†èŠ‚",
      "ğŸ‘‚ äº¤æµæ—¶èƒ½æ•æ‰æœªè¯´å‡ºå£çš„æ„æ€",
      "â¤ï¸ æ„¿æ„ä¸»åŠ¨ç…§é¡¾åˆ«äººæ„Ÿå—",
      "ğŸ¤” ä¸å®¹æ˜“é•¿æœŸè¯¯è§£ä»–äººåŠ¨æœº",
      "ğŸµ å›¢é˜Ÿé‡Œèƒ½å¸¦åŠ¨èŠ‚å¥ä¸åˆ†å·¥",
      "ğŸ¤ å‡ºç°å†²çªæ—¶èƒ½ä¸»åŠ¨é™çº§å¹¶ä¿®å¤"
    ]
  },
  { key:"meaning", name:"âœ¨ æ„ä¹‰æ„å»º",
    desc:"ä¸ºè‡ªå·±çš„ç»å†å’Œè¡ŒåŠ¨æ‰¾åˆ°æ„ä¹‰å’Œä»·å€¼ã€‚",
    tags:[
      "ğŸ­ èƒ½è®²æ¸…è‡ªå·±æ˜¯è°ã€é‡è§†ä»€ä¹ˆ",
      "ğŸ¯ ç»å¸¸æ€è€ƒäººç”Ÿç›®æ ‡",
      "ğŸ’ æœ‰ä¸€å¥—è‡ªå·±è®¤å¯çš„ä»·å€¼è§‚",
      "ğŸ“– ä¼šæŠŠç»å†æ€»ç»“æˆæ•…äº‹",
      "ğŸ’ª é¢å¯¹æŒ«æŠ˜èƒ½æ‰¾åˆ°æ„ä¹‰",
      "ğŸ‰ ä¼šæŠŠå°æˆåŠŸå½“ä½œåŠ¨åŠ›"
    ]
  },

  // å¿…å¤‡ 4 ç»´
  { key:"thinking", name:"ğŸ§© æ€ç»´æ–¹å¼",
    desc:"ç”¨ä¸åŒè§’åº¦å’Œæ–¹æ³•æ¥åˆ†æå’Œè§£å†³é—®é¢˜ã€‚",
    tags:[
      "ğŸ’­ èƒ½è·³å‡ºæƒ¯æ€§æ€è·¯çœ‹é—®é¢˜",
      "ğŸ”€ èƒ½æå‡ºå¤šä¸ªä¸åŒçš„è§£å†³æ–¹æ¡ˆ",
      "â“ å–œæ¬¢è¿½é—®äº‹æƒ…èƒŒåçš„ä¸ºä»€ä¹ˆ",
      "ğŸ“Š é‡åˆ°é—®é¢˜èƒ½å¿«é€Ÿåˆ†ç±»æ•´ç†",
      "ğŸ” å–„äºå‘ç°æ¨¡å¼ä¸ç›¸ä¼¼ç‚¹",
      "âš–ï¸ èƒ½åœ¨æŠ½è±¡ä¸ç»†èŠ‚ä¹‹é—´åˆ‡æ¢"
    ]
  },
  { key:"logic", name:"ğŸ”— é€»è¾‘æ¨ç†",
    desc:"ç”¨æ¸…æ™°çš„é€»è¾‘æ¥åˆ†æé—®é¢˜å’Œåšå†³å®šã€‚",
    tags:[
      "ğŸ“ èƒ½æ¸…æ¥šè§£é‡Šè‡ªå·±çš„æ¨ç†è¿‡ç¨‹",
      "ğŸ” èƒ½æŒ‡å‡ºä»–äººè®ºç‚¹çš„æ¼æ´",
      "âš–ï¸ åšå†³å®šå‰ä¼šæƒè¡¡åˆ©å¼Š",
      "ğŸ›¡ï¸ ä¸å®¹æ˜“è¢«ç‰‡é¢ä¿¡æ¯è¯¯å¯¼",
      "âœ… æ¨ç†è¿‡ç¨‹èƒ½è‡ªåœ†å…¶è¯´",
      "ğŸ§© èƒ½æŠŠå¤æ‚é—®é¢˜æ‹†æˆå°æ­¥éª¤",
      "ğŸ“Š ä¼šç»™ç»“è®ºé…ä¸Šè¯æ®ä¸è¾¹ç•Œæ¡ä»¶",
      "ğŸ“ˆ èƒ½ç”¨å›¾è¡¨æˆ–ç»“æ„åŒ–è¡¨è¾¾æ”¯æ’‘è§‚ç‚¹",
      "âš ï¸ èƒ½æ ‡æ³¨é£é™©ä¸ä¸ç¡®å®šæ€§"
    ]
  },
  { key:"entropy", name:"âš¡ æ··ä¹±ç®¡ç†",
    desc:"åœ¨æ··ä¹±ç¯å¢ƒä¸­ä¿æŒæ•ˆç‡ï¼Œå»ºç«‹æœ‰åºçš„å·¥ä½œæ–¹å¼ã€‚",
    tags:[
      "ğŸ”„ éœ€æ±‚é¢‘ç¹å˜æ›´","â“ æ¥å£äººä¸æ¸…","ğŸ“‹ ç›®æ ‡å¤šç‰ˆæœ¬","âš¡ ä¸´æ—¶æ’å•","ğŸ“… æ’æœŸæ¼‚ç§»","ğŸ“ ä¼šè®®è¿‡è½½","ğŸ¤ è·¨éƒ¨é—¨æ‹‰æ‰¯","ğŸ”„ è¿”å·¥>30%",
      "ğŸ“„ æ–‡æ¡£å¤±é…","âŒ ç¼ºéªŒæ”¶æ ‡å‡†","ğŸ› Bugæ¼æµ‹","âš”ï¸ ä¼˜å…ˆçº§æ‰“æ¶","ğŸ”„ ä¸´æ—¶æ”¹å‘","ğŸ“Š æ•°æ®å£å¾„å˜åŠ¨","ğŸ‘¥ è§’è‰²å†²çª","ğŸ˜¤ æƒ…ç»ªå¤–æº¢",
      "ğŸ“‹ï¼ˆæŠ¤æ ï¼‰æ ‡å‡†åŒ–æ¨¡æ¿","ğŸ‘¤ï¼ˆæŠ¤æ ï¼‰å•ä¸€è´Ÿè´£äºº","ğŸ”’ï¼ˆæŠ¤æ ï¼‰å†»ç»“çª—","âœ…ï¼ˆæŠ¤æ ï¼‰å˜æ›´è¯„å®¡",
      "ğŸš¦ï¼ˆæŠ¤æ ï¼‰WIPé™æµ","ğŸ‘ï¸ï¼ˆæŠ¤æ ï¼‰çœ‹æ¿é€æ˜","ğŸ¯ï¼ˆæŠ¤æ ï¼‰é‡Œç¨‹ç¢‘å‡†å…¥","ğŸ“ï¼ˆæŠ¤æ ï¼‰å¤ç›˜æ¨¡æ¿",
      "ğŸš¨ï¼ˆæŠ¤æ ï¼‰å¼‚å¸¸å‘Šè­¦","ğŸ“‹ï¼ˆæŠ¤æ ï¼‰SLAåè®®","ğŸ“‹ï¼ˆæŠ¤æ ï¼‰æ¥å£æ¸…å•","ğŸ”„ï¼ˆæŠ¤æ ï¼‰ç°åº¦/å›æ»šç‚¹"
    ]
  },
  { key:"insight", name:"ğŸ’¡ æ´å¯Ÿå‘ç°",
    desc:"æ•é”å‘ç°é—®é¢˜æœ¬è´¨å’Œç›¸å…³è¶‹åŠ¿ã€‚",
    tags:[
      "ğŸ” èƒ½æ•é”å‘ç°æ½œåœ¨é—®é¢˜",
      "ğŸ”® èƒ½é¢„è§è¶‹åŠ¿æˆ–ç»“æœ",
      "ğŸ¯ å¯¹ä»–äººè¯´è¯èƒ½æŠ“ä½é‡ç‚¹",
      "â“ å–„äºæå‡ºæ·±å±‚é—®é¢˜",
      "âš¡ é¢å¯¹å¤æ‚æƒ…å†µèƒ½è¿…é€ŸæŠ“ä½æ ¸å¿ƒ",
      "âœ¨ ç›´è§‰å¾€å¾€æ˜¯å¯¹çš„å¹¶å¯è¢«éªŒè¯",
      "ğŸ“Š ä¼šè®¾ç½®é¢†å…ˆæŒ‡æ ‡å¹¶è·Ÿè¸ªå¼‚å¸¸",
      "ğŸ”¬ èƒ½ç”¨å¯¹ç…§æ ·æœ¬æˆ–å½±å­æ•°æ®éªŒè¯æƒ³æ³•"
    ]
  }
];

// åˆ†å€¼å£å¾„ï¼ˆä¿æŒä¸å˜ï¼‰
const BASE_SCORE = { "ä»ä¸":30, "å¶å°”":60, "å¸¸æ€":85 };
const DIR_ADJ    = { "åå°‘":-10, "é€‚ä¸­":0,  "åå¤š":-5 };
const MAX_TAG_BONUS = 15; // æ ‡ç­¾æœ€å¤šåŠ  15 åˆ†

/** ========= æƒé‡é¢„è®¾ ========= */
const K = DIMENSIONS.reduce((m,d)=>{ m[d.key]=d; return m; }, {});
const PRESETS = {
  general: { name:"é€šç”¨",
    w:{ logic:0.12, insight:0.12, entropy:0.10, wm:0.10, focus:0.10,
        uncertainty:0.08, thinking:0.08, learn:0.07, habit:0.05,
        boundary:0.05, social:0.05, affect:0.04, calibration:0.02, meaning:0.02 } },
  startup: { name:"åˆ›ä¸š 0â†’1",
    w:{ insight:0.14, logic:0.12, uncertainty:0.12, learn:0.10, entropy:0.10,
        focus:0.08, wm:0.08, thinking:0.08, boundary:0.05, social:0.05,
        habit:0.04, affect:0.02, calibration:0.01, meaning:0.01 } },
  scale: { name:"æ‰©å¼  1â†’10",
    w:{ entropy:0.12, social:0.10, boundary:0.08, habit:0.08, wm:0.10,
        focus:0.08, logic:0.10, insight:0.10, thinking:0.06, learn:0.06,
        uncertainty:0.06, affect:0.04, calibration:0.01, meaning:0.01 } },
  research: { name:"ç ”å‘/äº§å“æ·±æ€",
    w:{ logic:0.14, insight:0.14, wm:0.12, focus:0.10, thinking:0.10,
        learn:0.08, entropy:0.08, uncertainty:0.06, calibration:0.06,
        habit:0.04, boundary:0.03, social:0.03, affect:0.01, meaning:0.01 } },
  wellbeing: { name:"ç”Ÿæ´»æ¢å¤/éŸ§æ€§",
    w:{ affect:0.14, meaning:0.10, habit:0.10, boundary:0.10, focus:0.10,
        entropy:0.08, social:0.08, insight:0.06, logic:0.05, wm:0.05,
        learn:0.05, thinking:0.04, uncertainty:0.03, calibration:0.02 } }
};

// è¯»å–/ä¿å­˜ï¼ˆä¿æŒä¸å˜ï¼‰
function loadMeta(){ 
  try{ 
    return getNS('step4_meta', {});
  } catch(e) { 
    return {}; 
  } 
}


// è®¡ç®—ç»´åº¦åˆ†ï¼ˆä¿æŒä¸å˜ï¼‰
function computeDimScore(metaItem, totalTags){
  const f = BASE_SCORE[metaItem.freq||'å¶å°”']||60;
  const d = DIR_ADJ[metaItem.dir||'é€‚ä¸­']||0;
  const sel = (metaItem.tags||[]).length;
  const bonus = totalTags>0 ? Math.min(MAX_TAG_BONUS, Math.round(MAX_TAG_BONUS * sel/totalTags)) : 0;
  let score = Math.max(0, Math.min(100, f + d + bonus));
  // ç†µå¢ç‰¹æ®Šï¼šæŠŠâ€œå™ªå£°æ ‡ç­¾â€å½“è´Ÿé¡¹ï¼Œâ€œæŠ¤æ æ ‡ç­¾â€å½“æ­£é¡¹
  if(metaItem.key==='entropy'){
    const noise  = (metaItem.tags||[]).filter(t=>!t.startsWith('ï¼ˆä½ç†µæŠ¤æ ï¼‰')).length;
    const guards = (metaItem.tags||[]).filter(t=>t.startsWith('ï¼ˆä½ç†µæŠ¤æ ï¼‰')).length;
    const raw = f + d + (guards - noise) * 2; // æ¯æ¡ Â±2 åˆ†
    score = Math.max(0, Math.min(100, raw));
  }
  return score;
}

// ç”Ÿæ€æç¤ºï¼ˆä¿æŒä¸å˜ï¼‰
function buildEcoHints(scores){
  const eco = new Array(16).fill(0);
  DIMENSIONS.forEach((dim, idx)=>{
    const s = scores[idx]??60;
    const k = (s - 60) / 40; // -1..+1ï¼ˆ60 ä¸ºä¸­çº¿ï¼‰
    Object.entries(dim.ecoLinks||{}).forEach(([name,w])=>{
      const i = ECO_INDEX[name]; if(i==null) return;
      eco[i] += k * w * 8; // æ¯ç»´åº¦æœ€é«˜Â±8 * æƒé‡
    });
  });
  const entIdx = DIMENSIONS.findIndex(d=>d.key==='entropy');
  if(entIdx>=0){
    const s = scores[entIdx]??60;
    const neg = Math.max(0, (60 - s)/40); // 0..1
    eco[ECO_INDEX["èŠ‚å¥ç®¡ç†"]]   -= neg * 4;
    eco[ECO_INDEX["è½åœ°é—­ç¯åº¦"]] -= neg * 4;
    eco[ECO_INDEX["åä½œè´¨é‡"]]   -= neg * 3;
  }
  const out = {};
  eco.forEach((v,i)=>{ if(Math.abs(v)>=0.5){ out[ECO16[i]] = Math.round(v*10)/10; } });
  return out;
}

// ç»¼åˆæŒ‡æ•° + å…œåº•æƒ©ç½šï¼ˆä¿æŒä¸å˜ï¼‰
function calcComposite(scores, weights){
  let sumW = 0; Object.values(weights).forEach(v=> sumW += (v||0));
  const W = {}; Object.entries(weights).forEach(([k,v])=> W[k] = (sumW>0)? v/sumW : 0);
  let avg = 0;
  DIMENSIONS.forEach((d,idx)=>{ const s = scores[idx]??60; const w = W[d.key]||0; avg += s * w; });
  const idxMap = {}; DIMENSIONS.forEach((d,i)=> idxMap[d.key]=i);
  const baseKeys = ['logic','insight','focus','wm','entropy'];
  const minBase = Math.min(...baseKeys.map(k=> scores[idxMap[k]]??60));
  const penalty = (minBase<60) ? Math.min(10, (60 - minBase)*0.25) : 0;
  const final = Math.round(avg - penalty);
  return {avg:Math.round(avg), penalty:Math.round(penalty*10)/10, final, minBase};
}

/** ========= æ¸²æŸ“ ========= */
function renderPanel(){
  const meta = loadMeta();
  const host = document.getElementById('panel');
  
  // è®¡ç®—å·²è¯„ä¼°ç»´åº¦æ•°é‡
  let evaluatedCount = 0;
  
  host.innerHTML = DIMENSIONS.map((dim, idx)=>{
    const m = meta[dim.key] || {score: 50, tags:[]};
    
    // æ£€æŸ¥æ˜¯å¦å·²è¯„ä¼°ï¼ˆè¯„åˆ†ä¸ä¸º50åˆ†æˆ–æœ‰æ ‡ç­¾é€‰æ‹©ï¼‰
    if (m.score !== 50 || (m.tags && m.tags.length > 0)) {
      evaluatedCount++;
    }
    
    const chips = dim.tags.map(tag=>{
      const on = (m.tags||[]).includes(tag) ? 'active' : '';
      return `<span class="chip ${on}" data-key="${dim.key}" data-tag="${tag}" title="ç‚¹å‡»é€‰æ‹©/å–æ¶ˆï¼ˆä»…ä½œå‚è€ƒï¼Œä¸å½±å“åˆ†å€¼ï¼‰">${tag}</span>`;
    }).join('');
    
    // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
    const customChips = (m.customTags||[]).map(tag=>{
      const on = (m.tags||[]).includes(tag) ? 'active' : '';
      return `<span class="chip ${on}" data-key="${dim.key}" data-tag="${tag}" data-custom="true" title="è‡ªå®šä¹‰æ ‡ç­¾ - ç‚¹å‡»é€‰æ‹©/å–æ¶ˆï¼ˆä»…ä½œå‚è€ƒï¼Œä¸å½±å“åˆ†å€¼ï¼‰">${tag} <span onclick="event.stopPropagation(); removeCustomTag('${dim.key}', '${tag}');" style="margin-left: 4px; cursor: pointer; color: #ff5c9a;">Ã—</span></span>`;
    }).join('');
    
    const allChips = chips + (customChips ? ' ' + customChips : '');
    
    const score = m.score || 50;
    const band = score>=80?'ok':(score<60?'bad':'warn');
    const bandText = score>=80?'å¼º':(score<60?'é£é™©':'å¯ç”¨');
    
    // ç™¾åˆ†åˆ¶æ»‘å—ï¼ˆ0-100ï¼Œæ¯1åˆ†ä¸€ä¸ªå•ä½ï¼‰
    const sliderHtml = `
      <div class="score-slider-container">
        <input type="range" 
               class="score-slider" 
               min="0" 
               max="100" 
               step="1" 
               value="${score}" 
               data-key="${dim.key}"
               oninput="updateScoreFromSlider(this)"
               onchange="updateScoreFromSlider(this)">
        <div class="score-display" id="score-display-${dim.key}">${score}</div>
      </div>
      <div class="score-labels">
        <span>é£é™©åŒº (0-59)</span>
        <span>å¯ç”¨åŒº (60-79)</span>
        <span>ä¼˜ç§€åŒº (80-100)</span>
      </div>
    `;
    
    // è·å–çŠ¶æ€æŒ‡ç¤ºå™¨
    let statusClass = 'needs-improvement';
    let statusText = 'éœ€è¦æ”¹è¿›';
    if (score >= 80) {
      statusClass = 'excellent';
      statusText = 'è¡¨ç°ä¼˜ç§€';
    } else if (score >= 60) {
      statusClass = 'good';
      statusText = 'è¡¨ç°è‰¯å¥½';
    }
    
    // ç¡®å®šç»´åº¦ç±»å‹ï¼ˆå‰10ä¸ªä¸ºåŸºç¡€ç»´åº¦ï¼Œå4ä¸ªä¸ºæ ¸å¿ƒç»´åº¦ï¼‰
    const dimensionType = idx < 10 ? 'foundation' : 'core';

    return `<div class="card dimension-card ${dimensionType} fade-in" id="card-${dim.key}">
      <div class="flex" style="justify-content:space-between">
        <h3>${idx+1}. ${dim.name} <span class="status-indicator ${statusClass}">${statusText}</span></h3>
        <div class="right">
          <span class="badge ${band}"><i class="dot"></i>è¯„åˆ† <span class="value">${score}</span>/100ï¼ˆ${bandText}ï¼‰</span>
        </div>
      </div>
      <div class="small">${dim.desc||''}</div>
      <div class="kv">
          <div>è¯„åˆ†ï¼ˆ0-100åˆ†ï¼‰</div><div class="slider-container" data-scope="${dim.key}">${sliderHtml}</div>
        </div>
      <h4>æ ‡ç­¾ï¼ˆä»…ä½œå‚è€ƒï¼Œä¸å½±å“åˆ†å€¼ï¼‰</h4>
      <div class="chips" data-scope="${dim.key}">${allChips}</div>
      <div style="margin-top: 8px;">
        <input type="text" id="customTag-${dim.key}" placeholder="æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾..." 
               style="background: #0c1433; border: 1px solid #2a3b7a; border-radius: 6px; color: #e7efff; padding: 4px 8px; font-size: 12px; width: 200px; margin-right: 8px;">
        <button class="btn ghost" onclick="addCustomTag('${dim.key}')" style="font-size: 12px; padding: 4px 8px;">æ·»åŠ </button>
      </div>
    </div>`;
  }).join('');
  
  // æ›´æ–°è¿›åº¦æ¡
  updateProgress(evaluatedCount);
  
  // è®¡ç®—å¹¶æ›´æ–°Big Fiveé¢„è§ˆ
  const scores = {};
  DIMENSIONS.forEach(d => { scores[d.key] = meta[d.key]?.score ?? 50; });
  const bfScores = computeBigFiveFromDimensions(scores);
  updateBFPreview(bfScores);
}

function renderEcoSummary(scores){
  const hints = buildEcoHints(scores);
  const tbody = document.querySelector('#ecoHintsTable tbody');
  
  // æ£€æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è·³è¿‡
  if (!tbody) {
    console.warn('ecoHintsTable not found, skipping eco summary rendering');
    return;
  }
  
  const rows = Object.keys(hints).sort().map(name=>{
    const v = hints[name];
    const cls = v>=0? 'ok':'bad';
    return `<tr><td>${name}</td><td><span class="badge ${cls}"><i class="dot"></i>Î” ${v>0?'+':''}${v}</span> ä»…ä¸ºæ–¹å‘æ€§æç¤ºï¼ˆä¸æ”¹å˜åˆ†æ•°ï¼‰</td></tr>`;
  });
  tbody.innerHTML = rows.length? rows.join('') : `<tr><td colspan="2" class="small">æš‚æ— ï¼ˆé€‰æ‹©ä¸€äº›æ ‡ç­¾æˆ–è°ƒæ•´é¢‘ç‡/æ–¹å‘åä¼šç”Ÿæˆæç¤ºï¼‰</td></tr>`;
  window.saveEcoHint(hints);
}



function collectStep4Payload(){
  const meta = loadMeta();
  let scores = [];
  let ecoHint = {};
  try{ scores = JSON.parse(localStorage.getItem('step4_scores')||'[]') || []; }catch(e){ scores = []; }
  try{ ecoHint = JSON.parse(localStorage.getItem('step4_eco_hint')||'{}') || {}; }catch(e){ ecoHint = {}; }
  let weights = window.loadWeights();
  if(!weights){
    weights = { preset:'general', weights:{...PRESETS.general.w} };
  }
  const compositeRaw = localStorage.getItem('step4_composite');
  const composite = compositeRaw!=null && compositeRaw!=='' ? Number(compositeRaw) : null;
  
  // æ”¶é›†è‡ªå®šä¹‰æ ‡ç­¾æ•°æ®
  const customTagsData = {};
  DIMENSIONS.forEach(dim => {
    const dimMeta = meta[dim.key];
    if (dimMeta && dimMeta.customTags && dimMeta.customTags.length > 0) {
      customTagsData[dim.key] = dimMeta.customTags;
    }
  });
  
  return { meta, scores, ecoHint, weights, composite, customTags: customTagsData };
}

function handleSaveStep4(next){
  window.handleSaveStep4 = handleSaveStep4;
  window.renderWeightsAndComposite();
  const payload = collectStep4Payload();
  
  // è®¡ç®—Big Fiveç¯å¢ƒç”»åƒå¹¶ä¿å­˜
  const scores = {};
  DIMENSIONS.forEach(d => {
    const meta = loadMeta();
    scores[d.key] = meta[d.key]?.score || 50; // ä½¿ç”¨ç™¾åˆ†åˆ¶é»˜è®¤å€¼50
  });
  const bfEnv = computeBigFiveFromDimensions(scores);
  window.saveBFEnv(bfEnv);
  
  // è®¡ç®—8ç»´æ ¸å¿ƒç»“æ„ (step4_core_struct)
  const coreStruct = computeCoreStructFromStep4(scores);
  setNS('step4_core_struct', coreStruct);
  
  // Step4ä¿å­˜åæ–­è¨€æ ¡éªŒ
  try{
    const bf = getNS('step4_bf_env', []);
    assertVec('step4_bf_env', bf, 5);
    assertVec('step4_core_struct', coreStruct, 8);
  }catch(e){ 
    alert('Step4 Big Fiveç¯å¢ƒç”»åƒæˆ–æ ¸å¿ƒç»“æ„æ ¡éªŒå¤±è´¥ï¼š'+e.message); 
    throw e; 
  }
  
  alert('Step4 å·²ä¿å­˜åˆ°æœ¬åœ°ï¼šstep4_meta / step4_scores / step4_bf_env / step4_core_struct');
  try{
    if(window.PSYS){
      PSYS.saveStep('step4', { ...payload, bfEnv, coreStruct, savedAt: new Date().toISOString() });
      console.log('[Step4] saved with bfEnv:', bfEnv, 'coreStruct:', coreStruct);
    }
  }catch(err){ console.warn('PSYS.saveStep step4 failed', err); }
  if(next){ location.href = next; }
}

/** ========= æ»‘å—è¯„åˆ†æ›´æ–°å‡½æ•° ========= */
function updateScoreFromSlider(slider) {
  const key = slider.getAttribute('data-key');
  const score = parseInt(slider.value);
  
  // æ›´æ–°æ˜¾ç¤º
  const display = document.getElementById(`score-display-${key}`);
  if (display) {
    display.textContent = score;
  }
  
  // æ›´æ–°æ•°æ®
  const meta = loadMeta();
  const m = meta[key] || {score: 50, tags:[]};
  m.score = score;
  meta[key] = m;
  window.saveMeta(meta);
  
  // é‡æ–°æ¸²æŸ“é¢æ¿å’Œæƒé‡
  renderPanel();
  window.renderWeightsAndComposite();
}

// å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
window.updateScoreFromSlider = updateScoreFromSlider;

/** ========= äº‹ä»¶ ========= */
function bindEvents(){
  const panel = document.getElementById('panel');
  panel.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if(chip){
      const key = chip.getAttribute('data-key'), tag = chip.getAttribute('data-tag');
      const meta = loadMeta(); const m = meta[key] || {score: 5, tags:[]};
      const i = m.tags.indexOf(tag);
      if(i>=0) m.tags.splice(i,1); else m.tags.push(tag);
      meta[key] = m; window.saveMeta(meta);
      renderPanel(); window.renderWeightsAndComposite();
      return;
    }
    const btn = e.target.closest('button[data-type]');
    if(btn){
      const key = btn.getAttribute('data-key'); const type = btn.getAttribute('data-type'); const val = btn.getAttribute('data-val');
      const meta = loadMeta(); const m = meta[key] || {score: 5, tags:[]};
      if(type === 'score') {
        m.score = parseInt(val);
      }
      meta[key] = m; window.saveMeta(meta);
      renderPanel(); window.renderWeightsAndComposite();
      return;
    }
  });

  document.getElementById('btnSaveHub').addEventListener('click', ()=> handleSaveStep4('hub.html'));
  document.getElementById('btnStep1').addEventListener('click', ()=> handleSaveStep4('step1_linked.html'));
  document.getElementById('btnStep2').addEventListener('click', ()=> handleSaveStep4('step2_linked.html'));
  
  // éšæœºå¡«å†™æ‰€æœ‰ç»´åº¦æŒ‰é’®äº‹ä»¶
  document.getElementById('btnRandomFill').addEventListener('click', ()=> {
    const meta = loadMeta();
    
    // ä¸ºæ¯ä¸ªç»´åº¦éšæœºç”Ÿæˆ50-90åˆ†çš„åˆ†æ•°
    DIMENSIONS.forEach(dim => {
      const randomScore = Math.floor(Math.random() * 41) + 50; // 50-90éšæœºåˆ†æ•°
      const m = meta[dim.key] || {score: 50, tags:[]};
      m.score = randomScore;
      meta[dim.key] = m;
      
      // æ›´æ–°æ»‘å—æ˜¾ç¤º
      const slider = document.querySelector(`input[data-key="${dim.key}"]`);
      if (slider) {
        slider.value = randomScore;
      }
      
      // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
      const display = document.getElementById(`score-display-${dim.key}`);
      if (display) {
        display.textContent = randomScore;
      }
    });
    
    // ä¿å­˜æ•°æ®
    window.saveMeta(meta);
    
    // é‡æ–°æ¸²æŸ“é¢æ¿å’Œæƒé‡
    renderPanel();
    window.renderWeightsAndComposite();
  });
  document.getElementById('btnStep3').addEventListener('click', ()=> handleSaveStep4('step3_linked.html'));
  document.getElementById('btnDashboard').addEventListener('click', ()=> handleSaveStep4('dashboard_linked.html'));

  document.getElementById('btnClear').addEventListener('click', ()=>{
    if(!confirm('ç¡®å®šæ¸…ç©º Step4 çš„å…¨éƒ¨é€‰æ‹©å’ŒæŒ‡æ•°ï¼Ÿ')) return;
    localStorage.removeItem(getNamespacedKey('step4_meta'));
    localStorage.removeItem(getNamespacedKey('step4_scores'));
    localStorage.removeItem(getNamespacedKey('step4_eco_hint'));
    localStorage.removeItem(getNamespacedKey('step4_composite'));
    renderPanel(); window.renderWeightsAndComposite();
  });

  document.getElementById('presetSel').addEventListener('change', (e)=>{
    const val = e.target.value || 'general';
    const preset = PRESETS[val] || PRESETS.general;
    const conf = { preset: val, weights: {...preset.w} };
    window.saveWeights(conf);
    window.renderWeightsAndComposite();
  });

  document.getElementById('btnWeightsReset').addEventListener('click', ()=>{
    const sel = document.getElementById('presetSel');
    const val = sel.value || 'general';
    const preset = PRESETS[val] || PRESETS.general;
    const conf = { preset: val, weights: {...preset.w} };
    window.saveWeights(conf);
    window.renderWeightsAndComposite();
  });
}



// å·¥å…·æç¤ºå‡½æ•°
function getFreqTooltip(freq) {
  const tooltips = {
    "ä»ä¸": "å¹´åº¦æˆ–æ›´å°‘ï¼šè¿™ä¸ªèƒ½åŠ›å¾ˆå°‘ç”¨åˆ°æˆ–å‡ ä¹ä¸å…·å¤‡ï¼ˆ30åˆ†ï¼‰",
    "å¶å°”": "æ¯æœˆ1-2æ¬¡ï¼šå¶å°”ä¼šç”¨åˆ°æˆ–è¡¨ç°å‡ºæ¥ï¼ˆ60åˆ†ï¼‰", 
    "å¸¸æ€": "æ¯å‘¨éƒ½æœ‰ï¼šç»å¸¸ä½¿ç”¨æˆ–è¡¨ç°ç¨³å®šï¼ˆ85åˆ†ï¼‰"
  };
  return tooltips[freq] || "";
}

function getDirTooltip(dir) {
  const tooltips = {
    "åå°‘": "éœ€è¦å¢å¼ºï¼šè¿™æ–¹é¢è¿˜æœ‰æå‡ç©ºé—´ï¼ˆ-10åˆ†ï¼‰",
    "é€‚ä¸­": "åˆšå¥½åˆé€‚ï¼šå½“å‰æ°´å¹³æ¯”è¾ƒç†æƒ³ï¼ˆ0åˆ†ï¼‰",
    "åå¤š": "å¯èƒ½è¿‡åº¦ï¼šè¿™æ–¹é¢å¯èƒ½æœ‰äº›è¿‡å¤´äº†ï¼ˆ-5åˆ†ï¼‰"
  };
  return tooltips[dir] || "";
}

// æ›´æ–°è¿›åº¦æ¡å‡½æ•°
function updateProgress(evaluatedCount) {
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  
  if (progressFill && progressText) {
    const percentage = Math.round((evaluatedCount / 14) * 100);
    progressFill.style.width = percentage + '%';
    progressText.textContent = `${evaluatedCount}/14 ç»´åº¦å·²è¯„ä¼°`;
  }
}



// æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾åŠŸèƒ½
function addCustomTag(dimensionKey) {
  const input = document.getElementById(`customTag-${dimensionKey}`);
  const tagText = input.value.trim();
  
  if (!tagText) {
    alert('è¯·è¾“å…¥æ ‡ç­¾å†…å®¹');
    return;
  }
  
  const meta = loadMeta();
  const m = meta[dimensionKey] || { score: 50, tags: [], customTags: [] };
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆåŒ…æ‹¬é¢„è®¾æ ‡ç­¾å’Œè‡ªå®šä¹‰æ ‡ç­¾ï¼‰
  const dimension = DIMENSIONS.find(d => d.key === dimensionKey);
  const allExistingTags = [...(dimension?.tags || []), ...(m.customTags || [])];
  
  if (allExistingTags.includes(tagText)) {
    alert('è¯¥æ ‡ç­¾å·²å­˜åœ¨');
    return;
  }
  
  // æ·»åŠ åˆ°è‡ªå®šä¹‰æ ‡ç­¾åˆ—è¡¨
  if (!m.customTags) m.customTags = [];
  m.customTags.push(tagText);
  
  // è‡ªåŠ¨é€‰æ‹©æ–°æ·»åŠ çš„æ ‡ç­¾
  if (!m.tags) m.tags = [];
  m.tags.push(tagText);
  
  meta[dimensionKey] = m;
  window.saveMeta(meta);
  
  // æ¸…ç©ºè¾“å…¥æ¡†
  input.value = '';
  
  // é‡æ–°æ¸²æŸ“
  renderPanel();
  window.renderWeightsAndComposite();
}

// åˆ é™¤è‡ªå®šä¹‰æ ‡ç­¾åŠŸèƒ½
function removeCustomTag(dimensionKey, tagText) {
  const meta = loadMeta();
  const m = meta[dimensionKey] || { score: 50, tags: [], customTags: [] };
  
  // ä»è‡ªå®šä¹‰æ ‡ç­¾åˆ—è¡¨ä¸­åˆ é™¤
  if (m.customTags) {
    const index = m.customTags.indexOf(tagText);
    if (index > -1) {
      m.customTags.splice(index, 1);
    }
  }
  
  // ä»é€‰ä¸­æ ‡ç­¾åˆ—è¡¨ä¸­åˆ é™¤
  if (m.tags) {
    const index = m.tags.indexOf(tagText);
    if (index > -1) {
      m.tags.splice(index, 1);
    }
  }
  
  meta[dimensionKey] = m;
  window.saveMeta(meta);
  
  // é‡æ–°æ¸²æŸ“
  renderPanel();
  window.renderWeightsAndComposite();
}

// æ”¯æŒå›è½¦é”®æ·»åŠ æ ‡ç­¾
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && e.target.id && e.target.id.startsWith('customTag-')) {
    const dimensionKey = e.target.id.replace('customTag-', '');
    addCustomTag(dimensionKey);
  }
});
</script>

<script>
(function(){
  const NS='psys:v1';
  
  function qs(k){
    const u=new URL(location.href);
    return u.searchParams.get(k);
  }
  function setMetaFromUrl(){
    const teamId=qs('teamId'), userId=qs('userId'), runId=qs('runId');
    if(teamId && userId && runId){
      sessionStorage.setItem(`${NS}:currentSession`, JSON.stringify({teamId,userId,runId}));
      return true;
    }
    return false;
  }
  function getMeta(){
    try{
      const raw=sessionStorage.getItem(`${NS}:currentSession`);
      return raw?JSON.parse(raw):null;
    }catch{ return null; }
  }
  setMetaFromUrl();
  const meta=getMeta();
  
  // å°†æ‰€æœ‰è°ƒç”¨ setNS/getNS çš„å‡½æ•°ç§»åˆ° IIFE å†…éƒ¨
  function saveMeta(obj){ setNS('step4_meta', obj); }
  function saveScores(arr){ setNS('step4_scores', arr); }
  function saveBFEnv(bf){ setNS('step4_bf_env', bf); }
  function loadWeights(){ try{ return getNS('step4_weights', null); }catch(e){ return null; } }
  function saveWeights(obj){ setNS('step4_weights', obj); }
  function saveComposite(num){ setNS('step4_composite', num); }
  function saveEcoHint(obj){ setNS('step4_eco_hint', obj); }

// === Expose Step4 helpers globally ===
try {
  window.saveMeta = saveMeta;
  window.saveScores = saveScores;
  window.saveBFEnv = saveBFEnv;
  window.saveEcoHint = saveEcoHint;
  window.saveWeights = saveWeights;
  window.saveComposite = saveComposite;
  window.renderWeightsAndComposite = renderWeightsAndComposite;
  window.loadWeights = loadWeights;
} catch (e) { /* noop */ }

  
  

// === expose step4 helpers to global to avoid scope issues ===
window.saveMeta = saveMeta;
window.saveScores = saveScores;
window.saveBFEnv = saveBFEnv;
window.saveEcoHint = saveEcoHint;
window.saveWeights = saveWeights;
window.saveComposite = saveComposite;
window.renderWeightsAndComposite = renderWeightsAndComposite;
window.loadWeights = loadWeights;

// å°†æ‰€æœ‰è°ƒç”¨è¿™äº›å‡½æ•°çš„å‡½æ•°ä¹Ÿç§»åˆ° IIFE å†…éƒ¨
  function renderWeightsAndComposite(){
    const meta = loadMeta();
    const scores = DIMENSIONS.map((d)=> computeDimScore({...meta[d.key], key:d.key}, d.tags.length));
    window.saveScores(scores);

    let wconf = window.loadWeights();
    if(!wconf){
      wconf = { preset:'general', weights: {...PRESETS.general.w} };
      window.saveWeights(wconf);
    }

    const res = calcComposite(scores, wconf.weights);
    window.saveComposite(res.final);

    const $comp = document.getElementById('compVal');
    const $band = document.getElementById('compBand');
    const $pen  = document.getElementById('penaltyText');
    $comp.textContent = isNaN(res.final)? 'â€”' : res.final;
    let bandCls='warn', bandTxt='å¯ç”¨';
    if(res.final>=75){ bandCls='ok'; bandTxt='å¼º'; }
    if(res.final<60){ bandCls='bad'; bandTxt='é£é™©'; }
    $band.className = `badge ${bandCls}`;
    $band.innerHTML = `<i class="dot"></i>${bandTxt}`;
    $pen.textContent = `å…œåº•æƒ©ç½šï¼š${res.penalty}ï¼ˆåœ°åŸºæœ€å°å€¼ ${res.minBase}ï¼‰`;

    const tbody = document.querySelector('#wTable tbody');
    let sumW = 0; DIMENSIONS.forEach(d=> sumW += (wconf.weights[d.key]||0));
    const rows = DIMENSIONS.map((d,idx)=>{
      const w = wconf.weights[d.key]||0;
      const wPct = (sumW>0)? Math.round(w/sumW*1000)/10 : 0;
      return `<tr><td>${idx+1}</td><td>${d.name.split('ï¼ˆ')[0]}</td><td>${wPct}%</td><td>${scores[idx]}</td></tr>`;
    });
    tbody.innerHTML = rows.join('');
    document.getElementById('wSum').textContent = Math.round(sumW*100)/100 + '%';
    document.getElementById('weightedAvg').textContent = res.avg;

    const sel = document.getElementById('presetSel');
    sel.value = wconf.preset || 'general';

    renderEcoSummary(scores);
  }
  
  // å°† init å‡½æ•°ä¹Ÿç§»åˆ° IIFE å†…éƒ¨
  function init(){
    if(!window.loadWeights()){
      window.saveWeights({ preset:'general', weights:{...PRESETS.general.w} });
    }
    renderPanel();
    window.renderWeightsAndComposite();
    bindEvents();
  }
  
  // å°† hydrateStep4 å‡½æ•°ç§»åˆ° IIFE å†…éƒ¨
  function hydrateStep4(meta){
    if(!meta || !window.PSYS){
      renderPanel();
      window.renderWeightsAndComposite();
      return;
    }
    try{
      const sess = PSYS.getSession(meta.teamId, meta.userId, meta.runId);
      const saved = sess?.step4;
      if(saved){
        if(saved.meta){ window.saveMeta(saved.meta); }
        if(Array.isArray(saved.scores)){ window.saveScores(saved.scores); }
        if(saved.ecoHint){ window.saveEcoHint(saved.ecoHint); }
        if(saved.weights){ window.saveWeights(saved.weights); }
        if(saved.composite!=null){ window.saveComposite(saved.composite); }
      } else {
        localStorage.removeItem(getNamespacedKey('step4_meta'));
        localStorage.removeItem(getNamespacedKey('step4_scores'));
        localStorage.removeItem(getNamespacedKey('step4_eco_hint'));
        localStorage.removeItem(getNamespacedKey('step4_composite'));
        localStorage.removeItem(getNamespacedKey('step4_weights'));
      }
    }catch(err){ console.warn('hydrate step4 failed', err); }
    renderPanel();
    window.renderWeightsAndComposite();
  }
  
  // è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
  init();
  
  if(!meta){
    // æ— ä¼šè¯æ—¶å…è®¸æœ¬åœ°æ¨¡å¼ï¼Œä¸å¼ºåˆ¶è·³è½¬
    console.warn('No current session; running in LOCAL mode');
    hydrateStep4(null); // æœ¬åœ°æ¨¡å¼
    // æ˜¾ç¤ºæœ¬åœ°æ¨¡å¼è§’æ ‡
    const div=document.createElement('div');
    div.style.cssText='position:fixed;top:8px;left:8px;background:#8b4513;border:1px solid #a0522d;color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;z-index:99999;opacity:.9';
    div.textContent='æœ¬åœ°æ¨¡å¼ Â· æœªå…³è”å›¢é˜Ÿ';
    document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(div));
  } else {
    hydrateStep4(meta);
    // mount a small corner badge
    const div=document.createElement('div');
    div.style.cssText='position:fixed;top:8px;left:8px;background:#0e1633;border:1px solid #1c2447;color:#e7ecff;padding:6px 10px;border-radius:10px;font-size:12px;z-index:99999;opacity:.9';
    div.textContent='å›¢é˜Ÿ/æˆå‘˜å·²å…³è” Â· å®‰å…¨ä¼šè¯';
    document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(div));
  }

  // Provide manual hooks
  window.psysMarkStepCompleted = function(partName){
    if(!window.PSYS){ console.warn('PSYS not loaded'); return; }
    PSYS.saveStep(partName, {manual:true, savedAt: new Date().toISOString()});
  };
})();
</script>

</body>
</html>
