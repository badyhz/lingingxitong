<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å›¢é˜Ÿæ¨¡å‹ Â· å åŠ é›·è¾¾ï¼ˆä¸ªäººæ˜ å°„â†’å›¢é˜Ÿ14ç»´ / å›¢é˜Ÿæ½œåŠ›8ç»´ / è¡Œä¸šèåˆï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<!-- è‹¥ä½ æœ‰ hub çš„ storage.jsï¼Œè¯·ä¿ç•™ï¼Œå¦åˆ™å¯åˆ é™¤ä¸‹ä¸€è¡Œ -->
<script src="./storage.js"></script>
<style>
:root{
  --bg:#0b1020;--card:#121833;--ink:#e7ecff;--muted:#9aa4c9;--line:#1c2447;
  --good:#4ade80;--warn:#f59f0b;--bad:#ff5c9a;--hl:#2a3b7a
}
*{box-sizing:border-box}
html,body{margin:0;background:linear-gradient(180deg,#0b1020,#0f1431);color:var(--ink);font-family:'Noto Sans SC',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
h1{font-size:22px;margin:0 0 12px}
h2{font-size:18px;margin:18px 0 8px;color:#e7ecff}
.card{
  background:linear-gradient(180deg,#10173a 0%, #0e1430 100%);
  border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;
  box-shadow:0 10px 30px rgba(0,0,0,.24)
}
.row{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:980px){.row{grid-template-columns:1fr 1fr}}
.caption{color:var(--muted);font-size:12px;margin-top:6px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 12px}
select,button,input[type="number"]{
  background:#0e1430;color:#e7ecff;border:1px solid var(--line);
  border-radius:10px;padding:8px 10px;font-size:13px
}
label{font-size:13px;color:var(--muted);margin-right:8px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.badge{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#0e1430;color:#cfe0ff}
canvas{width:100%;height:420px;max-height:54vh}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px dashed #24305b;margin:10px 0}
.table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
.table th,.table td{border-bottom:1px solid #24305b;padding:6px 8px;text-align:left}
.table th{color:#cfe0ff;font-weight:600}
.flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.right{margin-left:auto}
@media (max-width:1180px){
  .container{padding:0 12px}
  .toolbar{gap:6px}
  canvas{max-height:60vh}
}
@media (max-width:1024px){
  .container{padding:0 10px}
  .toolbar{flex-direction:column;align-items:flex-start}
  .card{padding:12px}
  h1{font-size:20px}
  h2{font-size:17px}
  canvas{height:420px;max-height:65vh}
}
@media (max-width:820px){
  .container{padding:0 8px}
  .toolbar button,
  .toolbar select{width:100%}
  .flex{flex-direction:column;align-items:flex-start}
  canvas{height:400px}
}
</style>
</head>
<body>
<div class="container">
  <h1>å›¢é˜Ÿæ¨¡å‹ Â· å åŠ é›·è¾¾</h1>

  <!-- é¡¶éƒ¨å·¥å…·æ¡ï¼šè¿”å›hub / é€‰æ‹©å›¢é˜Ÿ / è¯»å– / æ¨¡æ‹Ÿ / æ¨¡æ¿é€‰æ‹© / çº³å…¥äººæ•°æ˜¾ç¤º -->
  <div class="card">
    <div class="toolbar">
      <button id="backHubBtn">è¿”å› Hub</button>

      <label>é€‰æ‹©å›¢é˜Ÿï¼š
        <select id="teamSelect">
          <option value="">ï¼ˆæ‰«ææœ¬åœ°å¯ç”¨å›¢é˜Ÿï¼‰</option>
        </select>
      </label>
      <button id="readHubBtn">è¯»å–å›¢é˜Ÿæ•°æ®</button>
      <button id="regenBtn">ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®</button>

      <label>å›¢é˜Ÿå®Œç¾æ¨¡æ¿ï¼š
        <select id="teamTemplateSelect">
          <option value="balanced">2.1 å‡è¡¡ç¨³å¥å‹</option>
          <option value="execution">2.2 æ‰§è¡Œé“å†›å‹</option>
          <option value="innovation">2.3 åˆ›æ–°ç ”ç©¶å‹</option>
          <option value="brand">2.4 å“ç‰Œå™äº‹å‹</option>
          <option value="consulting">2.5 å’¨è¯¢æœåŠ¡å‹</option>
          <option value="venture">2.6 åˆ›ä¸šæ•æ·å‹</option>
        </select>
      </label>
      <label><input type="checkbox" id="showTeamTemplate" checked> å åŠ æ¨¡æ¿</label>
      <div class="right badges" id="topBadges"></div>
    </div>
    <div class="small">æç¤ºï¼šä» Hub æ‰“å¼€æœ¬é¡µé¢æ—¶å¯æºå¸¦ teamIdï¼›è‹¥éœ€åˆ‡æ¢å›¢é˜Ÿï¼Œåœ¨ä¸‹æ‹‰æ¡†é€‰æ‹©åç‚¹å‡»â€œè¯»å–å›¢é˜Ÿæ•°æ®â€ã€‚å¦‚æ— æ•°æ®ï¼Œå¯ç”¨â€œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®â€æµ‹è¯•ã€‚</div>
  </div>

  <!-- 1-1 ä¸ªäººâ†’å›¢é˜Ÿ14ç»´ -->
  <div class="card">
    <h2>1-1 ä¸ªäººæ˜ å°„ â†’ å›¢é˜Ÿ <b>14ç»´</b> å åŠ ï¼ˆä¸ªäººâ‰¤12æ¡ + å›¢é˜Ÿå‡å€¼ + å›¢é˜Ÿæ¨¡æ¿ï¼‰</h2>
    <canvas id="team14Chart"></canvas>
    <div class="caption">æˆå‘˜çš„ç”Ÿæ€16/æ½œåŠ›8æŒ‰æ˜ å°„è§„åˆ™åˆæˆä¸ºå›¢é˜Ÿ14ç»´ã€‚å åŠ ä¸ªäººæ›²çº¿ï¼ˆâ‰¤12ï¼‰+ å›¢é˜Ÿå‡å€¼ï¼Œå¯é€‰å åŠ ç†æƒ³æ¨¡æ¿ã€‚</div>
  </div>

  <!-- 1-2 ä¸ªäººâ†’å›¢é˜Ÿæ½œåŠ›8ç»´ -->
  <div class="card">
    <h2>1-2 ä¸ªäººæ˜ å°„ â†’ å›¢é˜Ÿ <b>æ½œåŠ›8ç»´</b> å åŠ ï¼ˆä¸ªäººâ‰¤12æ¡ + å›¢é˜Ÿå‡å€¼ + æ½œåŠ›æ¨¡æ¿ï¼‰</h2>
    <canvas id="teamPot8Chart"></canvas>
    <div class="caption">æ½œåŠ›è½´ï¼šé¢†å¯¼åŠ› / åˆ›æ–° / å“ç‰ŒÂ·å®¡ç¾ / å­¦ä¹ Â·è¿ç§» / å½±å“åŠå¾„ / åˆ›ä¸š / ç§‘ç ” / å¯æŒç»­åº¦ã€‚ä¸‹è¡¨æ˜¾ç¤ºå½“å‰æ¨¡æ¿ç›®æ ‡ã€‚</div>
    <table class="table" id="potTemplateTable"></table>
  </div>

  <!-- 1-3 å›¢é˜Ÿæ¨¡å‹14ç»´ï¼šæå€¼æç¤º + è¡Œä¸šèåˆ -->
  <div class="card">
    <div class="flex" style="justify-content:space-between">
      <h2>1-3 å›¢é˜Ÿæ¨¡å‹ï¼ˆ14ç»´ï¼‰Â· å½“å‰ï¼ˆæå€¼æç¤ºï¼‰ + å›¢é˜Ÿæ¨¡æ¿ + è¡Œä¸šèåˆ</h2>
      <div class="toolbar">
        <label>ä¸»ä¸šï¼š
          <select id="industrySelect"></select>
        </label>
        <label>å‰¯ä¸šï¼š
          <select id="transIndustrySelect"></select>
        </label>
        <label><input type="checkbox" id="showFusion" checked> æ˜¾ç¤ºèåˆæ¨¡å‹</label>
        <label>Î±ä¸»ä¸šï¼š<input type="number" id="wMain" value="0.4" step="0.05" min="0" max="1" style="width:70px"></label>
        <label>Î²å‰¯ä¸šï¼š<input type="number" id="wTrans" value="0.6" step="0.05" min="0" max="1" style="width:70px"></label>
        <label>Î³åŸºæ•°ï¼š<input type="number" id="gamma" value="0.15" step="0.05" min="0" max="0.5" style="width:70px"></label>
      </div>
    </div>
    <div class="badges" id="teamBadges"></div>
    <canvas id="teamModelChart"></canvas>
    <div class="caption">æå€¼å£å¾„ï¼šAç»„çœ‹æœ€ä½ mï¼ˆåº•çº¿ï¼‰ã€Bç»„çœ‹æœ€é«˜ Mï¼ˆå°–åˆ€ï¼‰ã€Cç»„å– p20 ä¸ M çš„å¹³å‡ï¼›Tooltip æ˜¾ç¤º m/p20/Î¼/M/è¦†ç›–ç‡ã€‚</div>
    <hr/>
    <div class="badges" id="fusionKV"></div>
    <table class="table" id="fusionTable"></table>
  </div>

  <!-- æ–°å¢ï¼šæ¡å½¢å›¾å’Œé‡åŒ–åˆ†å€¼å±•ç¤ºåŒºåŸŸ -->
  <div class="card">
    <h2>æ•°æ®å¯è§†åŒ– Â· æ¡å½¢å›¾ä¸é‡åŒ–åˆ†å€¼</h2>
    
    <!-- æ¡å½¢å›¾å±•ç¤ºåŒºåŸŸ -->
    <div style="margin-bottom: 20px;">
      <h3>æ¡å½¢å›¾å±•ç¤º</h3>
      <div class="toolbar">
        <label>é€‰æ‹©å›¾è¡¨ï¼š
          <select id="chartTypeSelect">
            <option value="team14">å›¢é˜Ÿ14ç»´æ•°æ®</option>
            <option value="teamPot8">å›¢é˜Ÿæ½œåŠ›8ç»´æ•°æ®</option>
            <option value="teamModel">å›¢é˜Ÿæ¨¡å‹14ç»´æ•°æ®</option>
          </select>
        </label>
        <label>æ˜¾ç¤ºç±»å‹ï¼š
          <select id="displayTypeSelect">
            <option value="mean">å›¢é˜Ÿå‡å€¼</option>
            <option value="current">å½“å‰æ•°æ®</option>
            <option value="all">å…¨éƒ¨å¯¹æ¯”</option>
          </select>
        </label>
      </div>
      <canvas id="barChart" style="height: 400px;"></canvas>
      <div class="caption">æ¡å½¢å›¾å±•ç¤ºå„ç»´åº¦çš„å…·ä½“æ•°å€¼ï¼Œä¾¿äºç›´è§‚æ¯”è¾ƒå’Œåˆ†æã€‚</div>
    </div>

    <!-- é‡åŒ–åˆ†å€¼å±•ç¤ºè¡¨æ ¼ -->
    <div>
      <h3>é‡åŒ–åˆ†å€¼è¯¦ç»†æ•°æ®</h3>
      <div class="toolbar">
        <button id="exportDataBtn">å¯¼å‡ºæ•°æ®</button>
        <button id="toggleAllDataBtn">æ˜¾ç¤º/éšè—å…¨éƒ¨æ•°æ®</button>
      </div>
      
      <!-- å›¢é˜Ÿ14ç»´æ•°æ®è¡¨ -->
      <h4>å›¢é˜Ÿ14ç»´æ•°æ®</h4>
      <table class="table" id="team14DataTable">
        <thead>
          <tr>
            <th>ç»´åº¦</th>
            <th>å›¢é˜Ÿå‡å€¼</th>
            <th>æœ€å°å€¼</th>
            <th>P20å€¼</th>
            <th>æœ€å¤§å€¼</th>
            <th>è¦†ç›–ç‡â‰¥70%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- å›¢é˜Ÿæ½œåŠ›8ç»´æ•°æ®è¡¨ -->
      <h4>å›¢é˜Ÿæ½œåŠ›8ç»´æ•°æ®</h4>
      <table class="table" id="teamPot8DataTable">
        <thead>
          <tr>
            <th>ç»´åº¦</th>
            <th>å›¢é˜Ÿå‡å€¼</th>
            <th>æœ€å°å€¼</th>
            <th>P20å€¼</th>
            <th>æœ€å¤§å€¼</th>
            <th>è¦†ç›–ç‡â‰¥70%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- å›¢é˜Ÿæ¨¡å‹14ç»´æ•°æ®è¡¨ -->
      <h4>å›¢é˜Ÿæ¨¡å‹14ç»´æ•°æ®</h4>
      <table class="table" id="teamModelDataTable">
        <thead>
          <tr>
            <th>ç»´åº¦</th>
            <th>å½“å‰å€¼</th>
            <th>æœ€å°å€¼</th>
            <th>P20å€¼</th>
            <th>æœ€å¤§å€¼</th>
            <th>è¦†ç›–ç‡â‰¥70%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- ä¸ªäººè¯¦ç»†æ•°æ®è¡¨ï¼ˆå¯æŠ˜å ï¼‰ -->
      <div id="individualDataSection" style="display: none;">
        <h4>ä¸ªäººè¯¦ç»†æ•°æ®</h4>
        <table class="table" id="individualDataTable">
          <thead>
            <tr>
              <th>æˆå‘˜</th>
              <th>ç»´åº¦</th>
              <th>14ç»´æ˜ å°„å€¼</th>
              <th>æ½œåŠ›8ç»´æ˜ å°„å€¼</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- æ–°å¢åŠŸèƒ½åŒºåŸŸ -->
<div class="container mt-4">
  <!-- å¤šç»´åº¦æ•°æ®å¯¹æ¯”å±•ç¤º -->
  <div class="card">
    <h2>ğŸ“Š å¤šç»´åº¦æ•°æ®å¯¹æ¯”å±•ç¤º</h2>
    <div class="toolbar">
      <label>å¯¹æ¯”ç±»å‹ï¼š
        <select id="comparisonType">
          <option value="team_vs_individual">å›¢é˜Ÿå‡å€¼ vs ä¸ªäººæ•°æ®</option>
          <option value="dimensions_ranking">ç»´åº¦æ’åå¯¹æ¯”</option>
          <option value="strength_weakness">ä¼˜åŠ¿åŠ£åŠ¿åˆ†æ</option>
        </select>
      </label>
      <label>ç»´åº¦é€‰æ‹©ï¼š
        <select id="comparisonDimension">
          <option value="team14">å›¢é˜Ÿ14ç»´</option>
          <option value="teamPot8">å›¢é˜Ÿæ½œåŠ›8ç»´</option>
        </select>
      </label>
      <button onclick="generateComparison()">ç”Ÿæˆå¯¹æ¯”åˆ†æ</button>
      <button onclick="exportComparison()">å¯¼å‡ºå¯¹æ¯”æ•°æ®</button>
    </div>
    <div id="comparisonChart" style="height: 400px; margin-top: 12px;">
      <canvas id="comparisonCanvas"></canvas>
    </div>
  </div>

  <!-- è¯¦ç»†æ–‡å­—åˆ†æå†…å®¹ -->
  <div class="card">
    <h2>ğŸ“ è¯¦ç»†æ–‡å­—åˆ†æå†…å®¹</h2>
    <div class="toolbar">
      <button onclick="generateTeamAnalysis()">å›¢é˜Ÿæ•´ä½“åˆ†æ</button>
      <button onclick="generateStrengthAnalysis()">ä¼˜åŠ¿åˆ†æ</button>
      <button onclick="generateImprovementAnalysis()">æ”¹è¿›å»ºè®®</button>
      <div class="right">
        <button onclick="exportAnalysis()">å¯¼å‡ºåˆ†ææŠ¥å‘Š</button>
        <button onclick="clearAnalysis()">æ¸…ç©ºå†…å®¹</button>
      </div>
    </div>
    <div id="analysisContent" style="min-height: 300px; background: linear-gradient(180deg, #0e1430 0%, #0b1020 100%); border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin-top: 12px; font-size: 14px; line-height: 1.6;">
      <div style="color: var(--muted); text-align: center; padding-top: 120px;">
        <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“Š</div>
        <div>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆç›¸åº”çš„åˆ†æå†…å®¹...</div>
      </div>
    </div>
  </div>

  <!-- ä¾¿äºAIç”Ÿæˆåˆ†ææŠ¥å‘Šçš„æ•°æ®æ”¯æŒ -->
  <div class="card">
    <h2>ğŸ¤– AIåˆ†ææŠ¥å‘Šæ•°æ®æ”¯æŒ</h2>
    <div class="toolbar">
      <label>æ•°æ®æ ¼å¼ï¼š
        <select id="aiDataFormat">
          <option value="json">JSONæ ¼å¼</option>
          <option value="csv">CSVæ ¼å¼</option>
          <option value="structured">ç»“æ„åŒ–æ–‡æœ¬</option>
        </select>
      </label>
      <label>æ•°æ®èŒƒå›´ï¼š
        <select id="aiDataScope">
          <option value="complete">å®Œæ•´æ•°æ®é›†</option>
          <option value="summary">æ‘˜è¦æ•°æ®</option>
          <option value="key_metrics">å…³é”®æŒ‡æ ‡</option>
        </select>
      </label>
      <div class="right">
        <button onclick="generateAIData()">ç”ŸæˆAIæ•°æ®</button>
        <button onclick="copyAIData()">å¤åˆ¶æ•°æ®</button>
        <button onclick="downloadAIData()">ä¸‹è½½æ•°æ®æ–‡ä»¶</button>
      </div>
    </div>
    <div id="aiDataPreview" style="min-height: 200px; background: linear-gradient(180deg, #0e1430 0%, #0b1020 100%); border: 1px solid var(--line); border-radius: 12px; padding: 16px; margin-top: 12px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">
      <div style="color: var(--muted); text-align: center; padding-top: 60px;">
        <div style="font-size: 36px; margin-bottom: 12px;">ğŸ¤–</div>
        <div>AIåˆ†ææ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== åŸºç¡€å¸¸é‡ ====== */
const P = window.PSYS || null;

const ECO16 = ['ä¿¡ä»»å¯åŠ¨åº¦','åä½œè´¨é‡','å…³ç³»éŸ§æ€§','å½±å“åŠå¾„','ç›®æ ‡æ¨è¿›åŠ›','èŠ‚å¥ç®¡ç†','åº”å˜æ•ˆç‡','å¹¸ç¦æ„Ÿ','ä¿¡æ¯é€æ˜åº¦','å†³ç­–æ•ˆç‡','åˆ›é€ åŠ›','ç»“æ„æ€ç»´','è¾¹ç•Œä¸ä¸»æƒ','ç°å®æ ¡å‡†','è‡ªæˆ‘é©±åŠ¨','å­¦ä¹ æ°›å›´'];
const POT8  = ['é¢†å¯¼æ½œåŠ›','åˆ›æ–°æ½œåŠ›','è‰ºæœ¯æ½œåŠ›','å­¦ä¹ æ½œåŠ›','ç¤¾äº¤æ½œåŠ›','åˆ›ä¸šæ½œåŠ›','ç§‘ç ”æ½œåŠ›','å¹¸ç¦æ½œåŠ›'];
const TEAM14 = ['æƒ…ç»ªç¨³å®š','åä½œè´¨é‡','ä¿¡ä»»é€Ÿåº¦','èŠ‚å¥ç®¡ç†','åº”å˜æ•ˆç‡','å¯æŒç»­åº¦','ç›®æ ‡æ¨è¿›åŠ›','é¢†å¯¼åŠ›','åˆ›æ–°æ½œåŠ›','å½±å“åŠå¾„','åˆ›ä¸šæ½œåŠ›','å­¦ä¹ ä¸è¿ç§»','ç§‘ç ”æ·±åº¦','å“ç‰Œ/å®¡ç¾'];
const AXIS_TYPE_TEAM = {
  'æƒ…ç»ªç¨³å®š':'A','åä½œè´¨é‡':'A','ä¿¡ä»»é€Ÿåº¦':'A','èŠ‚å¥ç®¡ç†':'A','åº”å˜æ•ˆç‡':'A','å¯æŒç»­åº¦':'A',
  'ç›®æ ‡æ¨è¿›åŠ›':'B','é¢†å¯¼åŠ›':'B','åˆ›æ–°æ½œåŠ›':'B','å½±å“åŠå¾„':'B','åˆ›ä¸šæ½œåŠ›':'B',
  'å­¦ä¹ ä¸è¿ç§»':'C','ç§‘ç ”æ·±åº¦':'C','å“ç‰Œ/å®¡ç¾':'C'
};
const BLADE_AXES=['ç›®æ ‡æ¨è¿›åŠ›','é¢†å¯¼åŠ›','åˆ›æ–°æ½œåŠ›'];
const BASELINE_AXES=['æƒ…ç»ªç¨³å®š','åä½œè´¨é‡','ä¿¡ä»»é€Ÿåº¦'];

/* ====== å›¢é˜Ÿæ¨¡æ¿ï¼ˆ14ç»´ï¼‰ ====== */
const TEAM_TEMPLATES={
  balanced:{name:'å‡è¡¡ç¨³å¥å‹',values:[72,74,72,73,74,72,84,83,83,78,80,74,72,74]},
  execution:{name:'æ‰§è¡Œé“å†›å‹',values:[68,72,72,75,74,68,88,85,78,80,82,70,68,70]},
  innovation:{name:'åˆ›æ–°ç ”ç©¶å‹',values:[70,72,70,72,74,70,80,82,88,75,80,80,86,68]},
  brand:{name:'å“ç‰Œå™äº‹å‹',values:[70,72,70,72,70,72,78,80,82,86,78,72,65,88]},
  consulting:{name:'å’¨è¯¢æœåŠ¡å‹',values:[74,78,76,76,74,72,80,85,72,78,74,78,70,76]},
  venture:{name:'åˆ›ä¸šæ•æ·å‹',values:[68,70,70,72,72,68,84,84,82,82,88,76,70,78]}
};

/* ====== å›¢é˜Ÿæ½œåŠ›æ¨¡æ¿ï¼ˆ8ç»´ï¼‰ ====== */
const TEAM_POT8_AXES=['é¢†å¯¼åŠ›','åˆ›æ–°æ½œåŠ›','å“ç‰Œ/å®¡ç¾','å­¦ä¹ ä¸è¿ç§»','å½±å“åŠå¾„','åˆ›ä¸šæ½œåŠ›','ç§‘ç ”æ·±åº¦','å¯æŒç»­åº¦'];
const TEAM_POT_TEMPLATES={
  balanced:{name:'å‡è¡¡ç¨³å¥å‹',values:[82,82,78,78,78,80,76,74]},
  execution:{name:'æ‰§è¡Œé“å†›å‹',values:[84,78,72,72,76,84,70,70]},
  innovation:{name:'åˆ›æ–°ç ”ç©¶å‹',values:[82,88,72,80,76,80,86,70]},
  brand:{name:'å“ç‰Œå™äº‹å‹',values:[80,82,88,74,84,78,70,72]},
  consulting:{name:'å’¨è¯¢æœåŠ¡å‹',values:[85,74,76,78,78,74,72,72]},
  venture:{name:'åˆ›ä¸šæ•æ·å‹',values:[84,82,80,76,82,88,72,70]}
};

/* ====== è¡Œä¸šåŸºçº¿ï¼ˆTEAM14ï¼Œç”¨äºèåˆï¼‰ ====== */
const INDUSTRY_TEAM_BASE={
  'SaaS/DevTools':[72,76,74,74,74,72,84,82,80,78,78,78,72,70],
  'AI/DeepTech':[72,72,70,72,74,72,80,82,86,76,80,82,86,68],
  'ç”µå•†/ä¾›åº”é“¾':[70,76,72,76,74,72,84,80,76,78,78,72,68,68],
  'FinTech':[74,78,74,74,74,72,80,82,78,76,76,74,76,68],
  'åˆ¶é€ /å·¥ä¸š':[74,75,72,78,76,74,82,82,76,72,76,72,74,66],
  'å“ç‰Œ/è®¾è®¡/å†…å®¹':[70,72,70,72,70,72,78,80,82,86,76,72,66,88],
  'ä¸“ä¸šæœåŠ¡/å’¨è¯¢':[74,78,76,76,74,72,80,85,72,78,74,78,70,76],
  'æ•™è‚²':[72,78,74,74,72,72,78,80,76,74,72,80,66,76],
  'æ¸¸æˆ':[70,72,70,72,70,70,80,80,84,84,78,72,66,86],
  'åŒ»ç–—/ç”Ÿç‰©':[72,74,70,72,74,72,78,80,76,70,72,74,86,68],
  'åœ°äº§/ä¸åŠ¨äº§':[72,75,72,74,72,72,82,84,72,78,76,70,68,74]
};

/* ====== hubâ†’eco16 åç§°æ˜ å°„ï¼ˆä»…å½“ä½ ç”¨ storage.js çš„ step3/step2 æ•°æ®æ—¶ä¼šç”¨åˆ°ï¼‰ ====== */
const SOURCE_STEP3_ECO16=['ä¿¡ä»»é€Ÿåº¦','åä½œè´¨é‡','å…³ç³»éŸ§æ€§','å½±å“åŠå¾„','ç›®æ ‡æ¨è¿›åŠ›','èŠ‚å¥ç®¡ç†','åº”å˜æ•ˆç‡','è½åœ°é—­ç¯åº¦','æ´å¯Ÿæ•é”åº¦','è¡¨è¾¾æ¡ç†åº¦','ä¿¡æ¯æ•´åˆåº¦','æ”¹è¿›é©±åŠ¨åŠ›','èƒ½é‡å¤–æ”¾','å†²çªé£æ ¼','ç¯å¢ƒè´´åˆåº¦','å¹¸ç¦æ„ŸåŸºç¡€'];
const ECO16_NAME_MAP={
  'ä¿¡ä»»å¯åŠ¨åº¦':['ä¿¡ä»»é€Ÿåº¦'],
  'åä½œè´¨é‡':['åä½œè´¨é‡'],
  'å…³ç³»éŸ§æ€§':['å…³ç³»éŸ§æ€§'],
  'å½±å“åŠå¾„':['å½±å“åŠå¾„'],
  'ç›®æ ‡æ¨è¿›åŠ›':['ç›®æ ‡æ¨è¿›åŠ›'],
  'èŠ‚å¥ç®¡ç†':['èŠ‚å¥ç®¡ç†'],
  'åº”å˜æ•ˆç‡':['åº”å˜æ•ˆç‡'],
  'å¹¸ç¦æ„Ÿ':['å¹¸ç¦æ„ŸåŸºç¡€'],
  'ä¿¡æ¯é€æ˜åº¦':['ä¿¡æ¯æ•´åˆåº¦','è¡¨è¾¾æ¡ç†åº¦'],
  'å†³ç­–æ•ˆç‡':['è½åœ°é—­ç¯åº¦','ä¿¡æ¯æ•´åˆåº¦'],
  'åˆ›é€ åŠ›':['èƒ½é‡å¤–æ”¾','æ´å¯Ÿæ•é”åº¦'],
  'ç»“æ„æ€ç»´':['è¡¨è¾¾æ¡ç†åº¦','ä¿¡æ¯æ•´åˆåº¦'],
  'è¾¹ç•Œä¸ä¸»æƒ':['ç¯å¢ƒè´´åˆåº¦','å†²çªé£æ ¼'],
  'ç°å®æ ¡å‡†':['æ”¹è¿›é©±åŠ¨åŠ›','æ´å¯Ÿæ•é”åº¦'],
  'è‡ªæˆ‘é©±åŠ¨':['èƒ½é‡å¤–æ”¾','ç›®æ ‡æ¨è¿›åŠ›'],
  'å­¦ä¹ æ°›å›´':['æ´å¯Ÿæ•é”åº¦','ç¯å¢ƒè´´åˆåº¦']
};
const POT8_DERIVED_INDEX={
  'é¢†å¯¼æ½œåŠ›':[4,5,7],
  'åˆ›æ–°æ½œåŠ›':[2,6,5],
  'è‰ºæœ¯æ½œåŠ›':[5],
  'å­¦ä¹ æ½œåŠ›':[0,6,2],
  'ç¤¾äº¤æ½œåŠ›':[3,7],
  'åˆ›ä¸šæ½œåŠ›':[3,5,6],
  'ç§‘ç ”æ½œåŠ›':[0,2],
  'å¹¸ç¦æ½œåŠ›':[1,4]
};

/* ====== å·¥å…·å‡½æ•° ====== */
function randn(mu=0,sigma=1){const u=Math.random()||1e-9,v=Math.random()||1e-9;return mu+sigma*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v)}
function clamp(v,min=0,max=100){return Math.max(min,Math.min(max,v))}
function getUrlParam(k){ return new URL(location.href).searchParams.get(k); }
function getSessionMeta(){ try{ const raw=sessionStorage.getItem('psys:v1:currentSession'); return raw?JSON.parse(raw):null; }catch{return null;} }
function ensureSessionTeam(teamId){
  if(!teamId) return;
  const meta=getSessionMeta()||{};
  if(meta.teamId===teamId){
    if(!meta.runId) meta.runId=`team_${Date.now()}`;
    sessionStorage.setItem('psys:v1:currentSession', JSON.stringify(meta));
    return;
  }
  sessionStorage.setItem('psys:v1:currentSession', JSON.stringify({teamId, runId:`team_${Date.now()}` }));
}

/* ====== å…³é”®ï¼šå­—æ®µåˆ«åå¯¹é½ + åˆ»åº¦å½’ä¸€åŒ–ï¼ˆç»Ÿä¸€åˆ° 0â€“100ï¼‰ ====== */
// å¸¸è§åˆ«å â†’ ç»Ÿä¸€åˆ° ECO16 é”®
const ECO_SYNONYM = {
  'ä¿¡ä»»é€Ÿåº¦':'ä¿¡ä»»å¯åŠ¨åº¦',
  'å¹¸ç¦æ„ŸåŸºç¡€':'å¹¸ç¦æ„Ÿ',
  'è½åœ°é—­ç¯åº¦':'å†³ç­–æ•ˆç‡',
  'æ´å¯Ÿæ•é”åº¦':'ç°å®æ ¡å‡†',
  'è¡¨è¾¾æ¡ç†åº¦':'ç»“æ„æ€ç»´',
  'ä¿¡æ¯é€æ˜åº¦':'ä¿¡æ¯é€æ˜åº¦',
  'èƒ½é‡å¤–æ”¾':'åˆ›é€ åŠ›',
  'ç¯å¢ƒè´´åˆåº¦':'å­¦ä¹ æ°›å›´',
  'å†²çªé£æ ¼':'è¾¹ç•Œä¸ä¸»æƒ'
};

// è‡ªåŠ¨è¯†åˆ«åˆ»åº¦å¹¶è¿”å› 0â€“100 æ ‡å‡†åŒ–å‡½æ•°
function detectScaler(obj){
  const vals = Object.values(obj||{}).map(Number).filter(v=>isFinite(v));
  if (!vals.length) return v=>v;
  const max = Math.max(...vals);
  // 0â€“1 / 0â€“1.5
  if (max <= 1.5) return v => v * 100;
  // 1â€“5 / 0â€“5
  if (max <= 5.5) return v => (v / 5) * 100;
  // 1â€“7 / 0â€“7
  if (max <= 7.5) return v => (v / 7) * 100;
  // 1â€“9 / 0â€“9
  if (max <= 9.5) return v => (v / 9) * 100;
  // 0â€“10
  if (max <= 10.5) return v => (v / 10) * 100;
  // 0â€“20
  if (max <= 20.5) return v => (v / 20) * 100;
  // å·²æ˜¯ç™¾åˆ†åˆ¶æˆ–æ›´å¤§
  return v => Math.min(100, v);
}

function sanitizeMetricMap(obj, keys){
  const values=Object.values(obj||{}).map(Number).filter(v=>isFinite(v));
  const fallback=values.length? values.reduce((a,b)=>a+b,0)/values.length : 60;
  const out={};
  keys.forEach(k=>{
    const v=obj && typeof obj[k]==='number' && isFinite(obj[k]) ? Number(obj[k]) : fallback;
    out[k]=Math.round(clamp(v));
  });
  return out;
}

// å½’ä¸€åŒ–å•ä¸ªäººï¼ˆå¯¹é½åˆ«å â†’ æ£€æµ‹åˆ»åº¦ â†’ ç™¾åˆ†åˆ¶ï¼‰
function normalizePerson(p){
  // é”®åå¯¹é½ï¼ˆåªå¤„ç† ECO16 ä¸­å‡ºç°çš„ï¼‰
  const ecoRaw = {...(p.eco||{})};
  Object.entries(ECO_SYNONYM).forEach(([src,dst])=>{
    if (ecoRaw[src]!=null && ecoRaw[dst]==null) ecoRaw[dst]=ecoRaw[src];
  });

  const ecoScale = detectScaler(ecoRaw);
  const potScale = detectScaler(p.pot||{});

  const eco = {};
  ECO16.forEach(k=>{
    const v = Number(ecoRaw[k]);
    if (isFinite(v)) eco[k] = Math.round(clamp(ecoScale(v)));
  });

  const pot = {};
  POT8.forEach(k=>{
    const v = Number((p.pot||{})[k]);
    if (isFinite(v)) pot[k] = Math.round(clamp(potScale(v)));
  });

  return { ...p, eco: sanitizeMetricMap(eco, ECO16), pot: sanitizeMetricMap(pot, POT8) };
}

// å½’ä¸€åŒ–æ•´ä¸ªå›¢é˜Ÿ
function normalizeTeam(data){
  const people = (data.people||[]).map(normalizePerson);
  return { ...data, people };
}

/* ====== ä» hub ä¼šè¯æ‹¼è£…ä¸ªäºº eco/potï¼ˆå¯é€‰ï¼‰ ====== */
function mapEcoFromSession(sess){
  // ä¼˜å…ˆä½¿ç”¨æœ€ç»ˆå£å¾„æ•°æ®
  const arr = Array.isArray(sess?.computed?.ecology16) ? sess.computed.ecology16 : null;
  if(arr && arr.length===16){
    const eco = {};
    ECO16.forEach((name,i)=> eco[name] = arr[i]);
    return sanitizeMetricMap(eco, ECO16);
  }
  
  // å…œåº•ï¼šåŸæœ‰é€»è¾‘ï¼ˆstep3/step2ï¼‰
  const src=Array.isArray(sess?.step3?.eco16)? sess.step3.eco16 : Array.isArray(sess?.step2?.eco16Raw)? sess.step2.eco16Raw : null;
  if(!src) return null;
  const eco={};
  ECO16.forEach(target=>{
    const names=ECO16_NAME_MAP[target] || [target];
    let sum=0,count=0;
    names.forEach(name=>{
      const idx=SOURCE_STEP3_ECO16.indexOf(name);
      if(idx>=0 && src[idx]!=null && isFinite(src[idx])){ sum+=Number(src[idx]); count++; }
    });
    if(count) eco[target]=sum/count;
  });
  return sanitizeMetricMap(eco, ECO16);
}
function mapPotFromSession(sess){
  // ä¼˜å…ˆä½¿ç”¨æœ€ç»ˆå£å¾„æ•°æ®
  const arr = Array.isArray(sess?.computed?.potentialEnv8) ? sess.computed.potentialEnv8 : null;
  if(arr && arr.length===8){
    const pot = {};
    POT8.forEach((name,i)=> pot[name] = arr[i]);
    return sanitizeMetricMap(pot, POT8);
  }
  
  // å…œåº•ï¼šåŸæœ‰é€»è¾‘ï¼ˆç”¨step3.structæ¨å¯¼ï¼‰
  const struct=Array.isArray(sess?.step3?.struct)? sess.step3.struct : null;
  if(!struct) return null;
  const pot={};
  Object.entries(POT8_DERIVED_INDEX).forEach(([name, idxs])=>{
    let sum=0,count=0;
    idxs.forEach(idx=>{
      const v=struct[idx];
      if(v!=null && isFinite(v)){ sum+=Number(v); count++; }
    });
    if(count) pot[name]=sum/count;
  });
  return sanitizeMetricMap(pot, POT8);
}

/* ====== è¯»å–å›¢é˜Ÿï¼ˆhub/localStorageï¼‰ ====== */
function buildTeamFromSessions(teamId){
  if(!P) return null;
  try{
    const users=P.getUsers(teamId)||[];
    const people=[];
    users.forEach(u=>{
      if(u.hidden) return;
      const meta=P.getLastSessionMetaForUser(teamId, u.userId);
      if(!meta) return;
      const sess=P.getSession(meta.teamId, meta.userId, meta.runId);
      if(!sess) return;
      const eco=mapEcoFromSession(sess) || sanitizeMetricMap({}, ECO16);
      const pot=mapPotFromSession(sess) || sanitizeMetricMap({}, POT8);
      people.push({ name:u.name || 'æˆå‘˜', eco, pot });
    });
    return people.length? {people, industry:'SaaS/DevTools'} : null;
  }catch(err){
    console.warn('buildTeamFromSessions failed', err);
    return null;
  }
}
function readTeamFromLocalRecords(teamId){
  if(!teamId) return null;
  const explicit=[
    `PSYS:TEAM:${teamId}:people`,
    `PSYS_TEAM_${teamId}`,
    `TEAM:${teamId}:people`,
    `team:${teamId}:people`,
    `PSYS_TEAM_PEOPLE_${teamId}`
  ];
  for(const k of explicit){
    try{
      const raw=localStorage.getItem(k); if(!raw) continue;
      const obj=JSON.parse(raw);
      if(Array.isArray(obj?.people) && obj.people[0]?.eco && obj.people[0]?.pot) return {people:obj.people};
      if(Array.isArray(obj) && obj[0]?.eco && obj[0]?.pot) return {people:obj};
      if(obj?.records && Array.isArray(obj.records)){
        const filtered=obj.records.filter(x=> (x.teamId||x.teamID||x.team_id)===teamId && x.eco && x.pot);
        if(filtered.length) return {people:filtered};
      }
    }catch{}
  }
  const global=['PSYS_TEAM_PEOPLE','TEAM_DATA_V1','DASHBOARD_DATA_V1','dashboard_people','dashboardData','peopleData','teamPeople','step_all_result'];
  for(const k of global){
    try{
      const raw=localStorage.getItem(k); if(!raw) continue;
      const obj=JSON.parse(raw);
      const arr=Array.isArray(obj?.people)? obj.people : Array.isArray(obj)? obj : (obj?.records||[]);
      if(Array.isArray(arr)){
        const filtered=arr.filter(p=> (p.teamId||p.teamID||p.team_id)===teamId && p.eco && p.pot);
        if(filtered.length) return {people:filtered};
      }
    }catch{}
  }
  return null;
}
function readTeamById(teamId){
  return buildTeamFromSessions(teamId) || readTeamFromLocalRecords(teamId);
}
function tryReadTeamFromLocal(){
  const keys=['PSYS_TEAM_PEOPLE','TEAM_DATA_V1','DASHBOARD_DATA_V1','dashboard_people','dashboardData','peopleData','teamPeople','step_all_result'];
  for(const k of keys){
    try{
      const raw=localStorage.getItem(k); if(!raw) continue;
      const obj=JSON.parse(raw);
      if(Array.isArray(obj?.people) && obj.people[0]?.eco && obj.people[0]?.pot) return obj;
      if(Array.isArray(obj) && obj[0]?.eco && obj[0]?.pot) return {people:obj};
    }catch{}
  }
  return null;
}

/* ====== å›¢é˜Ÿå‘ç°ï¼ˆç”¨äºä¸‹æ‹‰ï¼‰ ====== */
function discoverTeams(){
  const found=new Map();
  const add=(id,count,label)=>{
    if(!id) return;
    const entry=found.get(id);
    if(entry){
      entry.count=Math.max(entry.count,count||0);
      if(label && !entry.label) entry.label=label;
    }else{
      found.set(id,{count:count||0,label:label||''});
    }
  };
  if(P){
    try{
      (P.getTeams()||[]).forEach(team=>{
        const members=P.getUsers(team.teamId)||[];
        add(team.teamId, members.length, team.teamName);
      });
    }catch(err){ console.warn('discoverTeams:PSYS', err); }
  }
  const regexes=[
    /^PSYS:TEAM:([^:]+):people$/,
    /^PSYS_TEAM_([^:]+)$/,
    /^TEAM:([^:]+):people$/,
    /^team:([^:]+):people$/,
    /^PSYS_TEAM_PEOPLE_([^:]+)$/
  ];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    for(const re of regexes){
      const m=k.match(re);
      if(m){ add(m[1],0,''); break; }
    }
  }
  const global=['PSYS_TEAM_PEOPLE','TEAM_DATA_V1','DASHBOARD_DATA_V1','dashboard_people','dashboardData','peopleData','teamPeople','step_all_result'];
  for(const k of global){
    try{
      const raw=localStorage.getItem(k); if(!raw) continue;
      const obj=JSON.parse(raw);
      const arr=Array.isArray(obj?.people)? obj.people : Array.isArray(obj)? obj : (obj?.records||[]);
      if(Array.isArray(arr)){
        arr.forEach(p=>{
          const id=p?.teamId||p?.teamID||p?.team_id;
          if(id) add(String(id),0,'');
        });
      }
    }catch{}
  }
  const list=Array.from(found.entries()).map(([id,info])=>({id, count:info.count, label:info.label||id}));
  list.sort((a,b)=>a.label.localeCompare(b.label,'zh-CN'));
  return list;
}

/* ====== æ˜ å°„è§„åˆ™ï¼šä¸ªäººâ†’TEAM14 / å›¢é˜Ÿæ½œåŠ›8 ====== */
const TEAM14_SOURCES={
  'æƒ…ç»ªç¨³å®š':{eco:{'å¹¸ç¦æ„Ÿ':0.4,'å…³ç³»éŸ§æ€§':0.3,'èŠ‚å¥ç®¡ç†':0.3}},
  'åä½œè´¨é‡':{eco:{'åä½œè´¨é‡':0.6,'ä¿¡ä»»å¯åŠ¨åº¦':0.25,'ä¿¡æ¯é€æ˜åº¦':0.15}},
  'ä¿¡ä»»é€Ÿåº¦':{eco:{'ä¿¡ä»»å¯åŠ¨åº¦':1.0}},
  'èŠ‚å¥ç®¡ç†':{eco:{'èŠ‚å¥ç®¡ç†':1.0}},
  'åº”å˜æ•ˆç‡':{eco:{'åº”å˜æ•ˆç‡':0.6,'ç°å®æ ¡å‡†':0.4}},
  'å¯æŒç»­åº¦':{eco:{'å¹¸ç¦æ„Ÿ':0.5,'èŠ‚å¥ç®¡ç†':0.5}},
  'ç›®æ ‡æ¨è¿›åŠ›':{eco:{'ç›®æ ‡æ¨è¿›åŠ›':1.0}},
  'é¢†å¯¼åŠ›':{pot:{'é¢†å¯¼æ½œåŠ›':1.0}},
  'åˆ›æ–°æ½œåŠ›':{pot:{'åˆ›æ–°æ½œåŠ›':1.0}},
  'å½±å“åŠå¾„':{eco:{'å½±å“åŠå¾„':0.6}, pot:{'ç¤¾äº¤æ½œåŠ›':0.4}},
  'åˆ›ä¸šæ½œåŠ›':{pot:{'åˆ›ä¸šæ½œåŠ›':1.0}},
  'å­¦ä¹ ä¸è¿ç§»':{pot:{'å­¦ä¹ æ½œåŠ›':0.7}, eco:{'åº”å˜æ•ˆç‡':0.3}},
  'ç§‘ç ”æ·±åº¦':{pot:{'ç§‘ç ”æ½œåŠ›':1.0}},
  'å“ç‰Œ/å®¡ç¾':{pot:{'è‰ºæœ¯æ½œåŠ›':0.7}, eco:{'åˆ›é€ åŠ›':0.3}}
};
const TEAM_POT8_SOURCES={
  'é¢†å¯¼åŠ›':{pot:{'é¢†å¯¼æ½œåŠ›':1.0}},
  'åˆ›æ–°æ½œåŠ›':{pot:{'åˆ›æ–°æ½œåŠ›':1.0}},
  'å“ç‰Œ/å®¡ç¾':{pot:{'è‰ºæœ¯æ½œåŠ›':0.8}, eco:{'åˆ›é€ åŠ›':0.2}},
  'å­¦ä¹ ä¸è¿ç§»':{pot:{'å­¦ä¹ æ½œåŠ›':0.8}, eco:{'åº”å˜æ•ˆç‡':0.2}},
  'å½±å“åŠå¾„':{pot:{'ç¤¾äº¤æ½œåŠ›':0.7}, eco:{'å½±å“åŠå¾„':0.3}},
  'åˆ›ä¸šæ½œåŠ›':{pot:{'åˆ›ä¸šæ½œåŠ›':1.0}},
  'ç§‘ç ”æ·±åº¦':{pot:{'ç§‘ç ”æ½œåŠ›':1.0}},
  'å¯æŒç»­åº¦':{pot:{'å¹¸ç¦æ½œåŠ›':0.7}, eco:{'å¹¸ç¦æ„Ÿ':0.3}}
};
function mapPersonToTeam14(p){
  return TEAM14.map(ax=>{
    const spec=TEAM14_SOURCES[ax]||{};
    let acc=0,w=0;
    if(spec.eco){ for(const k in spec.eco){ const ww=spec.eco[k], v=p.eco?.[k]; if(isFinite(v)){ acc+=ww*v; w+=ww; } } }
    if(spec.pot){ for(const k in spec.pot){ const ww=spec.pot[k], v=p.pot?.[k]; if(isFinite(v)){ acc+=ww*v; w+=ww; } } }
    return w? clamp(acc/w):0;
  });
}
function mapPersonToTeamPot8(p){
  return TEAM_POT8_AXES.map(ax=>{
    const spec=TEAM_POT8_SOURCES[ax]||{};
    let acc=0,w=0;
    if(spec.eco){ for(const k in spec.eco){ const ww=spec.eco[k], v=p.eco?.[k]; if(isFinite(v)){ acc+=ww*v; w+=ww; } } }
    if(spec.pot){ for(const k in spec.pot){ const ww=spec.pot[k], v=p.pot?.[k]; if(isFinite(v)){ acc+=ww*v; w+=ww; } } }
    return w? clamp(acc/w):0;
  });
}

/* ====== ç»Ÿè®¡ä¸æŒ‡æ ‡ ====== */
function meanVector(vectors,len){
  if(!vectors.length) return Array(len).fill(0);
  const out=Array(len).fill(0);
  vectors.forEach(vec=> vec.forEach((v,i)=> out[i]+=v));
  return out.map(v=>v/vectors.length);
}
function statsPerDimFromMapped(vecs, labels){
  const out={};
  labels.forEach((ax,i)=>{
    const vals=vecs.map(v=>v[i]).filter(v=>isFinite(v));
    if(!vals.length){ out[ax]={mu:0,p20:0,max:0,min:0,cov70:0}; return; }
    const mu=vals.reduce((a,b)=>a+b,0)/vals.length;
    const sorted=[...vals].sort((a,b)=>a-b);
    const p20=sorted[Math.max(0,Math.floor(sorted.length*0.2)-1)] ?? sorted[0];
    const max=sorted[sorted.length-1];
    const min=sorted[0];
    const cov70=vals.filter(v=>v>=70).length/vals.length;
    out[ax]={mu,p20,max,min,cov70};
  });
  return out;
}
function computeTRIFromMapped(stats){
  let a=0,b=0,n=0;
  for(const ax in stats){ const s=stats[ax]; a+=(s.mu-s.p20)/100; b+=(s.max-s.mu)/100; n++; }
  return n? clamp(0.6*(a/n)+0.4*(b/n),0,1):0;
}
function computeRDIFromMapped(stats){
  let risky=0,total=0;
  BLADE_AXES.forEach(ax=>{
    const s=stats[ax]; if(!s) return;
    total++;
    const danger=(s.max>=85)&&(s.mu<75)&&(s.p20<65);
    if(danger) risky++;
  });
  return total? risky/total : 0;
}
function computeTSIFromCurrent(currentMap){
  let a=0,ac=0,b=0,bc=0,c=0,cc=0;
  TEAM14.forEach(ax=>{
    const t=AXIS_TYPE_TEAM[ax], v=currentMap[ax]||0;
    if(t==='A'){a+=v;ac++;}
    else if(t==='B'){b+=v;bc++;}
    else {c+=v;cc++;}
  });
  const A=ac?a/ac:0, B=bc?b/bc:0, C=cc?c/cc:0;
  return clamp(0.5*A+0.3*B+0.2*C);
}

/* ====== èåˆæ¨¡å‹ ====== */
function industryTeamVector(ind){ return [...(INDUSTRY_TEAM_BASE[ind]||TEAM_TEMPLATES.balanced.values)]; }
function fusionTeamVector(mainInd, transInd, alpha=0.4, beta=0.6, gammaBase=0.15){
  const A=industryTeamVector(mainInd), B=industryTeamVector(transInd), F=[];
  for(let i=0;i<TEAM14.length;i++){
    const a=A[i], b=B[i], t=AXIS_TYPE_TEAM[TEAM14[i]];
    const gamma=gammaBase*(t==='A'?0.67:(t==='B'?1.33:1.0));
    const synergy=Math.sqrt(Math.max(0,a)*Math.max(0,b));
    const diff=b-a, tau=5, kappa=0.2*beta;
    const contrast=(Math.abs(diff)>tau)? Math.sign(diff)*kappa*(Math.abs(diff)-tau):0;
    F.push(clamp(alpha*a + beta*b + gamma*synergy + contrast));
  }
  return F;
}

/* ====== ç”»å›¾ ====== */
let team14Chart, teamPot8Chart, teamModelChart;
let teamModelLegendState={};
const DEFAULT_LEGEND_ONCLICK=(Chart?.defaults?.plugins?.legend?.onClick)||function(evt,item,legend){
  const chart=legend.chart;
  const idx=item.datasetIndex;
  chart.toggleDataVisibility(idx);
  chart.update();
};
function palette(i,alpha=0.25){const h=(i*47)%360;return `hsla(${h}deg,80%,60%,${alpha})`;}
function makeRadar(ctx, labels, datasets, extraOptions={}){
  const baseOptions={
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{position:'top', labels:{color:'#e7ecff', boxWidth:14, boxHeight:14}},
      tooltip:{callbacks:{label:(ctx)=>{
        const axis=labels[ctx.dataIndex], val=Math.round(ctx.parsed.r);
        if(ctx.chart.canvas.id==='teamModelChart' && window.__TEAM14_STATS){
          const s=window.__TEAM14_STATS[axis];
          if(s){
            return `${ctx.dataset.label}: ${val} | m:${Math.round(s.min)} p20:${Math.round(s.p20)} Î¼:${Math.round(s.mu)} M:${Math.round(s.max)} è¦†ç›–â‰¥70%:${Math.round(s.cov70*100)}%`;
          }
        }
        return `${ctx.dataset.label}: ${val}`;
      }}}
    },
    scales:{ r:{
      angleLines:{color:'#223059'},
      grid:{color:'#1f2a52'},
      pointLabels:{color:'#cfe0ff', font:{size:11}},
      min:0, max:100, beginAtZero:true,
      ticks:{backdropColor:'transparent', color:'#9fb3ff', showLabelBackdrop:false, stepSize:10}
    }},
    elements:{ line:{borderWidth:2}, point:{radius:2} }
  };
  const merged={...baseOptions, ...extraOptions};
  merged.plugins={...baseOptions.plugins, ...(extraOptions.plugins||{})};
  if(extraOptions.plugins && extraOptions.plugins.legend){
    merged.plugins.legend={...baseOptions.plugins.legend, ...extraOptions.plugins.legend};
  }
  if(extraOptions.plugins && extraOptions.plugins.tooltip){
    merged.plugins.tooltip={...baseOptions.plugins.tooltip, ...extraOptions.plugins.tooltip};
  }
  return new Chart(ctx, { type:'radar', data:{labels, datasets}, options:merged });
}

/* ====== äº¤äº’æ§ä»¶ ====== */
const backHubBtn=document.getElementById('backHubBtn');
const teamSelect=document.getElementById('teamSelect');
const readHubBtn=document.getElementById('readHubBtn');
const regenBtn=document.getElementById('regenBtn');
const teamTemplateSelect=document.getElementById('teamTemplateSelect');
const showTeamTemplate=document.getElementById('showTeamTemplate');
const industrySelect=document.getElementById('industrySelect');
const transIndustrySelect=document.getElementById('transIndustrySelect');
const showFusion=document.getElementById('showFusion');
const wMainInput=document.getElementById('wMain');
const wTransInput=document.getElementById('wTrans');
const gammaInput=document.getElementById('gamma');
const topBadges=document.getElementById('topBadges');
const potTemplateTable=document.getElementById('potTemplateTable');
const teamBadges=document.getElementById('teamBadges');
const fusionKV=document.getElementById('fusionKV');
const fusionTable=document.getElementById('fusionTable');

/* ====== åˆå§‹åŒ–ä¸æ•°æ® ====== */
let currentTeamId=getUrlParam('teamId') || (getSessionMeta()?.teamId || '');

function mockTeam(N=12){
  const people=Array.from({length:N}).map((_,i)=>{
    const eco={},pot={};
    const eb=(Math.random()*10-5), pb=(Math.random()*10-5);
    ECO16.forEach((k,idx)=>{
      let base=65+(Math.sin((i+1)*(idx+1))*8)+eb;
      if(k==='åä½œè´¨é‡'||k==='ç›®æ ‡æ¨è¿›åŠ›') base+=5;
      eco[k]=clamp(base+randn(0,4),40,95);
    });
    POT8.forEach((k,idx)=>{
      let base=66+(Math.cos((i+2)*(idx+1))*9)+pb;
      if(k==='é¢†å¯¼æ½œåŠ›'||k==='åˆ›æ–°æ½œåŠ›') base+=6;
      pot[k]=clamp(base+randn(0,5),40,96);
    });
    return {name:`æˆå‘˜${i+1}`, eco, pot};
  });
  return {people, industry:'SaaS/DevTools'};
}

function tryInitialData(){
  if(currentTeamId){
    const d=readTeamById(currentTeamId);
    if(d) return d;
  }
  if(P){
    try{
      const teams=P.getTeams()||[];
      for(const t of teams){
        const built=buildTeamFromSessions(t.teamId);
        if(built){ currentTeamId=t.teamId; ensureSessionTeam(currentTeamId); return built; }
      }
    }catch(err){ console.warn('tryInitialData: PSYS', err); }
  }
  const local=tryReadTeamFromLocal();
  if(local) return local;
  currentTeamId='';
  return mockTeam(12);
}

let DATA = normalizeTeam( tryInitialData() );  // <<< åˆå§‹å³å½’ä¸€åŒ–
if(currentTeamId) ensureSessionTeam(currentTeamId);

function initIndustryOptions(){
  const keys=Object.keys(INDUSTRY_TEAM_BASE);
  industrySelect.innerHTML=keys.map(k=>`<option value="${k}">${k}</option>`).join('');
  transIndustrySelect.innerHTML=keys.map(k=>`<option value="${k}">${k}</option>`).join('');
  if(DATA.industry && INDUSTRY_TEAM_BASE[DATA.industry]){
    industrySelect.value=DATA.industry;
  }else{
    industrySelect.value='SaaS/DevTools';
  }
  if(!INDUSTRY_TEAM_BASE[transIndustrySelect.value]){
    transIndustrySelect.value='å“ç‰Œ/è®¾è®¡/å†…å®¹';
  }
}
function populateTeamSelect(){
  const teams=discoverTeams();
  let html='<option value="">ï¼ˆé€‰æ‹©å›¢é˜Ÿåç‚¹å‡»â€œè¯»å–å›¢é˜Ÿæ•°æ®â€ï¼‰</option>';
  teams.forEach(t=>{
    html+=`<option value="${t.id}">${t.label || t.id}${t.count?`ï¼ˆçº¦${t.count}äººï¼‰`:''}</option>`;
  });
  teamSelect.innerHTML=html;
  if(currentTeamId && teams.some(t=>t.id===currentTeamId)){
    teamSelect.value=currentTeamId;
  }
}
initIndustryOptions();
populateTeamSelect();

/* ====== æ¸²æŸ“ä¸»æµç¨‹ ====== */
function renderAll(){
  const people=Array.isArray(DATA?.people) ? DATA.people : [];
  DATA.industry = industrySelect.value;

  topBadges.innerHTML=`
    <span class="badge">å›¢é˜Ÿï¼š<b>${currentTeamId || 'æ¨¡æ‹Ÿæ•°æ®'}</b></span>
    <span class="badge">çº³å…¥äººæ•°ï¼š<b>${people.length}</b></span>
    <span class="badge">ä¸»ä¸šï¼š<b>${industrySelect.value}</b></span>
  `;

  const mapped14=people.map(mapPersonToTeam14);
  const mappedPot8=people.map(mapPersonToTeamPot8);
  const mean14=meanVector(mapped14, TEAM14.length);
  const meanPot8=meanVector(mappedPot8, TEAM_POT8_AXES.length);

  // 1-1
  if(team14Chart) team14Chart.destroy();
  const tmplKey=teamTemplateSelect.value;
  const indiv14DS=people.slice(0,12).map((p,idx)=>({
    label:p.name || `æˆå‘˜${idx+1}`,
    data:mapped14[idx],
    borderColor:palette(idx,.45),
    backgroundColor:palette(idx,.07),
    borderWidth:1,
    pointRadius:0
  }));
  const datasets14=[
    ...indiv14DS,
    {label:'å›¢é˜Ÿå‡å€¼ï¼ˆ14ç»´ï¼‰', data:mean14, borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.10)', borderWidth:2, pointRadius:0}
  ];
  if(showTeamTemplate.checked){
    const tmpl=TEAM_TEMPLATES[tmplKey];
    datasets14.push({label:`æ¨¡æ¿ï½œ${tmpl.name}`, data:tmpl.values, borderColor:'#a5b4fc', borderDash:[8,4], backgroundColor:'rgba(165,180,252,0.06)', borderWidth:2, pointRadius:0});
  }
  team14Chart=makeRadar(document.getElementById('team14Chart'), TEAM14, datasets14);

  // 1-2
  if(teamPot8Chart) teamPot8Chart.destroy();
  const potTmpl=TEAM_POT_TEMPLATES[tmplKey];
  const indivPotDS=people.slice(0,12).map((p,idx)=>({
    label:p.name || `æˆå‘˜${idx+1}`,
    data:mappedPot8[idx],
    borderColor:palette(idx+6,.45),
    backgroundColor:palette(idx+6,.07),
    borderWidth:1,
    pointRadius:0
  }));
  const datasetsPot=[
    ...indivPotDS,
    {label:'å›¢é˜Ÿå‡å€¼ï¼ˆæ½œåŠ›8ï¼‰', data:meanPot8, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.10)', borderWidth:2, pointRadius:0}
  ];
  if(showTeamTemplate.checked){
    datasetsPot.push({label:`æ½œåŠ›æ¨¡æ¿ï½œ${potTmpl.name}`, data:potTmpl.values, borderColor:'#f59e0b', borderDash:[8,4], backgroundColor:'rgba(245,158,11,.06)', borderWidth:2, pointRadius:0});
  }
  teamPot8Chart=makeRadar(document.getElementById('teamPot8Chart'), TEAM_POT8_AXES, datasetsPot);

  potTemplateTable.innerHTML='<thead><tr><th>æ½œåŠ›ç»´åº¦</th><th>æ¨¡æ¿ç›®æ ‡</th></tr></thead><tbody>' +
    TEAM_POT8_AXES.map((ax,i)=>`<tr><td>${ax}</td><td>${potTmpl.values[i]}</td></tr>`).join('') + '</tbody>';

  // 1-3
  if(teamModelChart){
    teamModelChart.data.datasets.forEach((ds,idx)=>{
      const meta=teamModelChart.getDatasetMeta(idx);
      teamModelLegendState[ds.label]=meta.hidden===true;
    });
    teamModelChart.destroy();
  }
  const stat14=statsPerDimFromMapped(mapped14, TEAM14);
  window.__TEAM14_STATS=stat14;
  const currentMap={};
  TEAM14.forEach(ax=>{
    const s=stat14[ax];
    const t=AXIS_TYPE_TEAM[ax];
    currentMap[ax]=(t==='A')? s.p20 : (t==='B')? s.max : 0.5*s.p20+0.5*s.max;
  });
  const currentVec=TEAM14.map(ax=>clamp(currentMap[ax]));
  const bottomPts=TEAM14.map(ax=>BASELINE_AXES.includes(ax)? stat14[ax].min : NaN);
  const topPts=TEAM14.map(ax=>BLADE_AXES.includes(ax)? stat14[ax].max : NaN);
  const mi=industrySelect.value, ti=transIndustrySelect.value;
  const alpha=parseFloat(wMainInput.value||'0.4'), beta=parseFloat(wTransInput.value||'0.6'), gamma=parseFloat(gammaInput.value||'0.15');
  const fusion=showFusion.checked? fusionTeamVector(mi, ti, alpha, beta, gamma) : null;
  const tier={High:TEAM14.map(ax=>AXIS_TYPE_TEAM[ax]==='A'?72:AXIS_TYPE_TEAM[ax]==='B'?85:70),
              Medium:TEAM14.map(ax=>AXIS_TYPE_TEAM[ax]==='A'?65:AXIS_TYPE_TEAM[ax]==='B'?82:64),
              Low:TEAM14.map(ax=>AXIS_TYPE_TEAM[ax]==='A'?58:AXIS_TYPE_TEAM[ax]==='B'?75:60)};
  const baseDatasets=[
    {label:'å›¢é˜Ÿå½“å‰ï¼ˆAçœ‹p20ï½œBçœ‹Mï½œCæŠ˜ä¸­ï¼‰', data:currentVec, borderColor:'#f59f0b', backgroundColor:'rgba(245,159,11,.12)', borderWidth:2, pointRadius:0},
    ...(showTeamTemplate.checked? [{label:`å›¢é˜Ÿæ¨¡æ¿ï½œ${TEAM_TEMPLATES[tmplKey].name}`, data:TEAM_TEMPLATES[tmplKey].values, borderColor:'#a5b4fc', borderDash:[8,4], backgroundColor:'rgba(165,180,252,.06)', borderWidth:2, pointRadius:0}] : []),
    ...(fusion? [{label:`èåˆæ¨¡å‹ï¼ˆ${mi}Ã—${ti}ï¼‰`, data:fusion, borderColor:'#22d3ee', borderDash:[6,2], backgroundColor:'rgba(34,211,238,.06)', borderWidth:2, pointRadius:0}] : []),
    {label:'é«˜é…å‚è€ƒ', data:tier.High, borderColor:'rgba(74,222,128,.85)', borderDash:[3,3], backgroundColor:'rgba(74,222,128,.05)', borderWidth:1, pointRadius:0},
    {label:'ä¸­é…å‚è€ƒ', data:tier.Medium, borderColor:'rgba(96,165,250,.85)', borderDash:[3,3], backgroundColor:'rgba(96,165,250,.05)', borderWidth:1, pointRadius:0},
    {label:'ä½é…å‚è€ƒ', data:tier.Low, borderColor:'rgba(255,92,154,.85)', borderDash:[3,3], backgroundColor:'rgba(255,92,154,.05)', borderWidth:1, pointRadius:0},
    {label:'åº•çº¿ç‚¹ï¼ˆAç»„Â·mï¼‰', data:bottomPts, showLine:false, pointRadius:4, pointHoverRadius:5, pointStyle:'rectRot', borderWidth:0, borderColor:'rgba(239,68,68,1)', backgroundColor:'rgba(239,68,68,.12)'},
    {label:'å³°å€¼ç‚¹ï¼ˆBç»„Â·Mï¼‰', data:topPts, showLine:false, pointRadius:4, pointHoverRadius:5, pointStyle:'circle', borderWidth:0, borderColor:'rgba(34,197,94,1)', backgroundColor:'rgba(34,197,94,.12)'}
  ];
  const datasetsModel=baseDatasets.map(ds=>{
    const clone={...ds};
    if(Object.prototype.hasOwnProperty.call(teamModelLegendState, clone.label) && teamModelLegendState[clone.label]){
      clone.hidden=true;
    }
    return clone;
  });
  teamModelChart=makeRadar(
    document.getElementById('teamModelChart'),
    TEAM14,
    datasetsModel,
    {plugins:{legend:{onClick:(evt,item,legend)=>{
      DEFAULT_LEGEND_ONCLICK(evt,item,legend);
      const chart=legend.chart, idx=item.datasetIndex, label=chart.data.datasets[idx]?.label;
      if(label){ teamModelLegendState[label]=chart.getDatasetMeta(idx).hidden===true; }
    }}}}
  );

  const TRI=computeTRIFromMapped(stat14);
  const RDI=computeRDIFromMapped(stat14);
  const TSI=computeTSIFromCurrent(currentMap);
  teamBadges.innerHTML=`
    <span class="badge">TSI å›¢é˜Ÿå®åŠ›ï¼š<b>${TSI.toFixed(1)}</b></span>
    <span class="badge">TRI åˆ†åŒ–é£é™©ï¼š<b>${(TRI*100).toFixed(0)}%</b></span>
    <span class="badge">RDI å•ç‚¹é£é™©ï¼š<b>${(RDI*100).toFixed(0)}%</b></span>
    <span class="badge">æˆå‘˜æ•°ï¼š<b>${people.length}</b></span>
    ${fusion? `<span class="badge">èåˆå‚æ•°ï¼šÎ±=${alpha.toFixed(2)}ï½œÎ²=${beta.toFixed(2)}ï½œÎ³=${gamma.toFixed(2)}</span>`:''}
  `;

  if(!fusion){
    fusionKV.innerHTML='';
    fusionTable.innerHTML='';
  }else{
    fusionKV.innerHTML=`<span class="badge">èåˆç›®æ ‡ï¼š${mi} Ã— ${ti}</span>`;
    const A=industryTeamVector(mi), B=industryTeamVector(ti);
    let html='<thead><tr><th>ç»´åº¦</th><th>ä¸»ä¸šæ¨¡æ¿</th><th>å‰¯ä¸šæ¨¡æ¿</th><th>èåˆç›®æ ‡</th></tr></thead><tbody>';
    TEAM14.forEach((ax,i)=>{ html+=`<tr><td>${ax}</td><td>${Math.round(A[i])}</td><td>${Math.round(B[i])}</td><td><b>${Math.round(fusion[i])}</b></td></tr>`; });
    html+='</tbody>'; fusionTable.innerHTML=html;
  }
  
  // æ›´æ–°æ¡å½¢å›¾å’Œæ•°æ®è¡¨æ ¼
  updateDataTables();
  updateBarChart();
}

/* ====== æ¡å½¢å›¾å’Œæ•°æ®è¡¨æ ¼åŠŸèƒ½ ====== */
let barChart;
let currentBarData = {};

// åˆ›å»ºæ¡å½¢å›¾
function createBarChart(labels, datasets) {
  const ctx = document.getElementById('barChart');
  if (barChart) {
    barChart.destroy();
  }
  
  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            color: '#e7ecff',
            boxWidth: 14,
            boxHeight: 14
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${Math.round(context.parsed.y)}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#cfe0ff',
            font: { size: 10 }
          },
          grid: {
            color: '#1f2a52'
          }
        },
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            color: '#9fb3ff',
            stepSize: 10
          },
          grid: {
            color: '#1f2a52'
          }
        }
      }
    }
  });
}

// æ›´æ–°æ¡å½¢å›¾
function updateBarChart() {
  const chartType = document.getElementById('chartTypeSelect').value;
  const displayType = document.getElementById('displayTypeSelect').value;
  
  let labels, datasets;
  
  if (chartType === 'team14') {
    labels = TEAM14;
    const mean14 = currentBarData.mean14 || [];
    const template14 = currentBarData.template14 || [];
    
    if (displayType === 'mean') {
      datasets = [{
        label: 'å›¢é˜Ÿå‡å€¼ï¼ˆ14ç»´ï¼‰',
        data: mean14,
        backgroundColor: 'rgba(34,197,94,0.6)',
        borderColor: '#22c55e',
        borderWidth: 1
      }];
    } else if (displayType === 'all') {
      datasets = [
        {
          label: 'å›¢é˜Ÿå‡å€¼ï¼ˆ14ç»´ï¼‰',
          data: mean14,
          backgroundColor: 'rgba(34,197,94,0.6)',
          borderColor: '#22c55e',
          borderWidth: 1
        }
      ];
    }
  } else if (chartType === 'teamPot8') {
    labels = TEAM_POT8_AXES;
    const meanPot8 = currentBarData.meanPot8 || [];
    const templatePot8 = currentBarData.templatePot8 || [];
    
    if (displayType === 'mean') {
      datasets = [{
        label: 'å›¢é˜Ÿå‡å€¼ï¼ˆæ½œåŠ›8ç»´ï¼‰',
        data: meanPot8,
        backgroundColor: 'rgba(96,165,250,0.6)',
        borderColor: '#60a5fa',
        borderWidth: 1
      }];
    } else if (displayType === 'all') {
      datasets = [
        {
          label: 'å›¢é˜Ÿå‡å€¼ï¼ˆæ½œåŠ›8ç»´ï¼‰',
          data: meanPot8,
          backgroundColor: 'rgba(96,165,250,0.6)',
          borderColor: '#60a5fa',
          borderWidth: 1
        }
      ];
    }
  } else if (chartType === 'teamModel') {
    labels = TEAM14;
    const current = currentBarData.current || [];
    
    if (displayType === 'current') {
      datasets = [{
        label: 'å›¢é˜Ÿå½“å‰ï¼ˆæ¨¡å‹ï¼‰',
        data: current,
        backgroundColor: 'rgba(245,159,11,0.6)',
        borderColor: '#f59f0b',
        borderWidth: 1
      }];
    } else if (displayType === 'all') {
      datasets = [
        {
          label: 'å›¢é˜Ÿå½“å‰ï¼ˆæ¨¡å‹ï¼‰',
          data: current,
          backgroundColor: 'rgba(245,159,11,0.6)',
          borderColor: '#f59f0b',
          borderWidth: 1
        }
      ];
    }
  }
  
  createBarChart(labels, datasets);
}

// æ›´æ–°æ•°æ®è¡¨æ ¼
function updateDataTables() {
  const people = Array.isArray(DATA?.people) ? DATA.people : [];
  const mapped14 = people.map(mapPersonToTeam14);
  const mappedPot8 = people.map(mapPersonToTeamPot8);
  const mean14 = meanVector(mapped14, TEAM14.length);
  const meanPot8 = meanVector(mappedPot8, TEAM_POT8_AXES.length);
  const stat14 = statsPerDimFromMapped(mapped14, TEAM14);
  const statPot8 = statsPerDimFromMapped(mappedPot8, TEAM_POT8_AXES);
  
  const tmplKey = teamTemplateSelect.value;
  const template14 = TEAM_TEMPLATES[tmplKey].values;
  const templatePot8 = TEAM_POT_TEMPLATES[tmplKey].values;
  
  // æ›´æ–°å›¢é˜Ÿ14ç»´æ•°æ®è¡¨
  const team14Table = document.getElementById('team14DataTable').querySelector('tbody');
  team14Table.innerHTML = '';
  TEAM14.forEach((axis, i) => {
    const stats = stat14[axis];
    const row = team14Table.insertRow();
    row.innerHTML = `
      <td><strong>${axis}</strong></td>
      <td>${Math.round(mean14[i])}</td>
      <td>${Math.round(stats.min)}</td>
      <td>${Math.round(stats.p20)}</td>
      <td>${Math.round(stats.max)}</td>
      <td>${Math.round(stats.cov70 * 100)}%</td>
    `;
  });
  
  // æ›´æ–°å›¢é˜Ÿæ½œåŠ›8ç»´æ•°æ®è¡¨
  const teamPot8Table = document.getElementById('teamPot8DataTable').querySelector('tbody');
  teamPot8Table.innerHTML = '';
  TEAM_POT8_AXES.forEach((axis, i) => {
    const stats = statPot8[axis];
    const row = teamPot8Table.insertRow();
    row.innerHTML = `
      <td><strong>${axis}</strong></td>
      <td>${Math.round(meanPot8[i])}</td>
      <td>${Math.round(stats.min)}</td>
      <td>${Math.round(stats.p20)}</td>
      <td>${Math.round(stats.max)}</td>
      <td>${Math.round(stats.cov70 * 100)}%</td>
    `;
  });
  
  // æ›´æ–°å›¢é˜Ÿæ¨¡å‹14ç»´æ•°æ®è¡¨
  const currentMap = {};
  TEAM14.forEach(ax => {
    const s = stat14[ax];
    const t = AXIS_TYPE_TEAM[ax];
    currentMap[ax] = (t === 'A') ? s.p20 : (t === 'B') ? s.max : 0.5 * s.p20 + 0.5 * s.max;
  });
  const currentVec = TEAM14.map(ax => clamp(currentMap[ax]));
  
  const teamModelTable = document.getElementById('teamModelDataTable').querySelector('tbody');
  teamModelTable.innerHTML = '';
  TEAM14.forEach((axis, i) => {
    const row = teamModelTable.insertRow();
    row.innerHTML = `
      <td><strong>${axis}</strong></td>
      <td>${Math.round(currentVec[i])}</td>
    `;
  });
  
  // æ›´æ–°ä¸ªäººè¯¦ç»†æ•°æ®è¡¨
  const individualTable = document.getElementById('individualDataTable').querySelector('tbody');
  individualTable.innerHTML = '';
  people.forEach((person, personIndex) => {
    const mapped14Values = mapped14[personIndex];
    const mappedPot8Values = mappedPot8[personIndex];
    
    TEAM14.forEach((axis, axisIndex) => {
      const row = individualTable.insertRow();
      const pot8Index = TEAM_POT8_AXES.indexOf(axis);
      row.innerHTML = `
        <td>${person.name || `æˆå‘˜${personIndex + 1}`}</td>
        <td>${axis}</td>
        <td>${Math.round(mapped14Values[axisIndex])}</td>
        <td>${pot8Index >= 0 ? Math.round(mappedPot8Values[pot8Index]) : '-'}</td>
      `;
    });
  });
  
  // ä¿å­˜å½“å‰æ•°æ®ä¾›æ¡å½¢å›¾ä½¿ç”¨
  currentBarData = {
    mean14: mean14,
    meanPot8: meanPot8,
    current: currentVec
  };
}

// å¯¼å‡ºæ•°æ®åŠŸèƒ½
function exportData() {
  const data = {
    teamId: currentTeamId,
    timestamp: new Date().toISOString(),
    team14Data: currentBarData.mean14,
    teamPot8Data: currentBarData.meanPot8,
    currentData: currentBarData.current,
    labels: {
      team14: TEAM14,
      teamPot8: TEAM_POT8_AXES
    }
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `team_radar_data_${currentTeamId || 'mock'}_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ====== äº‹ä»¶ ====== */
const teamModelLegendReset=()=>{ teamModelLegendState={}; };
document.getElementById('backHubBtn').addEventListener('click', ()=>{ window.location.href='hub.html'; });
document.getElementById('readHubBtn').addEventListener('click', ()=>{
  const teamId=teamSelect.value || currentTeamId || getUrlParam('teamId');
  if(!teamId){ alert('è¯·å…ˆåœ¨ä¸‹æ‹‰æ¡†é€‰æ‹©å›¢é˜Ÿ'); return; }
  const dataset=readTeamById(teamId);
  if(dataset && Array.isArray(dataset.people) && dataset.people.length){
    DATA = normalizeTeam({ people:dataset.people, industry: dataset.industry || industrySelect.value || 'SaaS/DevTools' }); // <<< è¯»å–åå½’ä¸€åŒ–
    currentTeamId=teamId;
    ensureSessionTeam(teamId);
    teamModelLegendReset();
    populateTeamSelect();
    renderAll();
  }else{
    alert(`æœªæ‰¾åˆ° teamId=${teamId} çš„å›¢é˜Ÿæ•°æ®ã€‚è¯·ç¡®è®¤ hub å·²å†™å…¥è¯¥å›¢é˜Ÿæˆ–å®Œæˆ Step3 ä¿å­˜ã€‚`);
  }
});
document.getElementById('regenBtn').addEventListener('click', ()=>{
  DATA = normalizeTeam( mockTeam(12) ); // <<< æ¨¡æ‹Ÿåä¹Ÿå½’ä¸€åŒ–ï¼ˆä¸çœŸå®æ•°æ®å£å¾„ä¸€è‡´ï¼‰
  currentTeamId='';
  teamModelLegendReset();
  renderAll();
});
[teamTemplateSelect,showTeamTemplate,industrySelect,transIndustrySelect,showFusion,wMainInput,wTransInput,gammaInput]
  .forEach(el=> el.addEventListener('change', ()=>{ renderAll(); }));
teamSelect.addEventListener('change', (e)=>{ const val=e.target.value; if(val) ensureSessionTeam(val); });

// æ–°å¢äº‹ä»¶ç›‘å¬å™¨
document.getElementById('chartTypeSelect').addEventListener('change', updateBarChart);
document.getElementById('displayTypeSelect').addEventListener('change', updateBarChart);
document.getElementById('exportDataBtn').addEventListener('click', exportData);
document.getElementById('toggleAllDataBtn').addEventListener('click', () => {
  const section = document.getElementById('individualDataSection');
  section.style.display = section.style.display === 'none' ? 'block' : 'none';
});

/* ====== æ–°å¢åŠŸèƒ½å‡½æ•° ====== */

// å¤šç»´åº¦æ•°æ®å¯¹æ¯”å±•ç¤ºåŠŸèƒ½
function generateComparison() {
  const comparisonType = document.getElementById('comparisonType').value;
  const dimensionType = document.getElementById('comparisonDimension').value;
  
  const canvas = document.getElementById('comparisonCanvas');
  const ctx = canvas.getContext('2d');
  
  // æ¸…é™¤ä¹‹å‰çš„å›¾è¡¨
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  let data, labels;
  if (dimensionType === 'team14') {
    data = currentBarData.mean14 || [];
    labels = TEAM14;
  } else {
    data = currentBarData.meanPot8 || [];
    labels = TEAM_POT8_AXES;
  }
  
  if (comparisonType === 'team_vs_individual') {
    drawTeamVsIndividualChart(ctx, data, labels);
  } else if (comparisonType === 'dimensions_ranking') {
    drawDimensionsRankingChart(ctx, data, labels);
  } else if (comparisonType === 'strength_weakness') {
    drawStrengthWeaknessChart(ctx, data, labels);
  }
}

function drawTeamVsIndividualChart(ctx, teamData, labels) {
  const canvas = ctx.canvas;
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  const padding = 60;
  const chartWidth = canvas.width - 2 * padding;
  const chartHeight = canvas.height - 2 * padding;
  const barWidth = chartWidth / labels.length * 0.8;
  
  // ç»˜åˆ¶åæ ‡è½´
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, canvas.height - padding);
  ctx.lineTo(canvas.width - padding, canvas.height - padding);
  ctx.stroke();
  
  // ç»˜åˆ¶æ•°æ®æ¡
  teamData.forEach((value, i) => {
    const x = padding + (i + 0.1) * (chartWidth / labels.length);
    const barHeight = (value / 100) * chartHeight;
    const y = canvas.height - padding - barHeight;
    
    ctx.fillStyle = 'rgba(54, 162, 235, 0.6)';
    ctx.fillRect(x, y, barWidth, barHeight);
    
    // ç»˜åˆ¶æ•°å€¼æ ‡ç­¾
    ctx.fillStyle = '#333';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(Math.round(value), x + barWidth/2, y - 5);
    
    // ç»˜åˆ¶ç»´åº¦æ ‡ç­¾
    ctx.save();
    ctx.translate(x + barWidth/2, canvas.height - padding + 15);
    ctx.rotate(-Math.PI/4);
    ctx.textAlign = 'right';
    ctx.fillText(labels[i], 0, 0);
    ctx.restore();
  });
}

function drawDimensionsRankingChart(ctx, data, labels) {
  const canvas = ctx.canvas;
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  // åˆ›å»ºæ’åºæ•°æ®
  const sortedData = data.map((value, index) => ({
    value: value,
    label: labels[index],
    index: index
  })).sort((a, b) => b.value - a.value);
  
  const padding = 60;
  const chartWidth = canvas.width - 2 * padding;
  const chartHeight = canvas.height - 2 * padding;
  const barHeight = chartHeight / sortedData.length * 0.8;
  
  // ç»˜åˆ¶åæ ‡è½´
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, canvas.height - padding);
  ctx.lineTo(canvas.width - padding, canvas.height - padding);
  ctx.stroke();
  
  // ç»˜åˆ¶æ’åºæ¡å½¢å›¾
  sortedData.forEach((item, i) => {
    const y = padding + (i + 0.1) * (chartHeight / sortedData.length);
    const barWidth = (item.value / 100) * chartWidth;
    
    // æ ¹æ®æ’åè®¾ç½®é¢œè‰²
    let color;
    if (i < sortedData.length / 3) {
      color = 'rgba(75, 192, 192, 0.6)'; // ç»¿è‰² - ä¼˜åŠ¿
    } else if (i < sortedData.length * 2 / 3) {
      color = 'rgba(255, 206, 86, 0.6)'; // é»„è‰² - ä¸­ç­‰
    } else {
      color = 'rgba(255, 99, 132, 0.6)'; // çº¢è‰² - éœ€æ”¹è¿›
    }
    
    ctx.fillStyle = color;
    ctx.fillRect(padding, y, barWidth, barHeight);
    
    // ç»˜åˆ¶æ•°å€¼æ ‡ç­¾
    ctx.fillStyle = '#333';
    ctx.font = '12px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`${item.label}: ${Math.round(item.value)}`, padding + barWidth + 5, y + barHeight/2 + 4);
  });
}

function drawStrengthWeaknessChart(ctx, data, labels) {
  const canvas = ctx.canvas;
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  const avgValue = data.reduce((sum, val) => sum + val, 0) / data.length;
  const strengths = [];
  const weaknesses = [];
  
  data.forEach((value, index) => {
    if (value > avgValue + 5) {
      strengths.push({ label: labels[index], value: value });
    } else if (value < avgValue - 5) {
      weaknesses.push({ label: labels[index], value: value });
    }
  });
  
  // æ¸…é™¤ç”»å¸ƒ
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // ç»˜åˆ¶æ ‡é¢˜
  ctx.fillStyle = '#333';
  ctx.font = 'bold 16px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('ä¼˜åŠ¿åŠ£åŠ¿åˆ†æ', canvas.width / 2, 30);
  
  // ç»˜åˆ¶ä¼˜åŠ¿åŒºåŸŸ
  ctx.fillStyle = 'rgba(75, 192, 192, 0.8)';
  ctx.font = '14px Arial';
  ctx.textAlign = 'left';
  ctx.fillText('ä¼˜åŠ¿ç»´åº¦:', 50, 70);
  
  strengths.forEach((item, i) => {
    ctx.fillStyle = 'rgba(75, 192, 192, 0.6)';
    ctx.fillRect(50, 90 + i * 30, (item.value / 100) * 200, 20);
    ctx.fillStyle = '#333';
    ctx.fillText(`${item.label}: ${Math.round(item.value)}`, 260, 105 + i * 30);
  });
  
  // ç»˜åˆ¶åŠ£åŠ¿åŒºåŸŸ
  const weaknessStartY = 120 + strengths.length * 30;
  ctx.fillStyle = 'rgba(255, 99, 132, 0.8)';
  ctx.fillText('éœ€æ”¹è¿›ç»´åº¦:', 50, weaknessStartY);
  
  weaknesses.forEach((item, i) => {
    ctx.fillStyle = 'rgba(255, 99, 132, 0.6)';
    ctx.fillRect(50, weaknessStartY + 20 + i * 30, (item.value / 100) * 200, 20);
    ctx.fillStyle = '#333';
    ctx.fillText(`${item.label}: ${Math.round(item.value)}`, 260, weaknessStartY + 35 + i * 30);
  });
}

function exportComparison() {
  const comparisonType = document.getElementById('comparisonType').value;
  const dimensionType = document.getElementById('comparisonDimension').value;
  
  let data, labels;
  if (dimensionType === 'team14') {
    data = currentBarData.mean14 || [];
    labels = TEAM14;
  } else {
    data = currentBarData.meanPot8 || [];
    labels = TEAM_POT8_AXES;
  }
  
  const exportData = {
    comparisonType: comparisonType,
    dimensionType: dimensionType,
    data: labels.map((label, index) => ({
      dimension: label,
      value: Math.round(data[index] || 0)
    })),
    timestamp: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `comparison_data_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// è¯¦ç»†æ–‡å­—åˆ†æå†…å®¹åŠŸèƒ½
function generateTeamAnalysis() {
  const analysisDiv = document.getElementById('analysisContent');
  
  const team14Data = currentBarData.mean14 || [];
  const teamPot8Data = currentBarData.meanPot8 || [];
  
  const avgTeam14 = team14Data.reduce((sum, val) => sum + val, 0) / team14Data.length;
  const avgTeamPot8 = teamPot8Data.reduce((sum, val) => sum + val, 0) / teamPot8Data.length;
  
  const analysis = `
    <div style="color: var(--ink);">
      <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--line);">
        <div style="font-size: 24px; margin-right: 12px;">ğŸ“Š</div>
        <h3 style="margin: 0; color: var(--ink);">å›¢é˜Ÿæ•´ä½“åˆ†ææŠ¥å‘Š</h3>
      </div>
      
      <div style="background: rgba(42, 59, 122, 0.2); border-left: 4px solid var(--good); padding: 12px; margin-bottom: 16px; border-radius: 8px;">
        <div style="color: var(--muted); font-size: 12px; margin-bottom: 8px;">ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</div>
      </div>
      
      <div style="margin-bottom: 24px;">
        <h4 style="color: var(--ink); margin-bottom: 12px; display: flex; align-items: center;">
          <span style="margin-right: 8px;">ğŸ¯</span>å›¢é˜Ÿæ¦‚å†µ
        </h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 12px; padding: 16px; text-align: center;">
            <div style="font-size: 28px; font-weight: bold; color: var(--good); margin-bottom: 4px;">${Math.round(avgTeam14)}</div>
            <div style="color: var(--muted); font-size: 13px;">å›¢é˜Ÿ14ç»´å¹³å‡åˆ†</div>
          </div>
          <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 16px; text-align: center;">
            <div style="font-size: 28px; font-weight: bold; color: #3b82f6; margin-bottom: 4px;">${Math.round(avgTeamPot8)}</div>
            <div style="color: var(--muted); font-size: 13px;">å›¢é˜Ÿæ½œåŠ›8ç»´å¹³å‡åˆ†</div>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 24px;">
        <h4 style="color: var(--ink); margin-bottom: 12px; display: flex; align-items: center;">
          <span style="margin-right: 8px;">ğŸ“ˆ</span>ç»´åº¦è¯¦ç»†åˆ†æ
        </h4>
        
        <div style="background: rgba(16, 23, 58, 0.6); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
          <h5 style="color: var(--good); margin-bottom: 12px;">å›¢é˜Ÿ14ç»´è¡¨ç°</h5>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
            ${TEAM14.map((dim, i) => {
              const score = Math.round(team14Data[i] || 0);
              const color = score >= 70 ? 'var(--good)' : score >= 50 ? 'var(--warn)' : 'var(--bad)';
              return `<div style="display: flex; justify-content: space-between; padding: 6px 12px; background: rgba(28, 36, 71, 0.5); border-radius: 8px; border-left: 3px solid ${color};">
                <span style="color: var(--ink); font-size: 13px;">${dim}</span>
                <span style="color: ${color}; font-weight: bold;">${score}åˆ†</span>
              </div>`;
            }).join('')}
          </div>
        </div>
        
        <div style="background: rgba(16, 23, 58, 0.6); border-radius: 12px; padding: 16px;">
          <h5 style="color: #3b82f6; margin-bottom: 12px;">å›¢é˜Ÿæ½œåŠ›8ç»´è¡¨ç°</h5>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
            ${TEAM_POT8_AXES.map((dim, i) => {
              const score = Math.round(teamPot8Data[i] || 0);
              const color = score >= 70 ? 'var(--good)' : score >= 50 ? 'var(--warn)' : 'var(--bad)';
              return `<div style="display: flex; justify-content: space-between; padding: 6px 12px; background: rgba(28, 36, 71, 0.5); border-radius: 8px; border-left: 3px solid ${color};">
                <span style="color: var(--ink); font-size: 13px;">${dim}</span>
                <span style="color: ${color}; font-weight: bold;">${score}åˆ†</span>
              </div>`;
            }).join('')}
          </div>
        </div>
      </div>
      
      <div style="background: rgba(42, 59, 122, 0.2); border-radius: 12px; padding: 16px;">
        <h4 style="color: var(--ink); margin-bottom: 12px; display: flex; align-items: center;">
          <span style="margin-right: 8px;">ğŸ’¡</span>æ€»ç»“å»ºè®®
        </h4>
        <p style="color: var(--muted); line-height: 1.6; margin: 0;">
          åŸºäºå½“å‰æ•°æ®åˆ†æï¼Œå›¢é˜Ÿåœ¨å„ç»´åº¦è¡¨ç°${avgTeam14 >= 70 ? 'ä¼˜ç§€' : avgTeam14 >= 50 ? 'è‰¯å¥½' : 'éœ€è¦æ”¹è¿›'}ã€‚
          å»ºè®®é‡ç‚¹å…³æ³¨å¾—åˆ†è¾ƒä½çš„ç»´åº¦ï¼Œåˆ¶å®šé’ˆå¯¹æ€§çš„æå‡è®¡åˆ’ï¼ŒåŒæ—¶ä¿æŒå’Œå‘æ‰¬ä¼˜åŠ¿ç»´åº¦çš„è¡¨ç°ã€‚
        </p>
      </div>
    </div>
  `;
  
  analysisDiv.innerHTML = analysis;
}

function generateStrengthAnalysis() {
  const analysisDiv = document.getElementById('analysisContent');
  
  const team14Data = currentBarData.mean14 || [];
  const teamPot8Data = currentBarData.meanPot8 || [];
  
  // æ‰¾å‡ºä¼˜åŠ¿ç»´åº¦ï¼ˆé«˜äºå¹³å‡å€¼+æ ‡å‡†å·®ï¼‰
  const avgTeam14 = team14Data.reduce((sum, val) => sum + val, 0) / team14Data.length;
  const strengths14 = TEAM14.filter((dim, i) => team14Data[i] > avgTeam14 + 5);
  
  const avgTeamPot8 = teamPot8Data.reduce((sum, val) => sum + val, 0) / teamPot8Data.length;
  const strengthsPot8 = TEAM_POT8_AXES.filter((dim, i) => teamPot8Data[i] > avgTeamPot8 + 5);
  
  const analysis = `
    <div style="color: var(--ink);">
      <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--line);">
        <div style="font-size: 24px; margin-right: 12px;">ğŸ’ª</div>
        <h3 style="margin: 0; color: var(--ink);">å›¢é˜Ÿä¼˜åŠ¿åˆ†æ</h3>
      </div>
      
      <div style="background: rgba(42, 59, 122, 0.2); border-left: 4px solid var(--good); padding: 12px; margin-bottom: 16px; border-radius: 8px;">
        <div style="color: var(--muted); font-size: 12px;">ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</div>
      </div>
      
      <div style="margin-bottom: 24px;">
        <h4 style="color: var(--ink); margin-bottom: 16px; display: flex; align-items: center;">
          <span style="margin-right: 8px;">ğŸŒŸ</span>æ ¸å¿ƒä¼˜åŠ¿ç»´åº¦
        </h4>
        
        <div style="background: rgba(74, 222, 128, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(74, 222, 128, 0.3);">
          <h5 style="color: var(--good); margin-bottom: 12px; display: flex; align-items: center;">
            <span style="margin-right: 8px;">ğŸ“Š</span>å›¢é˜Ÿ14ç»´ä¼˜åŠ¿
          </h5>
          ${strengths14.length > 0 ? 
            `<div style="display: grid; gap: 8px;">
              ${strengths14.map(dim => {
                const index = TEAM14.indexOf(dim);
                const score = Math.round(team14Data[index]);
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(74, 222, 128, 0.15); border-radius: 8px; border-left: 4px solid var(--good);">
                  <div>
                    <div style="color: var(--ink); font-weight: bold; margin-bottom: 4px;">${dim}</div>
                    <div style="color: var(--good); font-size: 12px;">è¡¨ç°çªå‡º - ç»§ç»­å‘æŒ¥</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: var(--good); font-size: 24px; font-weight: bold;">${score}</div>
                    <div style="color: var(--muted); font-size: 12px;">åˆ†</div>
                  </div>
                </div>`;
              }).join('')}
            </div>` : 
            '<div style="text-align: center; padding: 20px; color: var(--muted);">æš‚æ— æ˜æ˜¾ä¼˜åŠ¿ç»´åº¦ï¼Œå»ºè®®é‡ç‚¹åŸ¹å…»æ ¸å¿ƒèƒ½åŠ›</div>'
          }
        </div>
        
        <div style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; padding: 16px; border: 1px solid rgba(59, 130, 246, 0.3);">
          <h5 style="color: #3b82f6; margin-bottom: 12px; display: flex; align-items: center;">
            <span style="margin-right: 8px;">ğŸš€</span>å›¢é˜Ÿæ½œåŠ›8ç»´ä¼˜åŠ¿
          </h5>
          ${strengthsPot8.length > 0 ? 
            `<div style="display: grid; gap: 8px;">
              ${strengthsPot8.map(dim => {
                const index = TEAM_POT8_AXES.indexOf(dim);
                const score = Math.round(teamPot8Data[index]);
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border-left: 4px solid #3b82f6;">
                  <div>
                    <div style="color: var(--ink); font-weight: bold; margin-bottom: 4px;">${dim}</div>
                    <div style="color: #3b82f6; font-size: 12px;">æ½œåŠ›çªå‡º - å€¼å¾—æ·±æŒ–</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #3b82f6; font-size: 24px; font-weight: bold;">${score}</div>
                    <div style="color: var(--muted); font-size: 12px;">åˆ†</div>
                  </div>
                </div>`;
              }).join('')}
            </div>` : 
            '<div style="text-align: center; padding: 20px; color: var(--muted);">æš‚æ— æ˜æ˜¾ä¼˜åŠ¿ç»´åº¦ï¼Œå»ºè®®é‡ç‚¹åŸ¹å…»æ½œåŠ›èƒ½åŠ›</div>'
          }
        </div>
      </div>
      
      <div style="background: rgba(42, 59, 122, 0.2); border-radius: 12px; padding: 16px;">
        <h4 style="color: var(--ink); margin-bottom: 12px; display: flex; align-items: center;">
          <span style="margin-right: 8px;">ğŸ’¡</span>ä¼˜åŠ¿å‘æŒ¥å»ºè®®
        </h4>
        <div style="color: var(--muted); line-height: 1.6;">
          <div style="margin-bottom: 12px;">â€¢ ç»§ç»­å‘æŒ¥ç°æœ‰ä¼˜åŠ¿ç»´åº¦ï¼Œå°†å…¶ä½œä¸ºå›¢é˜Ÿæ ¸å¿ƒç«äº‰åŠ›</div>
          <div style="margin-bottom: 12px;">â€¢ å°†ä¼˜åŠ¿èƒ½åŠ›åº”ç”¨åˆ°æ›´å¤šå·¥ä½œåœºæ™¯ä¸­ï¼Œæ‰©å¤§å½±å“èŒƒå›´</div>
          <div style="margin-bottom: 12px;">â€¢ å»ºç«‹ä¼˜åŠ¿ç»´åº¦çš„æœ€ä½³å®è·µï¼Œå½¢æˆå¯å¤åˆ¶çš„ç»éªŒ</div>
          <div>â€¢ é€šè¿‡ä¼˜åŠ¿å¸¦åŠ¨å…¶ä»–ç»´åº¦çš„æå‡ï¼Œå®ç°æ•´ä½“èƒ½åŠ›è·ƒå‡</div>
        </div>
      </div>
    </div>
  `;
  
  analysisDiv.innerHTML = analysis;
}

function generateImprovementAnalysis() {
  const analysisDiv = document.getElementById('analysisContent');
  
  const team14Data = currentBarData.mean14 || [];
  const teamPot8Data = currentBarData.meanPot8 || [];
  
  // æ‰¾å‡ºéœ€æ”¹è¿›ç»´åº¦ï¼ˆä½äºå¹³å‡å€¼-æ ‡å‡†å·®ï¼‰
  const avgTeam14 = team14Data.reduce((sum, val) => sum + val, 0) / team14Data.length;
  const weaknesses14 = TEAM14.filter((dim, i) => team14Data[i] < avgTeam14 - 5);
  
  const avgTeamPot8 = teamPot8Data.reduce((sum, val) => sum + val, 0) / teamPot8Data.length;
  const weaknessesPot8 = TEAM_POT8_AXES.filter((dim, i) => teamPot8Data[i] < avgTeamPot8 - 5);
  
  const analysis = `
    <div style="color: var(--ink);">
      <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--line);">
        <div style="font-size: 24px; margin-right: 12px;">ğŸ¯</div>
        <h3 style="margin: 0; color: var(--ink);">å›¢é˜Ÿæ”¹è¿›å»ºè®®</h3>
      </div>
      
      <div style="background: rgba(42, 59, 122, 0.2); border-left: 4px solid var(--warn); padding: 12px; margin-bottom: 16px; border-radius: 8px;">
        <div style="color: var(--muted); font-size: 12px;">ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</div>
      </div>
      
      <div style="margin-bottom: 24px;">
        <h4 style="color: var(--ink); margin-bottom: 16px; display: flex; align-items: center;">
          <span style="margin-right: 8px;">âš ï¸</span>éœ€è¦æ”¹è¿›çš„ç»´åº¦
        </h4>
        
        <div style="background: rgba(245, 159, 11, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(245, 159, 11, 0.3);">
          <h5 style="color: var(--warn); margin-bottom: 12px; display: flex; align-items: center;">
            <span style="margin-right: 8px;">ğŸ“Š</span>å›¢é˜Ÿ14ç»´éœ€æ”¹è¿›
          </h5>
          ${weaknesses14.length > 0 ? 
            `<div style="display: grid; gap: 8px;">
              ${weaknesses14.map(dim => {
                const index = TEAM14.indexOf(dim);
                const score = Math.round(team14Data[index]);
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(245, 159, 11, 0.15); border-radius: 8px; border-left: 4px solid var(--warn);">
                  <div>
                    <div style="color: var(--ink); font-weight: bold; margin-bottom: 4px;">${dim}</div>
                    <div style="color: var(--warn); font-size: 12px;">éœ€è¦é‡ç‚¹å…³æ³¨</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: var(--warn); font-size: 24px; font-weight: bold;">${score}</div>
                    <div style="color: var(--muted); font-size: 12px;">åˆ†</div>
                  </div>
                </div>`;
              }).join('')}
            </div>` : 
            '<div style="text-align: center; padding: 20px; color: var(--muted);">å„ç»´åº¦è¡¨ç°å‡è¡¡ï¼Œç»§ç»­ä¿æŒ</div>'
          }
        </div>
        
        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 12px; padding: 16px; border: 1px solid rgba(239, 68, 68, 0.3);">
          <h5 style="color: var(--bad); margin-bottom: 12px; display: flex; align-items: center;">
            <span style="margin-right: 8px;">ğŸš€</span>å›¢é˜Ÿæ½œåŠ›8ç»´éœ€æ”¹è¿›
          </h5>
          ${weaknessesPot8.length > 0 ? 
            `<div style="display: grid; gap: 8px;">
              ${weaknessesPot8.map(dim => {
                const index = TEAM_POT8_AXES.indexOf(dim);
                const score = Math.round(teamPot8Data[index]);
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(239, 68, 68, 0.15); border-radius: 8px; border-left: 4px solid var(--bad);">
                  <div>
                    <div style="color: var(--ink); font-weight: bold; margin-bottom: 4px;">${dim}</div>
                    <div style="color: var(--bad); font-size: 12px;">æ½œåŠ›æœ‰å¾…å¼€å‘</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: var(--bad); font-size: 24px; font-weight: bold;">${score}</div>
                    <div style="color: var(--muted); font-size: 12px;">åˆ†</div>
                  </div>
                </div>`;
              }).join('')}
            </div>` : 
            '<div style="text-align: center; padding: 20px; color: var(--muted);">å„ç»´åº¦æ½œåŠ›è¡¨ç°å‡è¡¡ï¼Œç»§ç»­ä¿æŒ</div>'
          }
        </div>
      </div>
      
      <div style="background: rgba(42, 59, 122, 0.2); border-radius: 12px; padding: 16px;">
        <h4 style="color: var(--ink); margin-bottom: 12px; display: flex; align-items: center;">
          <span style="margin-right: 8px;">ğŸ’¡</span>å…·ä½“æ”¹è¿›å»ºè®®
        </h4>
        <div style="color: var(--muted); line-height: 1.6;">
          <div style="margin-bottom: 12px;">â€¢ é’ˆå¯¹è–„å¼±ç»´åº¦åˆ¶å®šä¸“é¡¹æå‡è®¡åˆ’ï¼Œè®¾å®šæ˜ç¡®çš„æ”¹è¿›ç›®æ ‡</div>
          <div style="margin-bottom: 12px;">â€¢ é€šè¿‡åŸ¹è®­ã€å®è·µå’Œåé¦ˆæå‡ç›¸å…³èƒ½åŠ›ï¼Œå»ºç«‹å­¦ä¹ é—­ç¯</div>
          <div style="margin-bottom: 12px;">â€¢ å»ºç«‹å®šæœŸè¯„ä¼°å’Œåé¦ˆæœºåˆ¶ï¼Œè·Ÿè¸ªæ”¹è¿›è¿›åº¦</div>
          <div>â€¢ é¼“åŠ±å›¢é˜Ÿæˆå‘˜äº’ç›¸å­¦ä¹ å’Œæ”¯æŒï¼Œå½¢æˆåä½œæ”¹è¿›æ°›å›´</div>
        </div>
      </div>
    </div>
  `;
  
  analysisDiv.innerHTML = analysis;
}

function exportAnalysis() {
  const content = document.getElementById('analysisContent').innerHTML;
  const blob = new Blob([content], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `team_analysis_${new Date().toISOString().split('T')[0]}.html`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function clearAnalysis() {
  document.getElementById('analysisContent').innerHTML = '<p class="text-muted">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆç›¸åº”çš„åˆ†æå†…å®¹...</p>';
}

// AIåˆ†ææŠ¥å‘Šæ•°æ®æ”¯æŒåŠŸèƒ½
function generateAIData() {
  const format = document.getElementById('aiDataFormat').value;
  const scope = document.getElementById('aiDataScope').value;
  const previewDiv = document.getElementById('aiDataPreview');
  
  const team14Data = currentBarData.mean14 || [];
  const teamPot8Data = currentBarData.meanPot8 || [];
  
  let aiData;
  
  if (scope === 'complete') {
    aiData = {
      teamId: currentTeamId || 'mock_team',
      timestamp: new Date().toISOString(),
      team14Dimensions: TEAM14.map((dim, i) => ({
        dimension: dim,
        value: Math.round(team14Data[i] || 0),
        type: AXIS_TYPE_TEAM[dim] || 'unknown'
      })),
      teamPot8Dimensions: TEAM_POT8_AXES.map((dim, i) => ({
        dimension: dim,
        value: Math.round(teamPot8Data[i] || 0)
      })),
      statistics: {
        team14Average: Math.round(team14Data.reduce((sum, val) => sum + val, 0) / team14Data.length),
        teamPot8Average: Math.round(teamPot8Data.reduce((sum, val) => sum + val, 0) / teamPot8Data.length),
        team14Max: Math.max(...team14Data),
        team14Min: Math.min(...team14Data),
        teamPot8Max: Math.max(...teamPot8Data),
        teamPot8Min: Math.min(...teamPot8Data)
      }
    };
  } else if (scope === 'summary') {
    aiData = {
      teamId: currentTeamId || 'mock_team',
      summary: {
        team14Average: Math.round(team14Data.reduce((sum, val) => sum + val, 0) / team14Data.length),
        teamPot8Average: Math.round(teamPot8Data.reduce((sum, val) => sum + val, 0) / teamPot8Data.length),
        topStrengths: TEAM14.filter((dim, i) => team14Data[i] > 75).slice(0, 3),
        improvementAreas: TEAM14.filter((dim, i) => team14Data[i] < 65).slice(0, 3)
      }
    };
  } else {
    aiData = {
      keyMetrics: {
        overallScore: Math.round((team14Data.reduce((sum, val) => sum + val, 0) + teamPot8Data.reduce((sum, val) => sum + val, 0)) / (team14Data.length + teamPot8Data.length)),
        strengthCount: team14Data.filter(val => val > 75).length,
        improvementCount: team14Data.filter(val => val < 65).length
      }
    };
  }
  
  let formattedData;
  if (format === 'json') {
    formattedData = JSON.stringify(aiData, null, 2);
  } else if (format === 'csv') {
    if (scope === 'complete') {
      formattedData = 'Dimension,Value,Type\n' + 
        aiData.team14Dimensions.map(item => `${item.dimension},${item.value},${item.type}`).join('\n') + '\n' +
        aiData.teamPot8Dimensions.map(item => `${item.dimension},${item.value},potential`).join('\n');
    } else {
      formattedData = Object.entries(aiData).map(([key, value]) => `${key},${JSON.stringify(value)}`).join('\n');
    }
  } else {
    formattedData = `å›¢é˜Ÿåˆ†ææ•°æ®ç»“æ„åŒ–æ–‡æœ¬\n\n`;
    if (scope === 'complete') {
      formattedData += `å›¢é˜Ÿ14ç»´æ•°æ®:\n${aiData.team14Dimensions.map(item => `- ${item.dimension}: ${item.value}åˆ† (${item.type}ç±»)`).join('\n')}\n\n`;
      formattedData += `å›¢é˜Ÿæ½œåŠ›8ç»´æ•°æ®:\n${aiData.teamPot8Dimensions.map(item => `- ${item.dimension}: ${item.value}åˆ†`).join('\n')}\n\n`;
      formattedData += `ç»Ÿè®¡ä¿¡æ¯:\n- 14ç»´å¹³å‡åˆ†: ${aiData.statistics.team14Average}\n- æ½œåŠ›8ç»´å¹³å‡åˆ†: ${aiData.statistics.teamPot8Average}`;
    } else {
      formattedData += JSON.stringify(aiData, null, 2);
    }
  }
  
  previewDiv.innerHTML = `<pre>${formattedData}</pre>`;
}

function copyAIData() {
  const previewDiv = document.getElementById('aiDataPreview');
  const text = previewDiv.textContent || previewDiv.innerText;
  
  navigator.clipboard.writeText(text).then(() => {
    alert('æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  }).catch(err => {
    console.error('å¤åˆ¶å¤±è´¥:', err);
    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
  });
}

function downloadAIData() {
  const format = document.getElementById('aiDataFormat').value;
  const previewDiv = document.getElementById('aiDataPreview');
  const text = previewDiv.textContent || previewDiv.innerText;
  
  const mimeTypes = {
    'json': 'application/json',
    'csv': 'text/csv',
    'structured': 'text/plain'
  };
  
  const extensions = {
    'json': 'json',
    'csv': 'csv',
    'structured': 'txt'
  };
  
  const blob = new Blob([text], { type: mimeTypes[format] });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ai_data_${new Date().toISOString().split('T')[0]}.${extensions[format]}`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ====== å¯åŠ¨ ====== */
function initIndustryOptionsOnce(){
  const keys=Object.keys(INDUSTRY_TEAM_BASE);
  industrySelect.innerHTML=keys.map(k=>`<option value="${k}">${k}</option>`).join('');
  transIndustrySelect.innerHTML=keys.map(k=>`<option value="${k}">${k}</option>`).join('');
  industrySelect.value=DATA.industry || 'SaaS/DevTools';
  if(!transIndustrySelect.value) transIndustrySelect.value='å“ç‰Œ/è®¾è®¡/å†…å®¹';
}
initIndustryOptionsOnce();
renderAll();
</script>
</body>
</html>
